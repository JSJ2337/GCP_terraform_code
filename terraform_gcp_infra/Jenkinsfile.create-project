pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    parameters {
        string(
            name: 'PROJECT_ID',
            description: 'GCP í”„ë¡œì íŠ¸ ID (ì˜ˆ: jsj-game-n)',
            defaultValue: ''
        )
        string(
            name: 'PROJECT_NAME',
            description: 'í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ ë„¤ì´ë°ìš©, ì˜ˆ: game-n)',
            defaultValue: ''
        )
        string(
            name: 'ORGANIZATION',
            description: 'ì¡°ì§ëª… (ë¦¬ì†ŒìŠ¤ ì ‘ë‘ì–´, ì˜ˆ: jsj)',
            defaultValue: 'jsj'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: [
                'LIVE',
                'QA',
                'STG'
            ],
            description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        )
        choice(
            name: 'REGION_PRIMARY',
            choices: [
                'asia-northeast3',  // ì„œìš¸
                'asia-northeast1',  // ë„ì¿„
                'us-central1',
                'us-west1',
                'europe-west1'
            ],
            description: 'ì£¼ ë¦¬ì „ ì„ íƒ'
        )
        choice(
            name: 'REGION_BACKUP',
            choices: [
                'asia-northeast1',  // ë„ì¿„
                'asia-northeast3',  // ì„œìš¸
                'us-central1',
                'us-west1',
                'europe-west1'
            ],
            description: 'ë°±ì—… ë¦¬ì „ ì„ íƒ'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo 'ğŸ” íŒŒë¼ë¯¸í„° ê²€ì¦ ì¤‘...'

                    // í•„ìˆ˜ íŒŒë¼ë¯¸í„° í™•ì¸
                    if (!params.PROJECT_ID?.trim()) {
                        error('PROJECT_IDëŠ” í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.')
                    }
                    if (!params.PROJECT_NAME?.trim()) {
                        error('PROJECT_NAMEì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.')
                    }
                    if (!params.ORGANIZATION?.trim()) {
                        error('ORGANIZATIONì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.')
                    }

                    // PROJECT_ID í˜•ì‹ ê²€ì¦ (GCP ê·œì¹™: ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆë§Œ ê°€ëŠ¥, 6-30ì)
                    if (!params.PROJECT_ID.matches('^[a-z][a-z0-9-]{5,29}$')) {
                        error('PROJECT_IDëŠ” ì†Œë¬¸ìë¡œ ì‹œì‘í•˜ë©° ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤ (6-30ì).')
                    }

                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  ì‹ ê·œ í”„ë¡œì íŠ¸ ìƒì„± íŒŒë¼ë¯¸í„°"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  PROJECT_ID     : ${params.PROJECT_ID}"
                    echo "  PROJECT_NAME   : ${params.PROJECT_NAME}"
                    echo "  ORGANIZATION   : ${params.ORGANIZATION}"
                    echo "  ENVIRONMENT    : ${params.ENVIRONMENT}"
                    echo "  REGION_PRIMARY : ${params.REGION_PRIMARY}"
                    echo "  REGION_BACKUP  : ${params.REGION_BACKUP}"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                }
            }
        }

        stage('Check Duplicate') {
            steps {
                script {
                    echo 'ğŸ” í”„ë¡œì íŠ¸ ì¤‘ë³µ í™•ì¸ ì¤‘...'

                    def targetDir = "terraform_gcp_infra/environments/${params.ENVIRONMENT}/${params.PROJECT_ID}"

                    if (fileExists(targetDir)) {
                        error("í”„ë¡œì íŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${targetDir}")
                    }

                    echo "âœ… ì¤‘ë³µ í™•ì¸ ì™„ë£Œ (ì‹ ê·œ í”„ë¡œì íŠ¸)"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    echo 'ğŸ”§ í•„ìš”í•œ ë„êµ¬ í™•ì¸ ì¤‘...'

                    sh '''
                        set +e  # ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰

                        echo "=== Git ==="
                        git --version

                        echo "=== yq (YAML processor) ==="
                        if command -v yq &> /dev/null; then
                            yq --version
                        else
                            echo "âš ï¸  yqê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
                        fi

                        echo "=== gh (GitHub CLI) ==="
                        if command -v gh &> /dev/null; then
                            gh --version
                        else
                            echo "âš ï¸  gh CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. PRì€ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”."
                        fi

                        set -e  # ë‹¤ì‹œ ì—ëŸ¬ ì²´í¬ í™œì„±í™”
                    '''
                }
            }
        }

        stage('Create Project') {
            steps {
                script {
                    echo 'ğŸš€ í”„ë¡œì íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘...'

                    // Git ì„¤ì • (ì»¤ë°‹ ì‘ì„±ì ì •ë³´)
                    sh '''
                        git config user.name "Jenkins"
                        git config user.email "jenkins@jsj-dev.com"
                    '''

                    // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                    sh """
                        cd terraform_gcp_infra

                        bash scripts/create_project.sh \\
                            "${params.PROJECT_ID}" \\
                            "${params.PROJECT_NAME}" \\
                            "${params.ORGANIZATION}" \\
                            "${params.ENVIRONMENT}" \\
                            "${params.REGION_PRIMARY}" \\
                            "${params.REGION_BACKUP}"
                    """
                }
            }
        }

        stage('Push to Remote') {
            steps {
                script {
                    echo 'ğŸ“¤ Git ë¸Œëœì¹˜ í‘¸ì‹œ ì¤‘...'

                    // í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
                    def currentBranch = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
                    echo "í˜„ì¬ ë¸Œëœì¹˜: ${currentBranch}"

                    withCredentials([string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')]) {
                        sh """
                            # GitHub Personal Access Tokenì„ ì‚¬ìš©í•˜ì—¬ í‘¸ì‹œ
                            git remote set-url origin https://\${GITHUB_TOKEN}@github.com/JSJ2337/JSJ_engineering_Diary.git
                            git push origin ${currentBranch}
                        """
                    }

                    echo "âœ… ë¸Œëœì¹˜ í‘¸ì‹œ ì™„ë£Œ: ${currentBranch}"
                }
            }
        }

    }

    post {
        success {
            script {
                echo 'âœ… í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ!'
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "  í”„ë¡œì íŠ¸ ID: ${params.PROJECT_ID}"
                echo "  ìœ„ì¹˜: terraform_gcp_infra/environments/${params.ENVIRONMENT}/${params.PROJECT_ID}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "ë‹¤ìŒ ë‹¨ê³„:"
                echo "  1. Jenkinsì—ì„œ terraform-deploy-${params.PROJECT_ID} Job ìƒì„±"
                echo "  2. ì´ˆê¸° ë°°í¬ ì‹¤í–‰ (00-projectë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ)"
            }
        }
        failure {
            script {
                echo 'âŒ í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨!'
                echo "í”„ë¡œì íŠ¸ ID: ${params.PROJECT_ID}"
                echo "ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            }
        }
        always {
            echo 'ğŸ Pipeline finished'
        }
    }
}
