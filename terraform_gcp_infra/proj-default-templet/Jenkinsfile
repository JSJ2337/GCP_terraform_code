// ============================================================================
// Terragrunt CI/CD Pipeline
// ============================================================================
// ì‚¬ìš© ë°©ë²•:
// 1. create_project.shë¡œ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ TG_WORKING_DIRì´ ì„¤ì •ë¨
// 2. Jenkins Job ìƒì„±: Script Path = environments/{ENV}/{PROJECT_ID}/Jenkinsfile
// ============================================================================

// ============================================================================
// Phase ì •ì˜: ë ˆì´ì–´ë³„ ì˜ì¡´ì„±ì„ ê³ ë ¤í•œ ìˆœì°¨ ì‹¤í–‰ êµ¬ì¡°
// ============================================================================
def PHASES = [
    [id: 'phase1', label: 'Phase 1 - Bootstrap (00-project)', dirs: ['00-project'], optional: false],
    [id: 'phase2', label: 'Phase 2 - Network (10-network)', dirs: ['10-network'], optional: false],
    [id: 'phase3', label: 'Phase 3 - DNS (12-dns)', dirs: ['12-dns'], optional: false],
    [id: 'phase4', label: 'Phase 4 - Storage & Security', dirs: ['20-storage', '30-security'], optional: false],
    [id: 'phase5', label: 'Phase 5 - Observability', dirs: ['40-observability'], optional: true],
    [id: 'phase6', label: 'Phase 6 - Workloads (50-workloads)', dirs: ['50-workloads'], optional: false],
    [id: 'phase7', label: 'Phase 7 - Database & Cache', dirs: ['60-database', '65-cache'], optional: false],
    [id: 'phase8', label: 'Phase 8 - Load Balancers', dirs: ['70-loadbalancers/gs'], optional: false]
]

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // âš ï¸ create_project.shì—ì„œ ìë™ ì¹˜í™˜ë¨
        TG_WORKING_DIR = 'terraform_gcp_infra/environments/YOUR_FOLDER_ENV/YOUR_PROJECT_ID'
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('YOUR_JENKINS_CREDENTIAL_ID')
        // IPv4 ê°•ì œ ì‚¬ìš© (IPv6 unreachable ë¬¸ì œ í•´ê²°)
        GODEBUG = 'netdns=cgo'
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '12-dns',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancers/gs'
            ],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ (all = ì „ì²´ ìŠ¤íƒ)'
        )
        booleanParam(
            name: 'ENABLE_OBSERVABILITY',
            defaultValue: true,
            description: '40-observability ë ˆì´ì–´ í¬í•¨ ì—¬ë¶€'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    echo 'ğŸ”§ Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            // Clean cache files
                            sh """
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name ".terraform.lock.hcl" -type f -delete || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan*" -type f -delete || true
                            """
                            sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init -upgrade"
                        } else {
                            // Single layer init
                            sh """
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terragrunt-cache' || true
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform.lock.hcl' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/tfplan' || true
                            """
                            sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' init -upgrade"
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Phase ê¸°ë°˜ ìˆœì°¨ ì‹¤í–‰ (TARGET_LAYER == 'all')
        // Step 1: ëª¨ë“  Phase Plan ì‹¤í–‰
        // ====================================================================
        stage('Plan All Phases') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase ì²˜ë¦¬
                        if (phase.optional && phase.id == 'phase5' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "â­ï¸  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        stage("${phase.label} - Plan") {
                            echo "ğŸ“‹ Planning ${phase.label}..."
                            runPhasePlan(phase, phaseDirs)
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Step 2: ì „ì²´ ìŠ¹ì¸ (í•œ ë²ˆë§Œ)
        // ====================================================================
        stage('ğŸ›‘ Approve All Phases ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES
                    def phaseList = orderedPhases.collect { phase ->
                        if (phase.optional && phase.id == 'phase5' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            return null
                        }
                        return "  - ${phase.label}: ${phase.dirs.join(', ')}"
                    }.findAll { it != null }.join('\n')

                    def approvalMessage = """
                    âš ï¸  ì „ì²´ ì¸í”„ë¼ ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ì‹¤í–‰ë  Phase ëª©ë¡:
${phaseList}

                    ëª¨ë“  Phaseì˜ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    ìŠ¹ì¸ ì‹œ ëª¨ë“  Phaseê°€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: "âœ… ì „ì²´ ìŠ¹ì¸ (${params.ACTION.capitalize()} ìˆœì°¨ ì‹¤í–‰)",
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        // ====================================================================
        // Step 3: ìŠ¹ì¸ í›„ ëª¨ë“  Phase Re-plan ë° Apply/Destroy ìˆœì°¨ ì‹¤í–‰
        // ====================================================================
        stage('Execute All Phases') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase ì²˜ë¦¬
                        if (phase.optional && phase.id == 'phase5' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "â­ï¸  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Phase ì‹¤í–‰: Re-plan â†’ Apply/Destroy
                        stage("${phase.label} - Replan & ${params.ACTION.capitalize()}") {
                            if (params.ACTION == 'apply') {
                                echo "ğŸ“‹ Re-planning ${phase.label} with latest state..."
                                runPhasePlan(phase, phaseDirs)
                                echo "ğŸš€ Applying ${phase.label}..."
                                runPhaseApply(phase, phaseDirs)
                            } else {
                                echo "ğŸ—‘ï¸  Destroying ${phase.label}..."
                                runPhaseDestroy(phase, phaseDirs)
                            }
                        }

                        // Phase 1 ì´í›„ API Propagation ëŒ€ê¸°
                        if (phase.id == 'phase1' && params.ACTION == 'apply') {
                            stage('Wait for API Propagation') {
                                echo 'â³ Waiting for GCP API propagation (120 seconds)...'
                                sleep(time: 120, unit: 'SECONDS')
                                echo 'âœ… API propagation wait completed'
                            }
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan - Single Layer') {
            when {
                expression { params.TARGET_LAYER != 'all' }
            }
            steps {
                script {
                    echo 'ğŸ“‹ Running Terragrunt Plan...'
                    sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' plan -out=tfplan"
                    archiveArtifacts artifacts: "**/${params.TARGET_LAYER}/**/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                    echo "âš ï¸  ${params.TARGET_LAYER} ë ˆì´ì–´ì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤!"
                }
            }
        }

        stage('ğŸ›‘ Approval - Single Layer ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  ì¸í”„ë¼ ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'ğŸš€ Applying Terragrunt changes...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'ğŸ—‘ï¸  Destroying Terragrunt resources...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' destroy -auto-approve"
                    }
                }
            }
        }

    }

    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo 'âŒ Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan*" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}

// Phase Plan ì‹¤í–‰
def runPhasePlan(phase, phaseDirs) {
    // ê³µë°±/íŠ¹ìˆ˜ë¬¸ìê°€ ìˆëŠ” WORKSPACE ê²½ë¡œ ë¬¸ì œ íšŒí”¼ë¥¼ ìœ„í•´ ë””ë ‰í† ë¦¬ ì´ë™ í›„ ìƒëŒ€ê²½ë¡œ ì‚¬ìš©
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"

    phase.dirs.each { dir ->
        sh """
            rm -rf '${workDir}/${dir}/.terragrunt-cache' || true
            rm -rf '${workDir}/${dir}/.terraform' || true
            rm -f '${workDir}/${dir}/tfplan-${phase.id}' || true
        """
    }

    // ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©: working-dirë¡œ ì´ë™ í›„ ìƒëŒ€ ê²½ë¡œë¡œ include
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')
    sh """
        cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- plan -out=tfplan-${phase.id}
    """

    archiveArtifacts artifacts: "**/tfplan-${phase.id}", allowEmptyArchive: true
}

// Phase Apply ì‹¤í–‰
def runPhaseApply(phase, phaseDirs) {
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')
    sh """
        cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- apply tfplan-${phase.id}
    """
}

// Phase Destroy ì‹¤í–‰
def runPhaseDestroy(phase, phaseDirs) {
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')
    sh """
        cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- destroy -auto-approve
    """
}
