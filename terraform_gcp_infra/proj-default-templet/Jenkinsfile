pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // Terragrunt ì‘ì—… ë””ë ‰í„°ë¦¬ (í™˜ê²½ ë£¨íŠ¸)
        TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/jsj-game-l'
        // ë°˜ë³µ ë‹¤ìš´ë¡œë“œë¥¼ ì¤„ì—¬ provider ì„¤ì¹˜ ì‹¤íŒ¨ë¥¼ ì˜ˆë°©
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancer'
            ],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ (all = ì „ì²´ ìŠ¤íƒ)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'ğŸ”§ Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            dir("${TG_WORKING_DIR}") {
                                sh '''
                                    find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                    find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                    find . -name "tfplan" -type f -delete || true
                                '''
                            }
                            dir("${env.WORKSPACE}") {
                                sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all init"
                            }
                        } else {
                            dir("${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                                sh '''
                                    rm -rf .terragrunt-cache .terraform || true
                                    rm -f tfplan || true
                                    terragrunt init
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan') {
            steps {
                script {
                    echo 'ğŸ“‹ Running Terragrunt Plan...'
                    if (params.TARGET_LAYER == 'all') {
                        // 00-projectë§Œ ìš°ì„  Plan (API enable ì „íŒŒ ì´ì „ì— ë‹¤ë¥¸ ë ˆì´ì–´ Plan ë°©ì§€)
                        dir("${TG_WORKING_DIR}/00-project") {
                            sh '''
                                rm -rf .terragrunt-cache .terraform || true
                                rm -f tfplan-00-project || true
                            '''
                        }
                        dir("${env.WORKSPACE}") {
                            sh "terragrunt --working-dir ${TG_WORKING_DIR} run --queue-include-dir '00-project' --all plan -- -out=tfplan-00-project"
                        }
                    } else {
                        dir("${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                            sh 'terragrunt plan -out=tfplan'
                        }
                    }
                }
            }
        }

        stage('Review Plan') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"

                    // Plan ì¶œë ¥ ë‚´ìš© í‘œì‹œ
                    if (params.TARGET_LAYER == 'all') {
                        echo 'âš ï¸  ì „ì²´ ìŠ¤íƒì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤!'
                    } else {
                        echo "âš ï¸  ${params.TARGET_LAYER} ë ˆì´ì–´ì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤!"
                    }
                }
            }
        }

        stage('ğŸ›‘ Manual Approval ğŸ›‘') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  ì¸í”„ë¼ ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'  // ìŠ¹ì¸ ê°€ëŠ¥í•œ ì‚¬ìš©ì ì œí•œ
                        )
                    }
                }
            }
        }

        stage('Terragrunt Apply/Destroy') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'ğŸš€ Applying Terragrunt changes...'
                        if (params.TARGET_LAYER == 'all') {
                            dir("${TG_WORKING_DIR}") {
                                sh '''
                                    find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                '''
                            }
                            dir("${env.WORKSPACE}") {
                                // ì „ì²´ ìŠ¤íƒì€ ìµœì‹  ì½”ë“œ/ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ ì˜ì¡´ ìˆœì„œëŒ€ë¡œ Apply (plan íŒŒì¼ ë¯¸ì‚¬ìš©)
                                sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all apply -- -auto-approve"
                            }
                        } else {
                            dir("${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                                sh 'terragrunt apply tfplan'
                            }
                        }
                    } else if (params.ACTION == 'destroy') {
                        echo 'ğŸ—‘ï¸  Destroying Terragrunt resources...'
                        if (params.TARGET_LAYER == 'all') {
                            dir("${env.WORKSPACE}") {
                                sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all destroy -- -auto-approve"
                            }
                        } else {
                            dir("${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                                sh 'terragrunt destroy -auto-approve'
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo 'âŒ Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}
