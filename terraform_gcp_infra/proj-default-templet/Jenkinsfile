pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // Terragrunt ì‘ì—… ë””ë ‰í„°ë¦¬ (í™˜ê²½ ë£¨íŠ¸)
        TG_WORKING_DIR = 'terraform_gcp_infra/proj-default-templet'
        // ë°˜ë³µ ë‹¤ìš´ë¡œë“œë¥¼ ì¤„ì—¬ provider ì„¤ì¹˜ ì‹¤íŒ¨ë¥¼ ì˜ˆë°©
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancers/web',
                '70-loadbalancers/app',
                '70-loadbalancers/lobby',
                '75-dns'
            ],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ (all = ì „ì²´ ìŠ¤íƒ)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'ğŸ”§ Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            // Clean cache files using absolute path
                            sh """
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan*" -type f -delete || true
                            """

                            // Run terragrunt run --all init with working-dir flag
                            sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init"
                        } else {
                            // Single layer init
                            sh """
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terragrunt-cache' || true
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/tfplan' || true
                            """
                            sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' init"
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan - Bootstrap (00-project)') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    echo 'ğŸ“‹ [Phase 1/2] Planning Bootstrap Layer (00-project)...'
                    sh """
                        rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project/.terragrunt-cache' || true
                        rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project/.terraform' || true
                        rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project/tfplan-00-project' || true
                    """

                    // Run terragrunt plan with working-dir flag
                    sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project' -- plan -out=tfplan-00-project"

                    // Plan íŒŒì¼ì„ Jenkins Artifactë¡œ ì €ì¥
                    archiveArtifacts artifacts: "**/00-project/**/tfplan-00-project", allowEmptyArchive: true
                }
            }
        }

        stage('ğŸ›‘ Approval - Bootstrap ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  [Phase 1/2] Bootstrap Layer ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: 00-project (API í™œì„±í™”)
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    00-project Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    (ìŠ¹ì¸ í›„ ë‚˜ë¨¸ì§€ ë ˆì´ì–´ Planì´ ì§„í–‰ë©ë‹ˆë‹¤)
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (Bootstrap Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply Bootstrap (00-project)') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸš€ [Phase 1/2] Applying Bootstrap Layer...'
                    sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project' -- apply tfplan-00-project"
                }
            }
        }

        stage('Wait for API Propagation') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    echo 'â³ Waiting for GCP API propagation (120 seconds)...'
                    echo 'APIs being enabled: compute, servicenetworking, networkconnectivity, etc.'
                    sleep(time: 120, unit: 'SECONDS')
                    echo 'âœ… API propagation wait completed'
                }
            }
        }

        stage('Terragrunt Plan - Remaining Layers') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    echo 'ğŸ“‹ [Phase 2/2] Planning Remaining Layers (10-network ~ 75-dns)...'
                    sh """
                        find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                        find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                        find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan-rest" -type f -delete || true
                    """

                    // 00-projectë¥¼ ì œì™¸í•œ ëª¨ë“  ë ˆì´ì–´ Plan
                    sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' --queue-exclude-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project' -- plan -out=tfplan-rest"

                    // Plan íŒŒì¼ì„ Jenkins Artifactë¡œ ì €ì¥
                    archiveArtifacts artifacts: "**/tfplan-rest", allowEmptyArchive: true
                }
            }
        }

        stage('ğŸ›‘ Approval - Remaining Layers ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  [Phase 2/2] Remaining Layers ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: 10-network ~ 75-dns (ì „ì²´ ì¸í”„ë¼)
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ì „ì²´ ì¸í”„ë¼ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    âš ï¸  Network, Database, LoadBalancer ë“± ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (ì „ì²´ ì¸í”„ë¼ Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply Remaining Layers') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸš€ [Phase 2/2] Applying Remaining Layers...'
                    // Plan íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ Apply (ë³€ê²½ì‚¬í•­ì´ Planê³¼ ë™ì¼í•¨ì„ ë³´ì¥)
                    sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' --queue-exclude-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/00-project' -- apply tfplan-rest"
                }
            }
        }

        stage('Terragrunt Plan - Single Layer') {
            when {
                expression { params.TARGET_LAYER != 'all' }
            }
            steps {
                script {
                    echo 'ğŸ“‹ Running Terragrunt Plan...'
                    sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' plan -out=tfplan"
                    archiveArtifacts artifacts: "**/${params.TARGET_LAYER}/**/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                    echo "âš ï¸  ${params.TARGET_LAYER} ë ˆì´ì–´ì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤!"
                }
            }
        }

        stage('ğŸ›‘ Approval - Single Layer ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  ì¸í”„ë¼ ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'ğŸš€ Applying Terragrunt changes...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'ğŸ—‘ï¸  Destroying Terragrunt resources...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' destroy -auto-approve"
                    }
                }
            }
        }

        stage('Destroy All Layers') {
            when {
                allOf {
                    expression { params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸ—‘ï¸  Destroying All Layers (ì—­ìˆœ)...'
                    // ì—­ìˆœìœ¼ë¡œ destroy (ì˜ì¡´ì„± ê³ ë ¤)
                    sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- destroy -auto-approve"
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo 'âŒ Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}
