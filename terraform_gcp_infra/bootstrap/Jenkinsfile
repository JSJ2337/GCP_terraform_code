// ============================================================================
// Bootstrap Pipeline (Terragrunt Multi-Layer)
// ============================================================================
// ì´ íŒŒì´í”„ë¼ì¸ì€ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform State ë²„í‚·ê³¼ ê³µí†µ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
//
// ë ˆì´ì–´ êµ¬ì¡°:
//   00-foundation : ê´€ë¦¬ í”„ë¡œì íŠ¸, API í™œì„±í™”, Terraform State ë²„í‚·
//   10-network    : VPC, ì„œë¸Œë„·, ë°©í™”ë²½, NAT
//   20-storage    : GCS ë²„í‚· (ì•„í‹°íŒ©íŠ¸, ë°±ì—… ë“±)
//   50-compute    : Jenkins VM, Bastion Host
//
// Backend: GCS (gs://delabs-terraform-state-live/bootstrap)
//
// âš ï¸ ì£¼ì˜: ì´ ë ˆì´ì–´ëŠ” ë‹¤ë¥¸ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ì´ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‹¤í–‰í•˜ì„¸ìš”!
// ============================================================================

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        // Bootstrap ì‘ì—… ë””ë ‰í„°ë¦¬
        TF_WORKING_DIR = 'terraform_gcp_infra/bootstrap'
        // Provider ìºì‹œ
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('delabs-terraform-admin')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        choice(
            name: 'LAYER',
            choices: ['all', '00-foundation', '10-network', '20-storage', '50-compute'],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ ì„ íƒ (all = ëª¨ë“  ë ˆì´ì–´ ìˆœì°¨ ì‹¤í–‰)'
        )
        booleanParam(
            name: 'MANAGE_FOLDERS',
            defaultValue: false,
            description: 'GCP í´ë” êµ¬ì¡° (games/regions/environments) ê´€ë¦¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'MANAGE_ORG_IAM',
            defaultValue: false,
            description: 'ì¡°ì§ ë ˆë²¨ IAM (í”„ë¡œì íŠ¸ ìƒì„±, billing.user, editor) ê´€ë¦¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'ENABLE_BILLING_BINDING',
            defaultValue: false,
            description: 'ì²­êµ¬ ê³„ì •ì— Jenkins SAì˜ roles/billing.user ë¶€ì—¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'USE_LOCAL_BACKEND',
            defaultValue: false,
            description: 'âš ï¸ ì²« ë°°í¬ ì‹œ ì²´í¬! State ë²„í‚·ì´ ì—†ì„ ë•Œ ë¡œì»¬ ë°±ì—”ë“œ ì‚¬ìš©'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Layer: ${params.LAYER}"
                    echo ""
                    echo "âš ï¸  Bootstrap Layer - ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤!"
                    echo "ğŸ”§ Options:"
                    echo "   - Manage Folders: ${params.MANAGE_FOLDERS}"
                    echo "   - Manage Org IAM: ${params.MANAGE_ORG_IAM}"
                    echo "   - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}"
                    echo "   - Use Local Backend: ${params.USE_LOCAL_BACKEND}"

                    if (params.USE_LOCAL_BACKEND) {
                        echo ""
                        echo "âš ï¸  ë¡œì»¬ ë°±ì—”ë“œ ëª¨ë“œ: Stateê°€ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤!"
                        echo "   ì²« ë°°í¬ í›„ State ë²„í‚· ìƒì„±ë˜ë©´ USE_LOCAL_BACKEND í•´ì œí•˜ì„¸ìš”."
                    }
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init & Plan') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"

                    def layers = params.LAYER == 'all' ?
                        ['00-foundation', '10-network', '20-storage', '50-compute'] :
                        [params.LAYER]

                    // destroyì˜ ê²½ìš° ì—­ìˆœ ì‹¤í–‰
                    if (params.ACTION == 'destroy') {
                        layers = layers.reverse()
                    }

                    env.LAYERS = layers.join(',')

                    // ë¡œì»¬ ë°±ì—”ë“œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                    def envVars = params.USE_LOCAL_BACKEND ? ['TG_USE_LOCAL_BACKEND=true'] : []

                    withEnv(envVars) {
                        for (layer in layers) {
                            def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"

                            echo "ğŸ”§ [${layer}] Initializing Terragrunt..."

                            // Clean cache files
                            sh """
                                rm -rf '${layerDir}/.terraform' || true
                                rm -rf '${layerDir}/.terragrunt-cache' || true
                                rm -f '${layerDir}/tfplan' || true
                            """

                            retry(3) {
                                sh "cd '${layerDir}' && terragrunt init"
                            }

                            echo "ğŸ“‹ [${layer}] Running Terragrunt Plan..."

                            // ë³€ìˆ˜ íŒŒì¼ ìƒì„± (íŒŒë¼ë¯¸í„° ë°˜ì˜) - foundation ë ˆì´ì–´ë§Œ í•´ë‹¹
                            def varArgs = ""
                            if (layer == '00-foundation') {
                                varArgs = """
                                    -var='manage_folders=${params.MANAGE_FOLDERS}' \
                                    -var='manage_org_iam=${params.MANAGE_ORG_IAM}' \
                                    -var='enable_billing_account_binding=${params.ENABLE_BILLING_BINDING}'
                                """.trim()
                            }

                            if (params.ACTION == 'destroy') {
                                sh "cd '${layerDir}' && terragrunt plan -destroy ${varArgs} -out=tfplan"
                            } else {
                                sh "cd '${layerDir}' && terragrunt plan ${varArgs} -out=tfplan"
                            }
                        }
                    }

                    // Archive all tfplan files
                    sh "find '${env.WORKSPACE}/${TF_WORKING_DIR}' -name 'tfplan' -type f | head -20"
                }
            }
        }

        stage('Review Plan') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo ''
                    echo "âš ï¸  Bootstrap Layer ë³€ê²½ ì£¼ì˜ì‚¬í•­:"
                    echo "   - State ë²„í‚· ì‚­ì œ ì‹œ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform Stateê°€ ì†ì‹¤ë©ë‹ˆë‹¤!"
                    echo "   - ê´€ë¦¬ í”„ë¡œì íŠ¸ ì‚­ì œ ì‹œ ëª¨ë“  ê³µìœ  ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë©ë‹ˆë‹¤!"
                    echo "   - í´ë” êµ¬ì¡° ë³€ê²½ ì‹œ í•˜ìœ„ í”„ë¡œì íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                    echo ''
                    echo "Action: ${params.ACTION.toUpperCase()}"
                    echo "Layers: ${env.LAYERS}"
                }
            }
        }

        stage('ğŸ›‘ Approval ğŸ›‘') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def warningMessage = params.ACTION == 'destroy' ?
                        """
                        ğŸš¨ğŸš¨ğŸš¨ ìµœìƒìœ„ ìœ„í—˜ ê²½ê³  ğŸš¨ğŸš¨ğŸš¨

                        Bootstrap Layer DESTROYë¥¼ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤!

                        ëŒ€ìƒ ë ˆì´ì–´: ${env.LAYERS}

                        ì´ ì‘ì—…ì€ ë‹¤ìŒì„ ì‚­ì œí•©ë‹ˆë‹¤:
                        - Terraform State ë²„í‚· (ëª¨ë“  í”„ë¡œì íŠ¸ì˜ state ì†ì‹¤!)
                        - ê´€ë¦¬ìš© í”„ë¡œì íŠ¸ (delabs-gcp-mgmt)
                        - Jenkins / Bastion VM
                        - VPC, ì„œë¸Œë„·, ë°©í™”ë²½ ê·œì¹™
                        - GCP í´ë” êµ¬ì¡° (í™œì„±í™”ëœ ê²½ìš°)

                        ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
                        ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """ :
                        """
                        âš ï¸  Bootstrap Layer ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                        Action: ${params.ACTION.toUpperCase()}
                        Layers: ${env.LAYERS}
                        Branch: ${env.GIT_BRANCH}
                        Commit: ${env.GIT_COMMIT}

                        Options:
                        - Manage Folders: ${params.MANAGE_FOLDERS}
                        - Manage Org IAM: ${params.MANAGE_ORG_IAM}
                        - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}

                        ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: warningMessage,
                            ok: params.ACTION == 'destroy' ?
                                'ğŸš¨ DESTROY ì‹¤í–‰ (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ!)' :
                                'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def layers = env.LAYERS.split(',')
                    def envVars = params.USE_LOCAL_BACKEND ? ['TG_USE_LOCAL_BACKEND=true'] : []

                    withEnv(envVars) {
                        for (layer in layers) {
                            def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"

                            if (params.ACTION == 'apply') {
                                echo "ğŸš€ [${layer}] Applying Terragrunt changes..."
                                sh "cd '${layerDir}' && terragrunt apply tfplan"
                            } else if (params.ACTION == 'destroy') {
                                echo "ğŸ—‘ï¸  [${layer}] Destroying Terragrunt resources..."
                                echo "âš ï¸  ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
                                sh "cd '${layerDir}' && terragrunt apply tfplan"
                            }

                            echo "âœ… [${layer}] ì™„ë£Œ!"
                        }
                    }
                }
            }
        }

        stage('Show Outputs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    def layers = env.LAYERS.split(',')
                    def envVars = params.USE_LOCAL_BACKEND ? ['TG_USE_LOCAL_BACKEND=true'] : []

                    withEnv(envVars) {
                        for (layer in layers) {
                            def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"
                            echo "ğŸ“¤ [${layer}] Terragrunt Outputs:"
                            sh "cd '${layerDir}' && terragrunt output || true"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Bootstrap Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Layers: ${env.LAYERS ?: params.LAYER}"
        }
        failure {
            echo 'âŒ Bootstrap Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
                find . -name ".terragrunt-cache" -type d -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}
