// ============================================================================
// Bootstrap Pipeline (Terragrunt Multi-Layer)
// ============================================================================
// ì´ íŒŒì´í”„ë¼ì¸ì€ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform State ë²„í‚·ê³¼ ê³µí†µ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
//
// ë ˆì´ì–´ êµ¬ì¡°:
//   00-foundation : ê´€ë¦¬ í”„ë¡œì íŠ¸, API í™œì„±í™”, Terraform State ë²„í‚·
//   10-network    : VPC, ì„œë¸Œë„·, Router, NAT
//   12-dns        : Cloud DNS Private Zone (ë‚´ë¶€ DNS)
//   15-firewall   : ë°©í™”ë²½ ê·œì¹™ (IAP SSH, Jenkins, Bastion, Internal)
//   20-storage    : GCS ë²„í‚· (ì•„í‹°íŒ©íŠ¸, ë°±ì—… ë“±)
//   50-compute    : Jenkins VM, Bastion Host
//
// Backend: GCS (gs://delabs-terraform-state-live/bootstrap)
//
// âš ï¸ ì£¼ì˜: ì´ ë ˆì´ì–´ëŠ” ë‹¤ë¥¸ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ì´ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‹¤í–‰í•˜ì„¸ìš”!
// ============================================================================

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        // Bootstrap ì‘ì—… ë””ë ‰í„°ë¦¬
        TF_WORKING_DIR = 'terraform_gcp_infra/bootstrap'
        // Provider ìºì‹œ
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('delabs-terraform-admin')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy', 'import-state', 'fix-dns-state'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ (fix-dns-state: DNS ë¦¬íŒ©í† ë§ í›„ state ì •ë¦¬)'
        )
        choice(
            name: 'LAYER',
            choices: ['all', '00-foundation', '10-network', '12-dns', '15-firewall', '20-storage', '50-compute'],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ ì„ íƒ (all = ëª¨ë“  ë ˆì´ì–´ ìˆœì°¨ ì‹¤í–‰)'
        )
        booleanParam(
            name: 'MANAGE_FOLDERS',
            defaultValue: true,
            description: 'GCP í´ë” êµ¬ì¡° (games/regions/environments) ê´€ë¦¬ ì—¬ë¶€ - layer.hclì˜ product_regions ê¸°ë°˜'
        )
        booleanParam(
            name: 'MANAGE_ORG_IAM',
            defaultValue: false,
            description: 'ì¡°ì§ ë ˆë²¨ IAM (í”„ë¡œì íŠ¸ ìƒì„±, billing.user, editor) ê´€ë¦¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'ENABLE_BILLING_BINDING',
            defaultValue: false,
            description: 'ì²­êµ¬ ê³„ì •ì— Jenkins SAì˜ roles/billing.user ë¶€ì—¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'USE_LOCAL_BACKEND',
            defaultValue: false,
            description: 'âš ï¸ ì²« ë°°í¬ ì‹œ ì²´í¬! State ë²„í‚·ì´ ì—†ì„ ë•Œ ë¡œì»¬ ë°±ì—”ë“œ ì‚¬ìš©'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Layer: ${params.LAYER}"
                    echo ""
                    echo "âš ï¸  Bootstrap Layer - ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤!"
                    echo "ğŸ”§ Options:"
                    echo "   - Manage Folders: ${params.MANAGE_FOLDERS}"
                    echo "   - Manage Org IAM: ${params.MANAGE_ORG_IAM}"
                    echo "   - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}"
                    echo "   - Use Local Backend: ${params.USE_LOCAL_BACKEND}"

                    if (params.USE_LOCAL_BACKEND) {
                        echo ""
                        echo "âš ï¸  ë¡œì»¬ ë°±ì—”ë“œ ëª¨ë“œ: Stateê°€ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤!"
                        echo "   ì²« ë°°í¬ í›„ State ë²„í‚· ìƒì„±ë˜ë©´ USE_LOCAL_BACKEND í•´ì œí•˜ì„¸ìš”."
                    }
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init & Plan') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"

                    def layers = params.LAYER == 'all' ?
                        ['00-foundation', '10-network', '12-dns', '15-firewall', '20-storage', '50-compute'] :
                        [params.LAYER]

                    // destroyì˜ ê²½ìš° ì—­ìˆœ ì‹¤í–‰
                    if (params.ACTION == 'destroy') {
                        layers = layers.reverse()
                    }

                    env.LAYERS = layers.join(',')

                    // ë¡œì»¬ ë°±ì—”ë“œ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Boolean í™•ì‹¤í•˜ê²Œ ë³€í™˜)
                    def useLocalBackend = params.USE_LOCAL_BACKEND?.toString()?.toBoolean() ?: false
                    def localBackendValue = useLocalBackend ? 'true' : 'false'

                    // ë””ë²„ê·¸: í™˜ê²½ë³€ìˆ˜ í™•ì¸
                    echo "USE_LOCAL_BACKEND param: ${params.USE_LOCAL_BACKEND}"
                    echo "useLocalBackend: ${useLocalBackend}"
                    echo "localBackendValue: ${localBackendValue}"

                    for (layer in layers) {
                        def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"

                        echo "ğŸ”§ [${layer}] Initializing Terragrunt..."

                        // Clean cache files (backend.tfë„ ì‚­ì œí•´ì•¼ ìƒˆë¡œ ìƒì„±ë¨)
                        sh """
                            rm -rf '${layerDir}/.terraform' || true
                            rm -rf '${layerDir}/.terragrunt-cache' || true
                            rm -f '${layerDir}/tfplan' || true
                            rm -f '${layerDir}/backend.tf' || true
                            rm -f '${layerDir}/provider.tf' || true
                        """

                        // exportë¡œ ëª…ì‹œì  í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ terragrunt ì‹¤í–‰
                        retry(3) {
                            sh """
                                export TG_USE_LOCAL_BACKEND=${localBackendValue}
                                echo "TG_USE_LOCAL_BACKEND=\$TG_USE_LOCAL_BACKEND"
                                cd '${layerDir}' && terragrunt init
                            """
                        }

                        echo "ğŸ“‹ [${layer}] Running Terragrunt Plan..."

                        // ë³€ìˆ˜ íŒŒì¼ ìƒì„± (íŒŒë¼ë¯¸í„° ë°˜ì˜) - foundation ë ˆì´ì–´ë§Œ í•´ë‹¹
                        def varArgs = ""
                        if (layer == '00-foundation') {
                            varArgs = """
                                -var='manage_folders=${params.MANAGE_FOLDERS}' \
                                -var='manage_org_iam=${params.MANAGE_ORG_IAM}' \
                                -var='enable_billing_account_binding=${params.ENABLE_BILLING_BINDING}'
                            """.trim()
                        }

                        if (params.ACTION == 'destroy') {
                            sh """
                                export TG_USE_LOCAL_BACKEND=${localBackendValue}
                                cd '${layerDir}' && terragrunt plan -destroy ${varArgs} -out=tfplan
                            """
                        } else {
                            sh """
                                export TG_USE_LOCAL_BACKEND=${localBackendValue}
                                cd '${layerDir}' && terragrunt plan ${varArgs} -out=tfplan
                            """
                        }
                    }

                    // Archive all tfplan files
                    sh "find '${env.WORKSPACE}/${TF_WORKING_DIR}' -name 'tfplan' -type f | head -20"
                }
            }
        }

        stage('Review Plan') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo ''
                    echo "âš ï¸  Bootstrap Layer ë³€ê²½ ì£¼ì˜ì‚¬í•­:"
                    echo "   - State ë²„í‚· ì‚­ì œ ì‹œ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform Stateê°€ ì†ì‹¤ë©ë‹ˆë‹¤!"
                    echo "   - ê´€ë¦¬ í”„ë¡œì íŠ¸ ì‚­ì œ ì‹œ ëª¨ë“  ê³µìœ  ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë©ë‹ˆë‹¤!"
                    echo "   - í´ë” êµ¬ì¡° ë³€ê²½ ì‹œ í•˜ìœ„ í”„ë¡œì íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                    echo ''
                    echo "Action: ${params.ACTION.toUpperCase()}"
                    echo "Layers: ${env.LAYERS}"
                }
            }
        }

        stage('ğŸ›‘ Approval ğŸ›‘') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def warningMessage = params.ACTION == 'destroy' ?
                        """
                        ğŸš¨ğŸš¨ğŸš¨ ìµœìƒìœ„ ìœ„í—˜ ê²½ê³  ğŸš¨ğŸš¨ğŸš¨

                        Bootstrap Layer DESTROYë¥¼ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤!

                        ëŒ€ìƒ ë ˆì´ì–´: ${env.LAYERS}

                        ì´ ì‘ì—…ì€ ë‹¤ìŒì„ ì‚­ì œí•©ë‹ˆë‹¤:
                        - Terraform State ë²„í‚· (ëª¨ë“  í”„ë¡œì íŠ¸ì˜ state ì†ì‹¤!)
                        - ê´€ë¦¬ìš© í”„ë¡œì íŠ¸ (delabs-gcp-mgmt)
                        - Jenkins / Bastion VM
                        - VPC, ì„œë¸Œë„·, ë°©í™”ë²½ ê·œì¹™
                        - GCP í´ë” êµ¬ì¡° (í™œì„±í™”ëœ ê²½ìš°)

                        ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
                        ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """ :
                        """
                        âš ï¸  Bootstrap Layer ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                        Action: ${params.ACTION.toUpperCase()}
                        Layers: ${env.LAYERS}
                        Branch: ${env.GIT_BRANCH}
                        Commit: ${env.GIT_COMMIT}

                        Options:
                        - Manage Folders: ${params.MANAGE_FOLDERS}
                        - Manage Org IAM: ${params.MANAGE_ORG_IAM}
                        - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}

                        ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: warningMessage,
                            ok: params.ACTION == 'destroy' ?
                                'ğŸš¨ DESTROY ì‹¤í–‰ (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ!)' :
                                'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def layers = env.LAYERS.split(',')
                    def useLocalBackend = params.USE_LOCAL_BACKEND?.toString()?.toBoolean() ?: false
                    def localBackendValue = useLocalBackend ? 'true' : 'false'

                    for (layer in layers) {
                        def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"

                        if (params.ACTION == 'apply') {
                            echo "ğŸš€ [${layer}] Applying Terragrunt changes..."
                            sh """
                                export TG_USE_LOCAL_BACKEND=${localBackendValue}
                                cd '${layerDir}' && terragrunt apply tfplan
                            """
                        } else if (params.ACTION == 'destroy') {
                            echo "ğŸ—‘ï¸  [${layer}] Destroying Terragrunt resources..."
                            echo "âš ï¸  ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
                            sh """
                                export TG_USE_LOCAL_BACKEND=${localBackendValue}
                                cd '${layerDir}' && terragrunt apply tfplan
                            """
                        }

                        echo "âœ… [${layer}] ì™„ë£Œ!"
                    }
                }
            }
        }

        stage('Show Outputs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    def layers = env.LAYERS.split(',')
                    def useLocalBackend = params.USE_LOCAL_BACKEND?.toString()?.toBoolean() ?: false
                    def localBackendValue = useLocalBackend ? 'true' : 'false'

                    for (layer in layers) {
                        def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"
                        echo "ğŸ“¤ [${layer}] Terragrunt Outputs:"
                        sh """
                            export TG_USE_LOCAL_BACKEND=${localBackendValue}
                            cd '${layerDir}' && terragrunt output || true
                        """
                    }
                }
            }
        }

        stage('Import State') {
            when {
                expression { params.ACTION == 'import-state' }
            }
            steps {
                script {
                    echo "ğŸ“¥ ê¸°ì¡´ GCP ë¦¬ì†ŒìŠ¤ë¥¼ Terraform Stateë¡œ Importí•©ë‹ˆë‹¤..."
                    echo "âš ï¸  USE_LOCAL_BACKENDëŠ” ë°˜ë“œì‹œ falseì—¬ì•¼ í•©ë‹ˆë‹¤!"

                    def layers = env.LAYERS.split(',')

                    for (layer in layers) {
                        def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/${layer}"

                        echo "ğŸ”§ [${layer}] Initializing for import..."
                        sh """
                            rm -rf '${layerDir}/.terraform' || true
                            rm -rf '${layerDir}/.terragrunt-cache' || true
                            rm -f '${layerDir}/backend.tf' || true
                            rm -f '${layerDir}/provider.tf' || true
                            cd '${layerDir}' && terragrunt init
                        """

                        if (layer == '00-foundation') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_service_account.jenkins_terraform' 'projects/delabs-gcp-mgmt/serviceAccounts/jenkins-terraform-admin@delabs-gcp-mgmt.iam.gserviceaccount.com' || true
                            """
                            // APIëŠ” import ë¶ˆí•„ìš” (ì¡´ì¬í•˜ë©´ no-op)
                        }

                        if (layer == '10-network') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_compute_network.mgmt_vpc' 'projects/delabs-gcp-mgmt/global/networks/delabs-gcp-mgmt-vpc' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_subnetwork.mgmt_subnet' 'projects/delabs-gcp-mgmt/regions/asia-northeast3/subnetworks/delabs-gcp-mgmt-subnet' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_router.mgmt_router' 'projects/delabs-gcp-mgmt/regions/asia-northeast3/routers/delabs-gcp-mgmt-router' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_router_nat.mgmt_nat' 'projects/delabs-gcp-mgmt/regions/asia-northeast3/routers/delabs-gcp-mgmt-router/delabs-gcp-mgmt-nat' || true
                            """
                        }

                        if (layer == '12-dns') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_dns_managed_zone.private' 'projects/delabs-gcp-mgmt/managedZones/delabsgames-internal' || true
                                cd '${layerDir}' && terragrunt import 'google_dns_record_set.records["jenkins"]' 'projects/delabs-gcp-mgmt/managedZones/delabsgames-internal/rrsets/jenkins.delabsgames.internal./A' || true
                                cd '${layerDir}' && terragrunt import 'google_dns_record_set.records["bastion"]' 'projects/delabs-gcp-mgmt/managedZones/delabsgames-internal/rrsets/bastion.delabsgames.internal./A' || true
                            """
                        }

                        if (layer == '15-firewall') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_compute_firewall.allow_iap_ssh' 'projects/delabs-gcp-mgmt/global/firewalls/delabs-gcp-mgmt-vpc-allow-iap-ssh' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_firewall.allow_jenkins' 'projects/delabs-gcp-mgmt/global/firewalls/delabs-gcp-mgmt-vpc-allow-jenkins' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_firewall.allow_bastion_ssh' 'projects/delabs-gcp-mgmt/global/firewalls/delabs-gcp-mgmt-vpc-allow-bastion-ssh' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_firewall.allow_internal' 'projects/delabs-gcp-mgmt/global/firewalls/delabs-gcp-mgmt-vpc-allow-internal' || true
                            """
                        }

                        if (layer == '20-storage') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_storage_bucket.tfstate_prod' 'delabs-gcp-mgmt/delabs-terraform-state-live' || true
                                cd '${layerDir}' && terragrunt import 'google_storage_bucket_iam_member.jenkins_tfstate_prod' 'delabs-terraform-state-live roles/storage.objectAdmin serviceAccount:jenkins-terraform-admin@delabs-gcp-mgmt.iam.gserviceaccount.com' || true
                            """
                        }

                        if (layer == '50-compute') {
                            echo "ğŸ“¥ [${layer}] Importing resources..."
                            sh """
                                cd '${layerDir}' && terragrunt import 'google_compute_disk.boot["delabs-terraform-jenkins"]' 'projects/delabs-gcp-mgmt/zones/asia-northeast3-a/disks/delabs-terraform-jenkins-boot' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_disk.boot["delabs-bastion"]' 'projects/delabs-gcp-mgmt/zones/asia-northeast3-a/disks/delabs-bastion-boot' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_instance.vm["delabs-terraform-jenkins"]' 'projects/delabs-gcp-mgmt/zones/asia-northeast3-a/instances/delabs-terraform-jenkins' || true
                                cd '${layerDir}' && terragrunt import 'google_compute_instance.vm["delabs-bastion"]' 'projects/delabs-gcp-mgmt/zones/asia-northeast3-a/instances/delabs-bastion' || true
                            """
                        }

                        echo "âœ… [${layer}] Import ì™„ë£Œ!"
                    }

                    echo ""
                    echo "ğŸ‰ Import ì™„ë£Œ! ì´ì œ ACTION=planìœ¼ë¡œ í™•ì¸ í›„ applyí•˜ì„¸ìš”."
                }
            }
        }

        stage('Fix DNS State') {
            when {
                expression { params.ACTION == 'fix-dns-state' }
            }
            steps {
                script {
                    echo "ğŸ”§ DNS ë¦¬íŒ©í† ë§ í›„ state ì •ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
                    echo "   ì´ì „ ë¦¬ì†ŒìŠ¤ëª…(google_dns_record_set.jenkins/bastion)ì„"
                    echo "   ìƒˆ ë¦¬ì†ŒìŠ¤ëª…(google_dns_record_set.records[\"...\"])ìœ¼ë¡œ ì´ì „í•©ë‹ˆë‹¤."

                    def layerDir = "${env.WORKSPACE}/${TF_WORKING_DIR}/12-dns"

                    // Clean cache and init
                    sh """
                        rm -rf '${layerDir}/.terraform' || true
                        rm -rf '${layerDir}/.terragrunt-cache' || true
                        rm -f '${layerDir}/backend.tf' || true
                        rm -f '${layerDir}/provider.tf' || true
                        cd '${layerDir}' && terragrunt init
                    """

                    echo "ğŸ“‹ í˜„ì¬ state í™•ì¸..."
                    sh """
                        cd '${layerDir}' && terragrunt state list || true
                    """

                    echo "ğŸ—‘ï¸  ì´ì „ ë¦¬ì†ŒìŠ¤ ì°¸ì¡° ì œê±°..."
                    sh """
                        cd '${layerDir}' && terragrunt state rm 'google_dns_record_set.jenkins' || true
                        cd '${layerDir}' && terragrunt state rm 'google_dns_record_set.bastion' || true
                    """

                    echo "ğŸ“‹ ì •ë¦¬ í›„ state í™•ì¸..."
                    sh """
                        cd '${layerDir}' && terragrunt state list || true
                    """

                    echo ""
                    echo "âœ… State ì •ë¦¬ ì™„ë£Œ!"
                    echo "   ì´ì œ LAYER=12-dns, ACTION=applyë¡œ DNS ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ì„¸ìš”."
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Bootstrap Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Layers: ${env.LAYERS ?: params.LAYER}"
        }
        failure {
            echo 'âŒ Bootstrap Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
                find . -name ".terragrunt-cache" -type d -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}
