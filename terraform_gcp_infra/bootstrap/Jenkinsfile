// ============================================================================
// Bootstrap Pipeline
// ============================================================================
// ì´ íŒŒì´í”„ë¼ì¸ì€ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform State ë²„í‚·ê³¼ ê³µí†µ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
// - ê´€ë¦¬ìš© í”„ë¡œì íŠ¸ (jsj-system-mgmt)
// - Terraform State ë²„í‚·
// - GCP í´ë” êµ¬ì¡° (games, games2 ë“±)
// - Jenkins Service Account ë° ì¡°ì§ ë ˆë²¨ IAM ê¶Œí•œ
//
// Backend: GCS (gs://jsj-terraform-state-prod/bootstrap)
//
// âš ï¸ ì£¼ì˜: ì´ ë ˆì´ì–´ëŠ” ë‹¤ë¥¸ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ì´ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‹¤í–‰í•˜ì„¸ìš”!
// ============================================================================

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        // Bootstrap ì‘ì—… ë””ë ‰í„°ë¦¬
        TF_WORKING_DIR = 'terraform_gcp_infra/bootstrap'
        // Provider ìºì‹œ
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terraform ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        booleanParam(
            name: 'MANAGE_FOLDERS',
            defaultValue: false,
            description: 'GCP í´ë” êµ¬ì¡° (games/regions/environments) ê´€ë¦¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'MANAGE_ORG_IAM',
            defaultValue: false,
            description: 'ì¡°ì§ ë ˆë²¨ IAM (í”„ë¡œì íŠ¸ ìƒì„±, billing.user, editor) ê´€ë¦¬ ì—¬ë¶€'
        )
        booleanParam(
            name: 'ENABLE_BILLING_BINDING',
            defaultValue: false,
            description: 'ì²­êµ¬ ê³„ì •ì— Jenkins SAì˜ roles/billing.user ë¶€ì—¬ ì—¬ë¶€'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo ""
                    echo "âš ï¸  Bootstrap Layer - ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤!"
                    echo "ğŸ”§ Options:"
                    echo "   - Manage Folders: ${params.MANAGE_FOLDERS}"
                    echo "   - Manage Org IAM: ${params.MANAGE_ORG_IAM}"
                    echo "   - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    git --version
                '''
            }
        }

        stage('Terraform Init') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'ğŸ”§ Initializing Terraform...'

                    // Clean cache files
                    sh """
                        rm -rf '${env.WORKSPACE}/${TF_WORKING_DIR}/.terraform' || true
                        rm -f '${env.WORKSPACE}/${TF_WORKING_DIR}/tfplan' || true
                    """

                    retry(3) {
                        sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' init"
                    }
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    echo 'ğŸ“‹ Running Terraform Plan...'

                    // ë³€ìˆ˜ íŒŒì¼ ìƒì„± (íŒŒë¼ë¯¸í„° ë°˜ì˜)
                    def varArgs = """
                        -var='manage_folders=${params.MANAGE_FOLDERS}' \
                        -var='manage_org_iam=${params.MANAGE_ORG_IAM}' \
                        -var='enable_billing_account_binding=${params.ENABLE_BILLING_BINDING}'
                    """.trim()

                    if (params.ACTION == 'destroy') {
                        sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' plan -destroy ${varArgs} -out=tfplan"
                    } else {
                        sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' plan ${varArgs} -out=tfplan"
                    }

                    archiveArtifacts artifacts: "${TF_WORKING_DIR}/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo ''
                    echo "âš ï¸  Bootstrap Layer ë³€ê²½ ì£¼ì˜ì‚¬í•­:"
                    echo "   - State ë²„í‚· ì‚­ì œ ì‹œ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ Terraform Stateê°€ ì†ì‹¤ë©ë‹ˆë‹¤!"
                    echo "   - ê´€ë¦¬ í”„ë¡œì íŠ¸ ì‚­ì œ ì‹œ ëª¨ë“  ê³µìœ  ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë©ë‹ˆë‹¤!"
                    echo "   - í´ë” êµ¬ì¡° ë³€ê²½ ì‹œ í•˜ìœ„ í”„ë¡œì íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                    echo ''
                    echo "Action: ${params.ACTION.toUpperCase()}"
                }
            }
        }

        stage('ğŸ›‘ Approval ğŸ›‘') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def warningMessage = params.ACTION == 'destroy' ?
                        """
                        ğŸš¨ğŸš¨ğŸš¨ ìµœìƒìœ„ ìœ„í—˜ ê²½ê³  ğŸš¨ğŸš¨ğŸš¨

                        Bootstrap Layer DESTROYë¥¼ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤!

                        ì´ ì‘ì—…ì€ ë‹¤ìŒì„ ì‚­ì œí•©ë‹ˆë‹¤:
                        - Terraform State ë²„í‚· (ëª¨ë“  í”„ë¡œì íŠ¸ì˜ state ì†ì‹¤!)
                        - ê´€ë¦¬ìš© í”„ë¡œì íŠ¸ (jsj-system-mgmt)
                        - Jenkins Service Account
                        - GCP í´ë” êµ¬ì¡° (í™œì„±í™”ëœ ê²½ìš°)

                        ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
                        ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """ :
                        """
                        âš ï¸  Bootstrap Layer ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                        Action: ${params.ACTION.toUpperCase()}
                        Branch: ${env.GIT_BRANCH}
                        Commit: ${env.GIT_COMMIT}

                        Options:
                        - Manage Folders: ${params.MANAGE_FOLDERS}
                        - Manage Org IAM: ${params.MANAGE_ORG_IAM}
                        - Enable Billing Binding: ${params.ENABLE_BILLING_BINDING}

                        ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: warningMessage,
                            ok: params.ACTION == 'destroy' ?
                                'ğŸš¨ DESTROY ì‹¤í–‰ (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ!)' :
                                'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'ğŸš€ Applying Terraform changes...'
                        sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'ğŸ—‘ï¸  Destroying Terraform resources...'
                        echo 'âš ï¸  ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'
                        sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' apply tfplan"
                    }
                }
            }
        }

        stage('Show Outputs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    echo 'ğŸ“¤ Terraform Outputs:'
                    sh "terraform -chdir='${env.WORKSPACE}/${TF_WORKING_DIR}' output || true"
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Bootstrap Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
        }
        failure {
            echo 'âŒ Bootstrap Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}
