pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION   = 'true'
        TF_INPUT           = 'false'
        TG_NON_INTERACTIVE = 'true'
        TG_WORKING_DIR     = 'terraform_gcp_infra/environments/LIVE/jsj-game-k'
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terragrunt Ïã§ÌñâÌï† ÏûëÏóÖ ÏÑ†ÌÉù')
        choice(
            name: 'TARGET_LAYER',
            choices: ['all','00-project','10-network','20-storage','30-security','40-observability','50-workloads','60-database','65-cache','70-loadbalancer'],
            description: 'Ïã§ÌñâÌï† Î†àÏù¥Ïñ¥ (all = Ï†ÑÏ≤¥ Ïä§ÌÉù)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "‚úÖ Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'üîç Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    echo 'üîß Initializing Terragrunt...'
                    if (params.TARGET_LAYER == 'all') {
                        dir("${TG_WORKING_DIR}") {
                            sh '''
                                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find . -name "tfplan" -type f -delete || true
                            '''
                        }
                        dir("${env.WORKSPACE}") {
                            sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all init"
                        }
                    } else {
                        dir("${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                            sh '''
                                rm -rf .terragrunt-cache .terraform || true
                                rm -f tfplan || true
                                terragrunt init
                            '''
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan') {
            steps {
                script {
                    echo 'üìã Running Terragrunt Plan...'
                    if (params.TARGET_LAYER == 'all') {
                        dir("${TG_WORKING_DIR}/00-project") {
                            sh '''
                                rm -rf .terragrunt-cache .terraform || true
                                rm -f tfplan-00-project || true
                            '''
                        }
                        dir("${env.WORKSPACE}") {
                            sh "terragrunt --working-dir ${TG_WORKING_DIR} run --queue-include-dir '00-project' --all plan -- -out=tfplan-00-project"
                        }
                    } else {
                        dir("${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                            sh 'terragrunt plan -out=tfplan'
                        }
                    }
                }
            }
        }

        stage('üõë Manual Approval üõë') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def approvalMessage = """
                    ‚ö†Ô∏è  Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω ÏäπÏù∏ ÌïÑÏöî ‚ö†Ô∏è

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ÏúÑ PlanÏùÑ Í≤ÄÌÜ†Ìïú ÌõÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(message: approvalMessage, ok: '‚úÖ ÏäπÏù∏ (Apply Ïã§Ìñâ)', submitter: 'admin')
                    }
                }
            }
        }

        stage('Terragrunt Apply/Destroy') {
            when {
                expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'üöÄ Applying Terragrunt changes...'
                        if (params.TARGET_LAYER == 'all') {
                            dir("${TG_WORKING_DIR}") {
                                sh '''
                                    find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                '''
                            }
                            dir("${env.WORKSPACE}") {
                                sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all apply -- -auto-approve"
                            }
                        } else {
                            dir("${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                                sh 'terragrunt apply tfplan'
                            }
                        }
                    } else if (params.ACTION == 'destroy') {
                        echo 'üóëÔ∏è  Destroying Terragrunt resources...'
                        if (params.TARGET_LAYER == 'all') {
                            dir("${env.WORKSPACE}") {
                                sh "terragrunt --working-dir ${TG_WORKING_DIR} run --all destroy -- -auto-approve"
                            }
                        } else {
                            dir("${TG_WORKING_DIR}/${params.TARGET_LAYER}") {
                                sh 'terragrunt destroy -auto-approve'
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'üèÅ Pipeline finished'
        }
    }
}
