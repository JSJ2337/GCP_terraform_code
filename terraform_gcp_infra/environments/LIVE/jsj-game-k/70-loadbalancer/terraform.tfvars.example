# Terragrunt entrypoint: environments/LIVE/proj-default-templet/70-loadbalancer/terragrunt.hcl
# 로드 밸런서 모듈 설정 예시
# (terraform.tfvars로 복사 후 값 입력, 원본은 커밋하지 마세요)

# 지원 타입
# - http            : 외부 HTTP(S) LB (글로벌)
# - internal        : 내부 HTTP(S) LB (리전)
# - internal_classic: 내부 TCP/UDP LB (리전)
lb_type = "http"

# 내부 LB 구성 시 지정 (외부 LB는 기본값 사용 가능)
region   = "us-central1"
network  = ""  # 비워두면 naming 모듈의 VPC 사용
subnetwork = ""
# Private/WAS 서브넷을 명시하려면 self-link를 지정하세요.
# internal_subnetwork_self_link = "projects/jsj-game-l/regions/asia-northeast3/subnetworks/game-l-subnet-private"

# 백엔드 서비스
backend_protocol  = "HTTP"
backend_port_name = "http"
backend_timeout   = 30

# 백엔드 그룹 (Instance Group Self Link 필요, named port 설정 필수)
backends = [
  {
    # 50-workloads에서 생성된 MIG 출력 사용 예:
    # group = module.gce_mig.instance_groups["jsj-web-mig"]
    group           = "projects/jsj-game-l/zones/asia-northeast3-a/instanceGroups/jsj-web-mig-mig"
    balancing_mode  = "UTILIZATION"
    capacity_scaler = 1.0
    description     = "웹 서비스"
    max_utilization = 0.8
  }
]

# 세션 유지 정책
session_affinity            = "NONE"  # NONE, CLIENT_IP, GENERATED_COOKIE 등
affinity_cookie_ttl         = 0
connection_draining_timeout = 300

# 헬스 체크
create_health_check              = true
health_check_type                = "http"  # http, https, tcp
health_check_port                = 80
health_check_request_path        = "/"
health_check_response            = ""
health_check_port_specification  = "USE_FIXED_PORT"
health_check_timeout             = 5
health_check_interval            = 10
health_check_healthy_threshold   = 2
health_check_unhealthy_threshold = 2
health_check_logging             = false

# Cloud CDN (HTTP(S) LB)
enable_cdn            = false
cdn_cache_mode        = "CACHE_ALL_STATIC"
cdn_default_ttl       = 3600
cdn_max_ttl           = 86400
cdn_client_ttl        = 3600
cdn_negative_caching  = false
cdn_serve_while_stale = 0

# Identity-Aware Proxy
enable_iap = false
# enable_iap = true 일 때는 OAuth2 자격 증명을 함께 입력하세요.
# iap_oauth2_client_id     = "your-client-id"
# iap_oauth2_client_secret = "your-client-secret"

# 로깅
enable_logging      = true
logging_sample_rate = 1.0

# URL 맵 (HTTP(S) LB)
host_rules    = []
path_matchers = []

# SSL (HTTP(S) LB)
use_ssl = false
# use_ssl = true 인 경우 인증서/정책 입력
# ssl_certificates = [
#   "projects/your-project/global/sslCertificates/your-cert"
# ]
# ssl_policy = ""

# Internal LB 포트 설정 예시
# forwarding_rule_ports     = ["80", "443"]
# forwarding_rule_all_ports = false

# 고정 IP 사용 여부
create_static_ip = false
# static_ip_address = "projects/your-project/regions/us-central1/addresses/existing-ip"

# ------------------------------
# 참고 시나리오
# ------------------------------
# 1) 외부 HTTP LB (기본)
# lb_type = "http"
# backends = [{ group = "projects/my-project/zones/us-central1-a/instanceGroups/web-ig" }]
# health_check_port = 80

# 2) 외부 HTTPS LB
# lb_type = "http"
# use_ssl = true
# ssl_certificates = ["projects/my-project/global/sslCertificates/my-cert"]

# 3) 내부 HTTP(S) LB
# lb_type = "internal"
# network  = "projects/my-project/global/networks/my-vpc"
# subnetwork = "projects/my-project/regions/us-central1/subnetworks/my-subnet"

# 4) 내부 TCP LB
# lb_type = "internal_classic"
# forwarding_rule_ports = ["80", "443"]
# health_check_type     = "tcp"
