// ============================================================================
// Phase Ï†ïÏùò: Î†àÏù¥Ïñ¥Î≥Ñ ÏùòÏ°¥ÏÑ±ÏùÑ Í≥†Î†§Ìïú ÏàúÏ∞® Ïã§Ìñâ Íµ¨Ï°∞
// ============================================================================
def PHASES = [
    [id: 'phase1', label: 'Phase 1 - Bootstrap (00-project)', dirs: ['00-project'], optional: false],
    [id: 'phase2', label: 'Phase 2 - Network (10-network)', dirs: ['10-network'], optional: false],
    [id: 'phase3', label: 'Phase 3 - DNS (12-dns)', dirs: ['12-dns'], optional: false],
    [id: 'phase4', label: 'Phase 4 - Storage & Security', dirs: ['20-storage', '30-security'], optional: false],
    [id: 'phase5', label: 'Phase 5 - Observability', dirs: ['40-observability'], optional: true],
    [id: 'phase6', label: 'Phase 6 - Workloads (50-workloads)', dirs: ['50-workloads'], optional: false],
    [id: 'phase7', label: 'Phase 7 - Database & Cache', dirs: ['60-database', '65-cache'], optional: false],
    [id: 'phase8', label: 'Phase 8 - Load Balancers', dirs: ['70-loadbalancers/gs'], optional: false]
]

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // Terragrunt ÏûëÏóÖ ÎîîÎ†âÌÑ∞Î¶¨ (ÌôòÍ≤Ω Î£®Ìä∏)
        TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/gcp-gcby'
        // Plugin cache ÎπÑÌôúÏÑ±Ìôî - Î≥ëÎ†¨ Ïã§Ìñâ Ïãú "text file busy" ÏóêÎü¨ Î∞©ÏßÄ
        // TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP Ïù∏Ï¶ù ÏÑ§Ï†ï (Jenkins Credential ÏÇ¨Ïö©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('delabs-terraform-admin')
        // IPv4 Í∞ïÏ†ú ÏÇ¨Ïö© (IPv6 unreachable Î¨∏Ï†ú Ìï¥Í≤∞)
        GODEBUG = 'netdns=cgo'
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy', 'prepare-destroy'],
            description: 'Terragrunt Ïã§ÌñâÌï† ÏûëÏóÖ ÏÑ†ÌÉù (prepare-destroy: Phase 8Îßå applyÌï¥ÏÑú cleanup resource Ï∂îÍ∞Ä)'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '12-dns',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancers/gs'
            ],
            description: 'Ïã§ÌñâÌï† Î†àÏù¥Ïñ¥ (all = Ï†ÑÏ≤¥ Ïä§ÌÉù)'
        )
        booleanParam(
            name: 'ENABLE_OBSERVABILITY',
            defaultValue: true,
            description: '40-observability Î†àÏù¥Ïñ¥ Ìè¨Ìï® Ïó¨Î∂Ä'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "‚úÖ Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'üîç Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    // Plugin cache ÎπÑÌôúÏÑ±ÌôîÎ°ú Ïù∏Ìï¥ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± Î∂àÌïÑÏöî
                    // sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'üîß Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            // Clean cache files using absolute path
                            sh """
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name ".terraform.lock.hcl" -type f -delete || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan*" -type f -delete || true
                            """

                            // Run terragrunt run --all init with working-dir flag
                            sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init -upgrade"
                        } else {
                            // Single layer init
                            sh """
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terragrunt-cache' || true
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform.lock.hcl' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/tfplan' || true
                            """
                            sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' init -upgrade"
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Phase Í∏∞Î∞ò ÏàúÏ∞® Ïã§Ìñâ (TARGET_LAYER == 'all')
        // Step 1: Î™®Îì† Phase Plan Ïã§Ìñâ
        // ====================================================================
        stage('Plan All Phases') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase Ï≤òÎ¶¨ (apply/plan ÏãúÏóêÎßå skip, destroyÎäî Ìï≠ÏÉÅ Ïã§Ìñâ)
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "‚è≠Ô∏è  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        stage("${phase.label} - Plan") {
                            echo "üìã Planning ${phase.label}..."
                            runPhasePlan(phase, phaseDirs)
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Step 2: Ï†ÑÏ≤¥ ÏäπÏù∏ (Ìïú Î≤àÎßå)
        // ====================================================================
        stage('üõë Approve All Phases üõë') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES
                    def phaseList = orderedPhases.collect { phase ->
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            return null
                        }
                        return "  - ${phase.label}: ${phase.dirs.join(', ')}"
                    }.findAll { it != null }.join('\n')

                    def approvalMessage = """
                    ‚ö†Ô∏è  Ï†ÑÏ≤¥ Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω ÏäπÏù∏ ÌïÑÏöî ‚ö†Ô∏è

                    Action: ${params.ACTION.toUpperCase()}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    Ïã§ÌñâÎê† Phase Î™©Î°ù:
${phaseList}

                    Î™®Îì† PhaseÏùò PlanÏùÑ Í≤ÄÌÜ†Ìïú ÌõÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    ÏäπÏù∏ Ïãú Î™®Îì† PhaseÍ∞Ä ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: "‚úÖ Ï†ÑÏ≤¥ ÏäπÏù∏ (${params.ACTION.capitalize()} ÏàúÏ∞® Ïã§Ìñâ)",
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        // ====================================================================
        // Prepare Destroy: Phase 8Îßå applyÌï¥ÏÑú cleanup resource Ï∂îÍ∞Ä
        // ====================================================================
        stage('Prepare for Destroy') {
            when {
                allOf {
                    expression { params.ACTION == 'prepare-destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def phase8 = PHASES.find { it.id == 'phase8' }

                    stage("${phase8.label} - Apply Cleanup Resources") {
                        echo "üìã Phase 8Îßå applyÌï¥ÏÑú null_resource.backend_cleanupÏùÑ stateÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§..."
                        echo "‚ö†Ô∏è  Ï∞∏Í≥†: Ïù¥ Îã®Í≥ÑÎäî Terraform GCP Provider Î≤ÑÍ∑∏ ÏõåÌÅ¨Ïñ¥ÎùºÏö¥ÎìúÏûÖÎãàÎã§."
                        echo "‚ö†Ô∏è  null_resource provisionerÎäî stateÏóê ÏûàÏñ¥Ïïº destroy Ïãú Ïã§ÌñâÎê©ÎãàÎã§."

                        def includeArgs = phase8.dirs.collect {
                            "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Plan
                        echo "üìã Planning Phase 8..."
                        sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- plan -out=tfplan-prepare-destroy"

                        // Apply
                        echo "üöÄ Applying Phase 8 (cleanup resources only)..."
                        sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- apply tfplan-prepare-destroy"

                        echo "‚úÖ Phase 8 cleanup resources added to Terraform state"
                        echo "‚úÖ Ïù¥Ï†ú 'destroy' Ïï°ÏÖòÏùÑ Ïã§ÌñâÌïòÎ©¥ Backend ServiceÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ïÎ¶¨Îê©ÎãàÎã§."
                    }
                }
            }
        }

        // ====================================================================
        // Step 3: ÏäπÏù∏ ÌõÑ Î™®Îì† Phase Re-plan Î∞è Apply/Destroy ÏàúÏ∞® Ïã§Ìñâ
        // Í∞Å Phase apply ÏßÅÏ†ÑÏóê fresh planÏùÑ ÏÉùÏÑ±ÌïòÏó¨ stale plan Î¨∏Ï†ú Î∞©ÏßÄ
        // ====================================================================
        stage('Execute All Phases') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase Ï≤òÎ¶¨
                        if (phase.optional && phase.id == 'phase5' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "‚è≠Ô∏è  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Phase Ïã§Ìñâ: Re-plan ‚Üí Apply/Destroy
                        stage("${phase.label} - Replan & ${params.ACTION.capitalize()}") {
                            if (params.ACTION == 'apply') {
                                echo "üìã Re-planning ${phase.label} with latest state..."
                                runPhasePlan(phase, phaseDirs)

                                // Phase 8 apply Ï†ÑÏóê Backend cleanup Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
                                if (phase.id == 'phase8') {
                                    echo "üßπ Running backend cleanup script before Phase 8 apply..."
                                    phase.dirs.each { dir ->
                                        def cleanupScript = "${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/cleanup_backends.sh"
                                        def scriptExists = sh(
                                            script: "test -f '${cleanupScript}' && echo 'EXISTS' || echo 'NOT_FOUND'",
                                            returnStdout: true
                                        ).trim()

                                        if (scriptExists == 'EXISTS') {
                                            echo "  Running cleanup for ${dir}..."
                                            sh "cd '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}' && bash cleanup_backends.sh"
                                        } else {
                                            echo "  ‚ö†Ô∏è  No cleanup script found for ${dir} (expected at ${cleanupScript})"
                                        }
                                    }
                                    echo "‚úÖ Backend cleanup completed"
                                }

                                echo "üöÄ Applying ${phase.label}..."
                                runPhaseApply(phase, phaseDirs)
                            } else {
                                echo "üóëÔ∏è  Destroying ${phase.label}..."
                                runPhaseDestroy(phase, phaseDirs)
                            }
                        }

                        // Phase 1 Ïù¥ÌõÑ API Propagation ÎåÄÍ∏∞
                        if (phase.id == 'phase1' && params.ACTION == 'apply') {
                            stage('Wait for API Propagation') {
                                echo '‚è≥ Waiting for GCP API propagation (120 seconds)...'
                                sleep(time: 120, unit: 'SECONDS')
                                echo '‚úÖ API propagation wait completed'
                            }
                        }


                        // Phase 6 (Database & Cache) ÏÇ≠Ï†ú ÌõÑ PSC Connection Ï†ïÎ¶¨ ÎåÄÍ∏∞
                        if (phase.id == 'phase6' && params.ACTION == 'destroy') {
                            stage('Wait for PSC Cleanup') {
                                echo '‚è≥ Waiting for Memorystore PSC connections cleanup...'
                                script {
                                    def maxRetries = 12
                                    def retryCount = 0
                                    def pscCleanedUp = false

                                    // ‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Redis ÌÅ¥Îü¨Ïä§ÌÑ∞Î™ÖÍ≥º ÌîÑÎ°úÏ†ùÌä∏ID ÏàòÏ†ï ÌïÑÏöî
                                    def redisClusterName = "YOUR_REDIS_CLUSTER_NAME"  // e.g., "gcby-prod-redis"
                                    def projectId = "YOUR_PROJECT_ID"  // e.g., "gcp-gcby"
                                    def pscPolicyName = "YOUR_PSC_POLICY_NAME"  // e.g., "gcby-prod-vpc-asia-northeast3-redis-psc"
                                    def region = "asia-northeast3"

                                    while (!pscCleanedUp && retryCount < maxRetries) {
                                        try {
                                            def pscConnections = sh(
                                                script: """
                                                    gcloud network-connectivity service-connection-policies describe \
                                                        ${pscPolicyName} \
                                                        --project=${projectId} \
                                                        --region=${region} \
                                                        --format='value(pscConnections)' 2>&1 || echo "POLICY_NOT_FOUND"
                                                """,
                                                returnStdout: true
                                            ).trim()

                                            if (pscConnections == "POLICY_NOT_FOUND" || pscConnections == "" || pscConnections == "[]") {
                                                echo "‚úÖ PSC connections cleared or policy already deleted"
                                                pscCleanedUp = true
                                            } else {
                                                retryCount++
                                                echo "‚è≥ PSC connections still exist (attempt ${retryCount}/${maxRetries}). Waiting 30 seconds..."
                                                sleep(time: 30, unit: 'SECONDS')
                                            }
                                        } catch (Exception e) {
                                            echo "‚ö†Ô∏è  Could not check PSC status (policy may be deleted): ${e.message}"
                                            pscCleanedUp = true
                                        }
                                    }

                                    if (!pscCleanedUp) {
                                        echo "‚ö†Ô∏è  PSC connections still exist after ${maxRetries} attempts (6 minutes)"
                                        echo "Proceeding anyway - Network destroy may fail and require retry"
                                    } else {
                                        echo '‚úÖ PSC cleanup wait completed'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan - Single Layer') {
            when {
                expression { params.TARGET_LAYER != 'all' }
            }
            steps {
                script {
                    echo 'üìã Running Terragrunt Plan...'
                    sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' plan -out=tfplan"
                    archiveArtifacts artifacts: "**/${params.TARGET_LAYER}/**/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    echo 'üëÄ Plan Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                    echo "‚ö†Ô∏è  ${params.TARGET_LAYER} Î†àÏù¥Ïñ¥Ïóê ÎåÄÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏûÖÎãàÎã§!"
                }
            }
        }

        stage('üõë Approval - Single Layer üõë') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    ‚ö†Ô∏è  Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω ÏäπÏù∏ ÌïÑÏöî ‚ö†Ô∏è

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ÏúÑ PlanÏùÑ Í≤ÄÌÜ†Ìïú ÌõÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: '‚úÖ ÏäπÏù∏ (Apply Ïã§Ìñâ)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        // Phase 7 (70-loadbalancers/*) apply Ï†ÑÏóê Backend cleanup Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
                        if (params.TARGET_LAYER.startsWith('70-loadbalancers/')) {
                            echo "üßπ Running backend cleanup script before ${params.TARGET_LAYER} apply..."
                            def cleanupScript = "${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/cleanup_backends.sh"
                            def scriptExists = sh(
                                script: "test -f '${cleanupScript}' && echo 'EXISTS' || echo 'NOT_FOUND'",
                                returnStdout: true
                            ).trim()

                            if (scriptExists == 'EXISTS') {
                                sh "cd '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' && bash cleanup_backends.sh"
                                echo "‚úÖ Backend cleanup completed"
                            } else {
                                echo "‚ö†Ô∏è  No cleanup script found (expected at ${cleanupScript})"
                            }
                        }

                        echo 'üöÄ Applying Terragrunt changes...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'üóëÔ∏è  Destroying Terragrunt resources...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' destroy -auto-approve"
                    }
                }
            }
        }

    }

    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo '‚ùå Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'üßπ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan*" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'üèÅ Pipeline finished'
        }
    }
}

// Phase Plan Ïã§Ìñâ
def runPhasePlan(phase, phaseDirs) {
    // Í≥µÎ∞±/ÌäπÏàòÎ¨∏ÏûêÍ∞Ä ÏûàÎäî WORKSPACE Í≤ΩÎ°ú Î¨∏Ï†ú ÌöåÌîºÎ•º ÏúÑÌï¥ ÎîîÎ†âÌÜ†Î¶¨ Ïù¥Îèô ÌõÑ ÏÉÅÎåÄÍ≤ΩÎ°ú ÏÇ¨Ïö©
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"

    phase.dirs.each { dir ->
        sh """
            rm -rf '${workDir}/${dir}/.terragrunt-cache' || true
            rm -rf '${workDir}/${dir}/.terraform' || true
            rm -f '${workDir}/${dir}/tfplan-${phase.id}' || true
        """
    }

    // ÏÉÅÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö©: working-dirÎ°ú Ïù¥Îèô ÌõÑ ÏÉÅÎåÄ Í≤ΩÎ°úÎ°ú include
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')
    sh """
        cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- plan -out=tfplan-${phase.id}
    """

    archiveArtifacts artifacts: "**/tfplan-${phase.id}", allowEmptyArchive: true
}

// Phase Apply Ïã§Ìñâ
def runPhaseApply(phase, phaseDirs) {
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')
    sh """
        cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- apply tfplan-${phase.id}
    """
}

// Phase Destroy Ïã§Ìñâ
def runPhaseDestroy(phase, phaseDirs) {
    def workDir = "${env.WORKSPACE}/${TG_WORKING_DIR}"
    def includeArgs = phase.dirs.collect { "--queue-include-dir ./${it}" }.join(' ')

    // Phase 6 (Database & Cache)Ïùò Í≤ΩÏö∞ deletion protection Î®ºÏ†Ä ÎπÑÌôúÏÑ±Ìôî
    if (phase.id == 'phase6') {
        echo 'üîì Disabling deletion protection for Redis cluster...'

        // ‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Redis ÌÅ¥Îü¨Ïä§ÌÑ∞Î™ÖÍ≥º ÌîÑÎ°úÏ†ùÌä∏ID ÏàòÏ†ï ÌïÑÏöî
        def redisClusterName = "YOUR_REDIS_CLUSTER_NAME"  // e.g., "gcby-prod-redis"
        def projectId = "YOUR_PROJECT_ID"  // e.g., "gcp-gcby"
        def region = "asia-northeast3"

        // Step 1: Check if Redis cluster exists and has deletion protection
        def redisExists = sh(
            script: """
                gcloud redis clusters describe ${redisClusterName} \
                    --region=${region} \
                    --project=${projectId} \
                    --format='value(name)' 2>/dev/null || echo "NOT_FOUND"
            """,
            returnStdout: true
        ).trim()

        if (redisExists != "NOT_FOUND") {
            echo "Redis cluster found. Disabling deletion protection via gcloud..."

            // Use gcloud to disable deletion protection
            sh """
                gcloud redis clusters update ${redisClusterName} \
                    --region=${region} \
                    --project=${projectId} \
                    --no-deletion-protection \
                    --quiet || echo "Warning: Could not disable deletion protection"
            """

            echo "Waiting 10 seconds for changes to propagate..."
            sleep(time: 10, unit: 'SECONDS')
        } else {
            echo "Redis cluster not found or already deleted. Skipping deletion protection step."
        }
    }

    // Phase 2 (network)Ïùò Í≤ΩÏö∞ PSC Ïó∞Í≤∞ ÏÇ≠Ï†ú ÏóêÎü¨ Î∞úÏÉù Ïãú Ïû¨ÏãúÎèÑ
    if (phase.id == 'phase2') {
        retry(3) {
            try {
                sh """
                    cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- destroy -auto-approve
                """
            } catch (Exception e) {
                if (e.message.contains("ServiceConnectionPolicy") && e.message.contains("PSC Connections")) {
                    echo "‚ö†Ô∏è  PSC connections still exist. Waiting 60 seconds before retry..."
                    sleep(time: 60, unit: 'SECONDS')
                    throw e
                } else {
                    throw e
                }
            }
        }
    } else {
        sh """
            cd '${workDir}' && terragrunt run --all ${includeArgs} --queue-strict-include -- destroy -auto-approve
        """
    }
}
