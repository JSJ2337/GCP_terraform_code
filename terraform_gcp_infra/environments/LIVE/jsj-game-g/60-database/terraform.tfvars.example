# Terragrunt entrypoint: environments/LIVE/proj-default-templet/60-database/terragrunt.hcl
# Cloud SQL(MySQL) 배포 예시
# 1) terraform.tfvars로 복사 후 값 수정
# 2) Secret Manager 등 안전한 위치에 비밀번호를 보관하세요.

project_id = "your-project-id"

# 인스턴스 기본 설정 (region은 비워두면 Terragrunt가 region_primary 사용)
instance_name     = ""                # 비워두면 naming 모듈 기준으로 자동 생성
region            = ""
database_version  = "MYSQL_8_0"
tier              = "db-n1-standard-1"
availability_type = "REGIONAL"        # 운영 기본값, 개발/테스트 시 ZONAL로 조정

# 디스크
disk_size       = 20
disk_type       = "PD_SSD"
disk_autoresize = true

# 삭제 보호 (프로덕션 권장)
deletion_protection = true            # 운영 기본값, 삭제 테스트 시에만 false 고려

# 백업
backup_enabled                 = true
backup_start_time              = "03:00"
binary_log_enabled             = true
transaction_log_retention_days = 7
backup_retained_count          = 7

# 네트워크
ipv4_enabled    = false  # Private IP 권장
# 비워두면 modules/naming이 생성한 VPC(self link)가 자동으로 사용됩니다.
private_network = ""

# 공개 IP 사용 시 허용 CIDR (옵션)
# authorized_networks = [
#   { name = "office", cidr = "203.0.113.0/24" }
# ]

# 유지보수 창
maintenance_window_day          = 7   # 일요일
maintenance_window_hour         = 3   # 03:00
maintenance_window_update_track = "stable"

# DB 플래그 (필요 시 추가)
database_flags = [
  {
    name  = "max_connections"
    value = "100"
  }
]

# Query Insights
query_insights_enabled  = true
query_string_length     = 1024
record_application_tags = false

# 로깅
enable_slow_query_log = true
slow_query_log_time   = 2
enable_general_log    = false
log_output            = "FILE"  # Cloud Logging 전달

# 초기 데이터베이스
databases = [
  { name = "myapp" }
]

# 초기 사용자 (비밀번호는 Secret Manager로 관리하세요)
users = [
  {
    name     = "app_user"
    password = "CHANGE-ME-secure-password"
    host     = "%"
  }
]

# 읽기 복제본 (옵션)
# read_replicas = {
#   replica1 = {
#     name   = "default-templet-mysql-read-1"
#     region = "us-central1"
#     tier   = "db-n1-standard-1"
#   }
# }

# 공통 라벨 (naming 모듈 라벨과 병합됨)
labels = {
  environment = "prod"
  project     = "default-templet"
  managed_by  = "terraform"
  tier        = "database"
}
