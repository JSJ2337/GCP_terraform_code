// ============================================================================
// Phase ì •ì˜: ë ˆì´ì–´ë³„ ì˜ì¡´ì„±ì„ ê³ ë ¤í•œ ìˆœì°¨ ì‹¤í–‰ êµ¬ì¡°
// ============================================================================
def PHASES = [
    [id: 'phase1', label: 'Phase 1 - Bootstrap (00-project)', dirs: ['00-project'], optional: false],
    [id: 'phase2', label: 'Phase 2 - Network (10-network)', dirs: ['10-network'], optional: false],
    [id: 'phase3', label: 'Phase 3 - Storage & Security', dirs: ['20-storage', '30-security'], optional: false],
    [id: 'phase4', label: 'Phase 4 - Observability', dirs: ['40-observability'], optional: true],
    [id: 'phase5', label: 'Phase 5 - Workloads (50-workloads)', dirs: ['50-workloads'], optional: false],
    [id: 'phase6', label: 'Phase 6 - Database & Cache', dirs: ['60-database', '65-cache'], optional: false],
    [id: 'phase7', label: 'Phase 7 - Load Balancers', dirs: ['70-loadbalancers/web', '70-loadbalancers/app', '70-loadbalancers/lobby'], optional: false],
    [id: 'phase8', label: 'Phase 8 - DNS', dirs: ['75-dns'], optional: false]
]

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // Terragrunt ì‘ì—… ë””ë ‰í„°ë¦¬ (í™˜ê²½ ë£¨íŠ¸)
        TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/jsj-game-n'
        // ë°˜ë³µ ë‹¤ìš´ë¡œë“œë¥¼ ì¤„ì—¬ provider ì„¤ì¹˜ ì‹¤íŒ¨ë¥¼ ì˜ˆë°©
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP ì¸ì¦ ì„¤ì • (Jenkins Credential ì‚¬ìš©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Terragrunt ì‹¤í–‰í•  ì‘ì—… ì„ íƒ'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancers/web',
                '70-loadbalancers/app',
                '70-loadbalancers/lobby',
                '75-dns'
            ],
            description: 'ì‹¤í–‰í•  ë ˆì´ì–´ (all = ì „ì²´ ìŠ¤íƒ)'
        )
        booleanParam(
            name: 'ENABLE_OBSERVABILITY',
            defaultValue: true,
            description: '40-observability ë ˆì´ì–´ í¬í•¨ ì—¬ë¶€'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "âœ… Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'ğŸ”§ Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            // Clean cache files using absolute path
                            sh """
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan*" -type f -delete || true
                            """

                            // Run terragrunt run --all init with working-dir flag
                            sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init"
                        } else {
                            // Single layer init
                            sh """
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terragrunt-cache' || true
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/tfplan' || true
                            """
                            sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' init"
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Phase ê¸°ë°˜ ìˆœì°¨ ì‹¤í–‰ (TARGET_LAYER == 'all')
        // ====================================================================
        stage('Phased Deployment') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase ì²˜ë¦¬ (apply/plan ì‹œì—ë§Œ skip, destroyëŠ” í•­ìƒ ì‹¤í–‰)
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "â­ï¸  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Phase 1 ì´í›„ API Propagation ëŒ€ê¸°
                        if (phase.id == 'phase1' && params.ACTION == 'apply') {
                            stage("${phase.label} - Plan") {
                                echo "ğŸ“‹ Planning ${phase.label}..."
                                runPhasePlan(phase, phaseDirs)
                            }
                            if (params.ACTION == 'apply') {
                                stage("${phase.label} - Approval") {
                                    waitForApproval(phase)
                                }
                                stage("${phase.label} - Apply") {
                                    echo "ğŸš€ Applying ${phase.label}..."
                                    runPhaseApply(phase, phaseDirs)
                                }
                                stage('Wait for API Propagation') {
                                    echo 'â³ Waiting for GCP API propagation (120 seconds)...'
                                    sleep(time: 120, unit: 'SECONDS')
                                    echo 'âœ… API propagation wait completed'
                                }
                            }
                        } else {
                            // ì¼ë°˜ Phase ì‹¤í–‰
                            stage("${phase.label} - Plan") {
                                echo "ğŸ“‹ Planning ${phase.label}..."
                                runPhasePlan(phase, phaseDirs)
                            }
                            if (params.ACTION == 'apply' || params.ACTION == 'destroy') {
                                stage("${phase.label} - Approval") {
                                    waitForApproval(phase)
                                }
                                stage("${phase.label} - ${params.ACTION.capitalize()}") {
                                    if (params.ACTION == 'apply') {
                                        echo "ğŸš€ Applying ${phase.label}..."
                                        runPhaseApply(phase, phaseDirs)
                                    } else {
                                        echo "ğŸ—‘ï¸  Destroying ${phase.label}..."
                                        runPhaseDestroy(phase, phaseDirs)
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan - Single Layer') {
            when {
                expression { params.TARGET_LAYER != 'all' }
            }
            steps {
                script {
                    echo 'ğŸ“‹ Running Terragrunt Plan...'
                    sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' plan -out=tfplan"
                    archiveArtifacts artifacts: "**/${params.TARGET_LAYER}/**/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    echo 'ğŸ‘€ Plan ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                    echo "âš ï¸  ${params.TARGET_LAYER} ë ˆì´ì–´ì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤!"
                }
            }
        }

        stage('ğŸ›‘ Approval - Single Layer ğŸ›‘') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    âš ï¸  ì¸í”„ë¼ ë³€ê²½ ìŠ¹ì¸ í•„ìš” âš ï¸

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'âœ… ìŠ¹ì¸ (Apply ì‹¤í–‰)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'ğŸš€ Applying Terragrunt changes...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'ğŸ—‘ï¸  Destroying Terragrunt resources...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' destroy -auto-approve"
                    }
                }
            }
        }

    }

    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo 'âŒ Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'ğŸ§¹ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan*" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'ğŸ Pipeline finished'
        }
    }
}

// Phase Plan ì‹¤í–‰
def runPhasePlan(phase, phaseDirs) {
    phase.dirs.each { dir ->
        sh """
            rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/.terragrunt-cache' || true
            rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/.terraform' || true
            rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/tfplan-${phase.id}' || true
        """
    }

    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')
    sh "terragrunt run --all ${includeArgs} --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- plan -out=tfplan-${phase.id}"

    archiveArtifacts artifacts: "**/tfplan-${phase.id}", allowEmptyArchive: true
}

// Phase Apply ì‹¤í–‰
def runPhaseApply(phase, phaseDirs) {
    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')
    sh "terragrunt run --all ${includeArgs} --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- apply tfplan-${phase.id}"
}

// Phase Destroy ì‹¤í–‰
def runPhaseDestroy(phase, phaseDirs) {
    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')
    sh "terragrunt run --all ${includeArgs} --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- destroy -auto-approve"
}

// Phase Approval ëŒ€ê¸°
def waitForApproval(phase) {
    def approvalMessage = """
    âš ï¸  ${phase.label} ìŠ¹ì¸ í•„ìš” âš ï¸

    Action: ${params.ACTION.toUpperCase()}
    Target: ${phase.dirs.join(', ')}
    Branch: ${env.GIT_BRANCH}
    Commit: ${env.GIT_COMMIT}

    ìœ„ Planì„ ê²€í† í•œ í›„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    """

    timeout(time: 30, unit: 'MINUTES') {
        input(
            message: approvalMessage,
            ok: "âœ… ìŠ¹ì¸ (${params.ACTION.capitalize()} ì‹¤í–‰)",
            submitter: 'admin'
        )
    }
}
