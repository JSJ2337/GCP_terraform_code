// ============================================================================
// Phase Ï†ïÏùò: Î†àÏù¥Ïñ¥Î≥Ñ ÏùòÏ°¥ÏÑ±ÏùÑ Í≥†Î†§Ìïú ÏàúÏ∞® Ïã§Ìñâ Íµ¨Ï°∞
// ============================================================================
def PHASES = [
    [id: 'phase1', label: 'Phase 1 - Bootstrap (00-project)', dirs: ['00-project'], optional: false],
    [id: 'phase2', label: 'Phase 2 - Network (10-network)', dirs: ['10-network'], optional: false],
    [id: 'phase3', label: 'Phase 3 - Storage & Security', dirs: ['20-storage', '30-security'], optional: false],
    [id: 'phase4', label: 'Phase 4 - Observability', dirs: ['40-observability'], optional: true],
    [id: 'phase5', label: 'Phase 5 - Workloads (50-workloads)', dirs: ['50-workloads'], optional: false],
    [id: 'phase6', label: 'Phase 6 - Database & Cache', dirs: ['60-database', '65-cache'], optional: false],
    [id: 'phase7', label: 'Phase 7 - Load Balancers', dirs: ['70-loadbalancers/web', '70-loadbalancers/app', '70-loadbalancers/lobby'], optional: false],
    [id: 'phase8', label: 'Phase 8 - DNS', dirs: ['75-dns'], optional: false]
]

pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TG_NON_INTERACTIVE = 'true'
        // Terragrunt ÏûëÏóÖ ÎîîÎ†âÌÑ∞Î¶¨ (ÌôòÍ≤Ω Î£®Ìä∏)
        TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/jsj-game-n'
        // Î∞òÎ≥µ Îã§Ïö¥Î°úÎìúÎ•º Ï§ÑÏó¨ provider ÏÑ§Ïπò Ïã§Ìå®Î•º ÏòàÎ∞©
        TF_PLUGIN_CACHE_DIR = "${env.WORKSPACE}/.terraform.d/plugin-cache"
        // GCP Ïù∏Ï¶ù ÏÑ§Ï†ï (Jenkins Credential ÏÇ¨Ïö©)
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-jenkins-service-account')
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy', 'prepare-destroy'],
            description: 'Terragrunt Ïã§ÌñâÌï† ÏûëÏóÖ ÏÑ†ÌÉù (prepare-destroy: Phase 7Îßå applyÌï¥ÏÑú cleanup resource Ï∂îÍ∞Ä)'
        )
        choice(
            name: 'TARGET_LAYER',
            choices: [
                'all',
                '00-project',
                '10-network',
                '20-storage',
                '30-security',
                '40-observability',
                '50-workloads',
                '60-database',
                '65-cache',
                '70-loadbalancers/web',
                '70-loadbalancers/app',
                '70-loadbalancers/lobby',
                '75-dns'
            ],
            description: 'Ïã§ÌñâÌï† Î†àÏù¥Ïñ¥ (all = Ï†ÑÏ≤¥ Ïä§ÌÉù)'
        )
        booleanParam(
            name: 'ENABLE_OBSERVABILITY',
            defaultValue: true,
            description: '40-observability Î†àÏù¥Ïñ¥ Ìè¨Ìï® Ïó¨Î∂Ä'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                script {
                    def shortCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "‚úÖ Repository checked out"
                    echo "Branch: ${env.BRANCH_NAME ?: env.GIT_BRANCH}"
                    echo "Commit: ${shortCommit}"
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo 'üîç Checking tools...'
                sh '''
                    terraform --version
                    terragrunt --version
                    git --version
                '''
            }
        }

        stage('Terragrunt Init') {
            steps {
                script {
                    sh "mkdir -p '${env.TF_PLUGIN_CACHE_DIR}'"
                    echo 'üîß Initializing Terragrunt...'
                    retry(3) {
                        if (params.TARGET_LAYER == 'all') {
                            // Clean cache files using absolute path
                            sh """
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -type d -name ".terraform" -prune -exec rm -rf {} + || true
                                find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name "tfplan*" -type f -delete || true
                            """

                            // Run terragrunt run --all init with working-dir flag
                            sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init"
                        } else {
                            // Single layer init
                            sh """
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terragrunt-cache' || true
                                rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/.terraform' || true
                                rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}/tfplan' || true
                            """
                            sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' init"
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Phase Í∏∞Î∞ò ÏàúÏ∞® Ïã§Ìñâ (TARGET_LAYER == 'all')
        // Step 1: Î™®Îì† Phase Plan Ïã§Ìñâ
        // ====================================================================
        stage('Plan All Phases') {
            when {
                expression { params.TARGET_LAYER == 'all' }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase Ï≤òÎ¶¨ (apply/plan ÏãúÏóêÎßå skip, destroyÎäî Ìï≠ÏÉÅ Ïã§Ìñâ)
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "‚è≠Ô∏è  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        stage("${phase.label} - Plan") {
                            echo "üìã Planning ${phase.label}..."
                            runPhasePlan(phase, phaseDirs)
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Step 2: Ï†ÑÏ≤¥ ÏäπÏù∏ (Ìïú Î≤àÎßå)
        // ====================================================================
        stage('üõë Approve All Phases üõë') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES
                    def phaseList = orderedPhases.collect { phase ->
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            return null
                        }
                        return "  - ${phase.label}: ${phase.dirs.join(', ')}"
                    }.findAll { it != null }.join('\n')

                    def approvalMessage = """
                    ‚ö†Ô∏è  Ï†ÑÏ≤¥ Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω ÏäπÏù∏ ÌïÑÏöî ‚ö†Ô∏è

                    Action: ${params.ACTION.toUpperCase()}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    Ïã§ÌñâÎê† Phase Î™©Î°ù:
${phaseList}

                    Î™®Îì† PhaseÏùò PlanÏùÑ Í≤ÄÌÜ†Ìïú ÌõÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    ÏäπÏù∏ Ïãú Î™®Îì† PhaseÍ∞Ä ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: "‚úÖ Ï†ÑÏ≤¥ ÏäπÏù∏ (${params.ACTION.capitalize()} ÏàúÏ∞® Ïã§Ìñâ)",
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        // ====================================================================
        // Prepare Destroy: Phase 7Îßå applyÌï¥ÏÑú cleanup resource Ï∂îÍ∞Ä
        // ====================================================================
        stage('Prepare for Destroy') {
            when {
                allOf {
                    expression { params.ACTION == 'prepare-destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def phase7 = PHASES.find { it.id == 'phase7' }

                    stage("${phase7.label} - Apply Cleanup Resources") {
                        echo "üìã Phase 7Îßå applyÌï¥ÏÑú null_resource.backend_cleanupÏùÑ stateÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§..."
                        echo "‚ö†Ô∏è  Ï∞∏Í≥†: Ïù¥ Îã®Í≥ÑÎäî Terraform GCP Provider Î≤ÑÍ∑∏ ÏõåÌÅ¨Ïñ¥ÎùºÏö¥ÎìúÏûÖÎãàÎã§."
                        echo "‚ö†Ô∏è  null_resource provisionerÎäî stateÏóê ÏûàÏñ¥Ïïº destroy Ïãú Ïã§ÌñâÎê©ÎãàÎã§."

                        def includeArgs = phase7.dirs.collect {
                            "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Plan
                        echo "üìã Planning Phase 7..."
                        sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- plan -out=tfplan-prepare-destroy"

                        // Apply
                        echo "üöÄ Applying Phase 7 (cleanup resources only)..."
                        sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- apply tfplan-prepare-destroy"

                        echo "‚úÖ Phase 7 cleanup resources added to Terraform state"
                        echo "‚úÖ Ïù¥Ï†ú 'destroy' Ïï°ÏÖòÏùÑ Ïã§ÌñâÌïòÎ©¥ Backend ServiceÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ïÎ¶¨Îê©ÎãàÎã§."
                    }
                }
            }
        }

        // ====================================================================
        // Step 3: ÏäπÏù∏ ÌõÑ Î™®Îì† Phase Re-plan Î∞è Apply/Destroy ÏàúÏ∞® Ïã§Ìñâ
        // Í∞Å Phase apply ÏßÅÏ†ÑÏóê fresh planÏùÑ ÏÉùÏÑ±ÌïòÏó¨ stale plan Î¨∏Ï†ú Î∞©ÏßÄ
        // ====================================================================
        stage('Execute All Phases') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER == 'all' }
                }
            }
            steps {
                script {
                    def orderedPhases = params.ACTION == 'destroy' ? PHASES.reverse() : PHASES

                    orderedPhases.each { phase ->
                        // Optional phase Ï≤òÎ¶¨
                        if (phase.optional && phase.id == 'phase4' && !params.ENABLE_OBSERVABILITY && params.ACTION != 'destroy') {
                            echo "‚è≠Ô∏è  Skipping ${phase.label} (disabled by parameter)"
                            return
                        }

                        def phaseDirs = phase.dirs.collect {
                            "'${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'"
                        }.join(' ')

                        // Phase Ïã§Ìñâ: Re-plan ‚Üí Apply/Destroy
                        stage("${phase.label} - Replan & ${params.ACTION.capitalize()}") {
                            if (params.ACTION == 'apply') {
                                echo "üìã Re-planning ${phase.label} with latest state..."
                                runPhasePlan(phase, phaseDirs)
                                echo "üöÄ Applying ${phase.label}..."
                                runPhaseApply(phase, phaseDirs)
                            } else {
                                echo "üóëÔ∏è  Destroying ${phase.label}..."
                                runPhaseDestroy(phase, phaseDirs)
                            }
                        }

                        // Phase 1 Ïù¥ÌõÑ API Propagation ÎåÄÍ∏∞
                        if (phase.id == 'phase1' && params.ACTION == 'apply') {
                            stage('Wait for API Propagation') {
                                echo '‚è≥ Waiting for GCP API propagation (120 seconds)...'
                                sleep(time: 120, unit: 'SECONDS')
                                echo '‚úÖ API propagation wait completed'
                            }
                        }


                        // Phase 6 (Database & Cache) ÏÇ≠Ï†ú ÌõÑ PSC Connection Ï†ïÎ¶¨ ÎåÄÍ∏∞
                        if (phase.id == 'phase6' && params.ACTION == 'destroy') {
                            stage('Wait for PSC Cleanup') {
                                echo '‚è≥ Waiting for Memorystore PSC connections cleanup...'
                                script {
                                    def maxRetries = 12
                                    def retryCount = 0
                                    def pscCleanedUp = false

                                    while (!pscCleanedUp && retryCount < maxRetries) {
                                        try {
                                            def pscConnections = sh(
                                                script: """
                                                    gcloud network-connectivity service-connection-policies describe \
                                                        game-n-prod-vpc-asia-northeast3-redis-psc \
                                                        --project=jsj-game-n \
                                                        --region=asia-northeast3 \
                                                        --format='value(pscConnections)' 2>&1 || echo "POLICY_NOT_FOUND"
                                                """,
                                                returnStdout: true
                                            ).trim()

                                            if (pscConnections == "POLICY_NOT_FOUND" || pscConnections == "" || pscConnections == "[]") {
                                                echo "‚úÖ PSC connections cleared or policy already deleted"
                                                pscCleanedUp = true
                                            } else {
                                                retryCount++
                                                echo "‚è≥ PSC connections still exist (attempt ${retryCount}/${maxRetries}). Waiting 30 seconds..."
                                                sleep(time: 30, unit: 'SECONDS')
                                            }
                                        } catch (Exception e) {
                                            echo "‚ö†Ô∏è  Could not check PSC status (policy may be deleted): ${e.message}"
                                            pscCleanedUp = true
                                        }
                                    }

                                    if (!pscCleanedUp) {
                                        echo "‚ö†Ô∏è  PSC connections still exist after ${maxRetries} attempts (6 minutes)"
                                        echo "Proceeding anyway - Network destroy may fail and require retry"
                                    } else {
                                        echo '‚úÖ PSC cleanup wait completed'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Terragrunt Plan - Single Layer') {
            when {
                expression { params.TARGET_LAYER != 'all' }
            }
            steps {
                script {
                    echo 'üìã Running Terragrunt Plan...'
                    sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' plan -out=tfplan"
                    archiveArtifacts artifacts: "**/${params.TARGET_LAYER}/**/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('Review Plan - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    echo 'üëÄ Plan Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî!'
                    echo "Action: ${params.ACTION}"
                    echo "Target: ${params.TARGET_LAYER}"
                    echo "‚ö†Ô∏è  ${params.TARGET_LAYER} Î†àÏù¥Ïñ¥Ïóê ÎåÄÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏûÖÎãàÎã§!"
                }
            }
        }

        stage('üõë Approval - Single Layer üõë') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    def approvalMessage = """
                    ‚ö†Ô∏è  Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω ÏäπÏù∏ ÌïÑÏöî ‚ö†Ô∏è

                    Action: ${params.ACTION.toUpperCase()}
                    Target: ${params.TARGET_LAYER}
                    Branch: ${env.GIT_BRANCH}
                    Commit: ${env.GIT_COMMIT}

                    ÏúÑ PlanÏùÑ Í≤ÄÌÜ†Ìïú ÌõÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    """

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: '‚úÖ ÏäπÏù∏ (Apply Ïã§Ìñâ)',
                            submitter: 'admin'
                        )
                    }
                }
            }
        }

        stage('Apply/Destroy - Single Layer') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' || params.ACTION == 'destroy' }
                    expression { params.TARGET_LAYER != 'all' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'apply') {
                        echo 'üöÄ Applying Terragrunt changes...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' apply tfplan"
                    } else if (params.ACTION == 'destroy') {
                        echo 'üóëÔ∏è  Destroying Terragrunt resources...'
                        sh "terragrunt --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${params.TARGET_LAYER}' destroy -auto-approve"
                    }
                }
            }
        }

    }

    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "Action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        failure {
            echo '‚ùå Pipeline failed!'
            echo "Failed at action: ${params.ACTION}"
            echo "Target: ${params.TARGET_LAYER}"
        }
        always {
            echo 'üßπ Cleaning up plan/cache files...'
            sh '''
                find . -name "tfplan*" -type f -delete || true
                find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} + || true
                find . -type d -name ".terraform" -prune -exec rm -rf {} + || true
            '''
            echo 'üèÅ Pipeline finished'
        }
    }
}

// Phase Plan Ïã§Ìñâ
def runPhasePlan(phase, phaseDirs) {
    phase.dirs.each { dir ->
        sh """
            rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/.terragrunt-cache' || true
            rm -rf '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/.terraform' || true
            rm -f '${env.WORKSPACE}/${TG_WORKING_DIR}/${dir}/tfplan-${phase.id}' || true
        """
    }

    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')
    sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- plan -out=tfplan-${phase.id}"

    archiveArtifacts artifacts: "**/tfplan-${phase.id}", allowEmptyArchive: true
}

// Phase Apply Ïã§Ìñâ
def runPhaseApply(phase, phaseDirs) {
    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')
    sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- apply tfplan-${phase.id}"
}

// Phase Destroy Ïã§Ìñâ
def runPhaseDestroy(phase, phaseDirs) {
    def includeArgs = phase.dirs.collect { "--queue-include-dir '${env.WORKSPACE}/${TG_WORKING_DIR}/${it}'" }.join(' ')

    // Phase 6 (Database & Cache)Ïùò Í≤ΩÏö∞ deletion protection Î®ºÏ†Ä ÎπÑÌôúÏÑ±Ìôî
    if (phase.id == 'phase6') {
        echo 'üîì Disabling deletion protection for Redis cluster...'

        // Step 1: Check if Redis cluster exists and has deletion protection
        def redisExists = sh(
            script: """
                gcloud redis clusters describe game-n-prod-redis \
                    --region=asia-northeast3 \
                    --project=jsj-game-n \
                    --format='value(name)' 2>/dev/null || echo "NOT_FOUND"
            """,
            returnStdout: true
        ).trim()

        if (redisExists != "NOT_FOUND") {
            echo "Redis cluster found. Disabling deletion protection via gcloud..."

            // Use gcloud to disable deletion protection
            sh """
                gcloud redis clusters update game-n-prod-redis \
                    --region=asia-northeast3 \
                    --project=jsj-game-n \
                    --no-deletion-protection \
                    --quiet || echo "Warning: Could not disable deletion protection"
            """

            echo "Waiting 10 seconds for changes to propagate..."
            sleep(time: 10, unit: 'SECONDS')
        } else {
            echo "Redis cluster not found or already deleted. Skipping deletion protection step."
        }
    }

    // Phase 2 (network)Ïùò Í≤ΩÏö∞ PSC Ïó∞Í≤∞ ÏÇ≠Ï†ú ÏóêÎü¨ Î∞úÏÉù Ïãú Ïû¨ÏãúÎèÑ
    if (phase.id == 'phase2') {
        retry(3) {
            try {
                sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- destroy -auto-approve"
            } catch (Exception e) {
                if (e.message.contains("ServiceConnectionPolicy") && e.message.contains("PSC Connections")) {
                    echo "‚ö†Ô∏è  PSC connections still exist. Waiting 60 seconds before retry..."
                    sleep(time: 60, unit: 'SECONDS')
                    throw e
                } else {
                    throw e
                }
            }
        }
    } else {
        sh "terragrunt run --all ${includeArgs} --queue-strict-include --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- destroy -auto-approve"
    }
}
