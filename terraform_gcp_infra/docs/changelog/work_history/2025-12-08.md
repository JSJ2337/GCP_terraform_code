# 2025-12-08 작업 내역

## 주요 작업

### 1. gcp-web3/gcp-gcby Instance Group 생성 문제 해결

**문제**: Jenkins apply 후에도 Instance Groups가 생성되지 않음

**근본 원인**: `terraform.tfvars`의 빈 값이 terragrunt inputs를 덮어씀
- `instance_groups = {}` → terragrunt에서 주입한 값 무시
- `firewall_rules = []` → 방화벽 규칙 생성 안됨

**해결**:
- 70-loadbalancers/*/terraform.tfvars에서 `instance_groups = {}` 제거
- 10-network/terraform.tfvars에서 `firewall_rules = []` 제거
- 주석으로 terragrunt.hcl에서 동적 주입됨을 명시

**적용 파일**:
```
environments/LIVE/gcp-web3/70-loadbalancers/www/terraform.tfvars
environments/LIVE/gcp-web3/70-loadbalancers/mint/terraform.tfvars
environments/LIVE/gcp-gcby/70-loadbalancers/gs/terraform.tfvars
environments/LIVE/gcp-web3/10-network/terraform.tfvars
environments/LIVE/gcp-gcby/10-network/terraform.tfvars
proj-default-templet/70-loadbalancers/gs/terraform.tfvars
proj-default-templet/10-network/terraform.tfvars
```

### 2. gcp-gcby Instance Group Subnet 불일치 해결

**문제**: Instance Group이 잘못된 subnet으로 생성됨
- 기존: `gcby-subnet-private`
- 올바른 값: `gcby-live-subnet-private`

**해결**:
1. Backend Service에서 Instance Group 연결 해제
2. 잘못된 Instance Groups 삭제 (gcby-gs-ig-a, gcby-gs-ig-b)
3. Jenkins apply로 올바른 subnet으로 재생성

### 3. 70-loadbalancers에 instance_group_ids output 추가

**변경**: Instance Group self-link를 output으로 노출
```hcl
output "instance_group_ids" {
  description = "생성된 Instance Group self-link 맵"
  value       = { for k, v in google_compute_instance_group.lb_instance_group : k => v.self_link }
}
```

**적용 파일**:
- gcp-web3/70-loadbalancers/www/outputs.tf
- gcp-web3/70-loadbalancers/mint/outputs.tf
- gcp-gcby/70-loadbalancers/gs/outputs.tf
- proj-default-templet/70-loadbalancers/gs/outputs.tf

### 4. ICMP Firewall Rule 추가

**변경**: 배스천에서 ping 테스트 가능하도록 ICMP 허용
```hcl
{
  name           = "allow-icmp-from-mgmt"
  direction      = "INGRESS"
  ranges         = [local.mgmt_subnet_cidr]  # 10.250.10.0/24
  allow_protocol = "icmp"
  allow_ports    = []
  target_tags    = ["dmz-zone", "private-zone"]
  description    = "Allow ICMP (ping) from mgmt VPC for monitoring"
}
```

**적용 파일**:
- gcp-gcby/10-network/terragrunt.hcl
- gcp-web3/10-network/terragrunt.hcl
- proj-default-templet/10-network/terragrunt.hcl

### 5. gcp-web3 Redis DNS IP 수정

**문제**: web3 앱 서버에서 Redis 연결 실패

- DNS가 잘못된 IP `10.10.22.101`을 가리킴
- 실제 Redis Cluster Discovery endpoint는 `10.10.22.2`

**원인**: Redis Cluster가 자동 생성한 PSC IP와 수동 설정 IP 불일치

- `common.naming.tfvars`에 설정된 값: `["10.10.22.101", "10.10.22.102"]`
- 실제 자동 생성된 PSC: `["10.10.22.2", "10.10.22.3"]`

**해결**:
```hcl
# gcp-web3/common.naming.tfvars
psc_endpoints = {
  cloudsql = "10.10.22.51"
  redis    = ["10.10.22.2", "10.10.22.3"]  # Redis Cluster auto-created PSC IPs
}
```

**커밋**: `c1d1248`

### 6. 배스천 → 서버 DNS 접속 테스트 완료

**gcp-gcby 테스트 결과**:
| 호스트 | IP | SSH | MySQL | Redis |
|--------|-----|-----|-------|-------|
| gcby-gs01.delabsgames.internal | 10.10.11.3 | ✅ | - | - |
| gcby-gs02.delabsgames.internal | 10.10.11.6 | ✅ | - | - |
| gcby-live-gdb-m1.delabsgames.internal | 10.250.20.51 | - | ✅ | - |
| gcby-live-redis.delabsgames.internal | 10.250.20.101 | - | - | ✅ |

**gcp-web3 테스트 결과**:
| 호스트 | IP | SSH | MySQL | Redis |
|--------|-----|-----|-------|-------|
| web3-www01.delabsgames.internal | 10.10.21.11 | ✅ | - | - |
| web3-www02.delabsgames.internal | 10.10.21.12 | ✅ | - | - |
| web3-www03.delabsgames.internal | 10.10.21.13 | ✅ | - | - |
| web3-mint01.delabsgames.internal | 10.10.21.14 | ✅ | - | - |
| web3-mint02.delabsgames.internal | 10.10.21.15 | ✅ | - | - |
| web3-live-gdb-m1.delabsgames.internal | 10.250.20.52 | - | ✅ | - |
| web3-live-redis.delabsgames.internal | 10.250.20.111 | - | - | ✅ |

### 7. 앱 서버 → DB/Redis 연결 테스트 완료

**gcp-gcby (자체 VPC PSC)**:

| 서버 | MySQL IP | MySQL | Redis IP | Redis |
|------|----------|:-----:|----------|:-----:|
| gcby-gs01 | 10.10.12.51 | ✅ | 10.10.12.3 | ✅ |
| gcby-gs02 | 10.10.12.51 | ✅ | 10.10.12.3 | ✅ |

**gcp-web3 (자체 VPC PSC)**:

| 서버 | MySQL IP | MySQL | Redis IP | Redis |
|------|----------|:-----:|----------|:-----:|
| web3-www01 | 10.10.22.51 | ✅ | 10.10.22.2 | ✅ |
| web3-www02 | 10.10.22.51 | ✅ | 10.10.22.2 | ✅ |
| web3-www03 | 10.10.22.51 | ✅ | 10.10.22.2 | ✅ |
| web3-mint01 | 10.10.22.51 | ✅ | 10.10.22.2 | ✅ |
| web3-mint02 | 10.10.22.51 | ✅ | 10.10.22.2 | ✅ |

### 8. ICMP (ping) 테스트 완료

**gcp-gcby**:

| 서버 | IP | Ping |
|------|-----|:----:|
| gcby-gs01 | 10.10.11.3 | ✅ (0% loss, ~120ms) |
| gcby-gs02 | 10.10.11.6 | ✅ (0% loss, ~118ms) |

**gcp-web3**:

| 서버 | IP | Ping |
|------|-----|:----:|
| web3-www01 | 10.10.21.11 | ✅ |
| web3-www02 | 10.10.21.12 | ✅ |
| web3-www03 | 10.10.21.13 | ✅ |
| web3-mint01 | 10.10.21.14 | ✅ |
| web3-mint02 | 10.10.21.15 | ✅ |

## 발견된 중요 패턴

### terraform.tfvars vs terragrunt inputs 우선순위

**문제**: Terraform은 `*.tfvars` 파일을 자동 로드하여 변수 값을 설정함
- terragrunt inputs로 값을 주입해도 tfvars가 우선 적용됨
- 빈 값(`{}`, `[]`)도 유효한 값으로 간주되어 terragrunt 값을 덮어씀

**해결 패턴**:
```hcl
# terraform.tfvars에서 terragrunt로 주입되는 변수는 정의하지 않음
# ⚠️ instance_groups는 terragrunt.hcl에서 동적으로 주입됨
# terraform.tfvars에서 정의하면 terragrunt inputs를 덮어쓰므로 여기서는 정의하지 않음
```

**영향받는 변수들**:
- `instance_groups` (70-loadbalancers)
- `firewall_rules` (10-network)

## 커밋 내역

1. `fix: terraform.tfvars에서 instance_groups = {} 제거`
2. `feat: 70-loadbalancers에 instance_group_ids output 추가`
3. `fix: 10-network terraform.tfvars에서 firewall_rules = [] 제거`
4. `feat: 10-network에 ICMP firewall rule 추가` - `9a9275b`
5. `docs: 작업 내역 및 troubleshooting 문서 업데이트` - `856a8be`
6. `fix: gcp-web3 Redis DNS IP를 실제 Discovery endpoint로 수정` - `c1d1248`

## 인프라 상태 요약

### gcp-web3

- ✅ VMs: 5개 (www01/02/03, mint01/02)
- ✅ Instance Groups: 5개 (www-ig-a,b,c, mint-ig-a,b)
- ✅ Backend Services: www-backend, mint-backend
- ✅ Firewall Rules: 7개 (ICMP 포함)
- ✅ DNS: 정상 해석
- ✅ Cloud SQL PSC: 10.10.22.51
- ✅ Redis PSC: 10.10.22.2
- ✅ 네트워크: SSH, MySQL, Redis, ICMP 모두 연결 성공

### gcp-gcby

- ✅ VMs: 2개 (gs01/02)
- ✅ Instance Groups: 2개 (gs-ig-a, gs-ig-b)
- ✅ Backend Service: gs-backend
- ✅ Firewall Rules: 7개 (ICMP 포함)
- ✅ DNS: 정상 해석
- ✅ Cloud SQL PSC: 10.10.12.51
- ✅ Redis PSC: 10.10.12.3
- ✅ 네트워크: SSH, MySQL, Redis, ICMP 모두 연결 성공

## 완료된 작업

- [x] Instance Group 생성 문제 해결 (tfvars 우선순위)
- [x] gcp-gcby Instance Group subnet 불일치 해결
- [x] 70-loadbalancers에 instance_group_ids output 추가
- [x] ICMP firewall rule 추가 및 테스트
- [x] gcp-web3 Redis DNS IP 수정
- [x] 배스천 → 서버 DNS 접속 테스트
- [x] 앱 서버 → DB/Redis 연결 테스트
- [x] ICMP (ping) 테스트
