# Work History - 2025-11-28

## 작업 개요
70-loadbalancers 레이어의 Instance Group 자동 처리 로직 개선 및 안정화

## 주요 작업 내역

### 1. Jenkins Plan Stage 에러 수정 (Invalid Index)

**문제:**
- 70-loadbalancers/gs의 plan 단계에서 Invalid index 에러 발생
- gcby-gs03이 terraform.tfvars에 정의되어 있지만 아직 VM이 생성되지 않음
- `var.vm_details[inst_name]` 접근 시 에러 발생

**해결:**
```hcl
# 안전한 VM 필터링 로직 추가
resolved_instances = [
  for inst_name in cfg.instances : {
    name      = inst_name
    self_link = var.vm_details[inst_name].self_link
    zone      = var.vm_details[inst_name].zone
  }
  if contains(keys(var.vm_details), inst_name)  # ← 추가
]
```

**파일:** `environments/LIVE/gcp-gcby/70-loadbalancers/gs/main.tf`
**커밋:** 9a2b430

---

### 2. Precondition 에러 수정

**문제:**
- 첫 번째 수정 후 다른 에러 발생
- `resolved_instances`가 빈 배열일 때 precondition에서 에러
- `length(distinct([for inst in each.value.resolved_instances : inst.zone])) == 1` 조건이 빈 배열을 처리하지 못함

**해결:**
두 단계 접근:

1. **2단계 필터링 로직 추가:**
```hcl
# 1단계: 모든 Instance Group 처리
_all_instance_groups = { ... }

# 2단계: 빈 Instance Group 제거
processed_instance_groups = {
  for name, ig in local._all_instance_groups :
  name => ig
  if length(ig.resolved_instances) > 0  # 빈 그룹 제거
}
```

2. **Precondition 개선:**
```hcl
lifecycle {
  precondition {
    # 빈 배열 허용 추가
    condition = length(each.value.resolved_instances) == 0 ||
                length(distinct([...])) == 1
    error_message = "..."
  }
}
```

**파일:** `environments/LIVE/gcp-gcby/70-loadbalancers/gs/main.tf`
**커밋:** 064b812

---

### 3. gcby-gs03 서버 추가

**작업:**
- 50-workloads에 gcby-gs03 정의 추가 (zone_suffix = "c")
- 70-loadbalancers/gs에 gcby-gs-ig-c 정의 추가

**파일:**
- `environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars`
- `environments/LIVE/gcp-gcby/70-loadbalancers/gs/terraform.tfvars`

**커밋:** d434b75

---

### 4. vm_details.auto.tfvars 삭제 (중요!)

**문제 발견:**
- Instance Group import를 위해 임시로 `vm_details.auto.tfvars` 파일을 수동 생성함
- Terragrunt dependency로 자동 주입되어야 하는데 수동 파일이 덮어씀
- VM 추가/삭제 시마다 수동 업데이트 필요 (자동화 의미 없음)

**해결:**
```hcl
# terragrunt.hcl에서 자동 주입
dependency "workloads" {
  config_path = "../../50-workloads"
}

inputs = merge(
  ...
  {
    vm_details = try(dependency.workloads.outputs.vm_details, {})
  }
)
```

**파일:** `environments/LIVE/gcp-gcby/70-loadbalancers/gs/vm_details.auto.tfvars` (삭제)
**커밋:** e2b0dad

---

### 5. Environment 기본값 수정

**작업:**
- variables.tf의 environment 기본값을 "prod"에서 "live"로 변경
- 설명에 "(live, qa-dev)" 추가

**파일:** `environments/LIVE/gcp-gcby/70-loadbalancers/gs/variables.tf`
**커밋:** e2b0dad

---

### 6. proj-default-templet 동기화

**문제:**
- example-http/terragrunt.hcl이 구버전 (45줄)
- dependencies에 50-workloads 누락
- lb_name_defaults 자동 생성 로직 없음

**해결:**
- gcp-gcby/gs/terragrunt.hcl과 동일하게 업데이트 (66줄)
- dependencies에 `../../50-workloads` 추가
- lb_name_defaults 자동 생성 로직 추가
- mock_outputs_allowed_terraform_commands에 "destroy" 추가

**최종 동기화 상태:**
| 파일 | 상태 |
|------|------|
| main.tf | ✅ 완전 동일 (MD5: 3fdc5f7cf61e971dfe305c5374647af8) |
| variables.tf | ✅ 완전 동일 (MD5: 653c362dd57a0ac9e91f8e17645631b7) |
| outputs.tf | ✅ 완전 동일 (MD5: 60a0b98a30a45996cbf7670d7a1d2844) |
| terragrunt.hcl | ✅ 완전 동일 (MD5: 31e9ca94d9ed685b7ca3354106f8b298) |

**파일:** `proj-default-templet/70-loadbalancers/example-http/terragrunt.hcl`
**커밋:** 1bd5e82

---

### 7. VM 자동 삭제 로직 테스트

**테스트:**
- 50-workloads에서 gcby-gs03 삭제
- 70-loadbalancers/gs에서는 gcby-gs-ig-c 정의 유지
- main.tf 로직이 자동으로 Instance Group 삭제하는지 검증

**예상 동작:**
```
1. 50-workloads apply → gcby-gs03 VM 삭제
2. vm_details output에서 gcby-gs03 제거
3. 70-loadbalancers/gs apply 시:
   - vm_details에 gcby-gs03 없음 감지
   - resolved_instances = [] (빈 배열)
   - processed_instance_groups에서 gcby-gs-ig-c 제거
   - Terraform이 gcby-gs-ig-c Instance Group 자동 삭제
```

**검증 완료:** ✅ VM 삭제 시 Instance Group 자동 삭제 확인

**파일:** `environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars`
**커밋:** 758bc5b

---

## 핵심 개선 사항

### 1. 안전한 VM 참조
- VM이 생성되기 전에도 terraform.tfvars에 미리 정의 가능
- `contains(keys(var.vm_details), inst_name)` 필터링으로 안전하게 처리

### 2. 2단계 필터링 로직
```hcl
_all_instance_groups        # 1단계: 모든 IG 처리
  ↓
processed_instance_groups   # 2단계: 빈 IG 제거
  ↓
google_compute_instance_group.lb_instance_group  # 3단계: 리소스 생성
```

### 3. 자동 생성/삭제
- VM 생성 → Instance Group 자동 생성
- VM 삭제 → Instance Group 자동 삭제
- 수동 관리 불필요

### 4. 선택적 로드밸런싱
- terraform.tfvars에 명시한 VM만 LB에 포함
- 모든 VM이 자동으로 LB에 들어가지 않음

---

## 인프라 검증

### 전체 인프라 체크 스크립트 생성
**파일:** `/tmp/check_full_infra.sh`

**검증 항목:**
1. VM 인스턴스 (3개: gs01, gs02, gs03)
2. Instance Groups
3. Backend Services
4. Health Checks
5. URL Maps
6. Target Proxies
7. Forwarding Rules (Load Balancer IP)
8. VPC Networks
9. Subnets
10. Firewall Rules
11. Cloud Routers
12. NAT Gateways
13. Cloud Storage Buckets
14. Cloud SQL Instances
15. Redis Clusters
16. Service Accounts

**주요 발견:**
- ✅ Redis는 Cluster로 생성되어 있음 (gcby-live-redis)
- ✅ Cloud NAT는 존재함 (라우터 이름이 `gcby-live-vpc-cr`로 확인됨)
- ❌ Secret Manager API는 비활성화 상태 (observability에서 slack notification 비활성화되어 있어 필요 없음)

---

## 관련 문서 업데이트

### 70-loadbalancers README
**업데이트 필요:**
- 2단계 필터링 로직 설명
- VM 자동 생성/삭제 동작 설명
- vm_details dependency 설명

### Troubleshooting 가이드
**추가 필요:**
- Invalid index 에러 해결 방법
- Precondition 에러 해결 방법
- vm_details.auto.tfvars를 만들지 말 것

---

## Git Commits

```
1bd5e82 fix(proj-default-templet): example-http terragrunt.hcl 동기화
758bc5b test: gcby-gs03 서버 삭제 테스트 (자동 삭제 로직 검증)
e2b0dad fix(70-loadbalancers): vm_details.auto.tfvars 삭제 및 environment 기본값 수정
064b812 fix(70-loadbalancers): 빈 Instance Group 처리 로직 개선
d434b75 feat(gcp-gcby): gcby-gs03 서버 및 Instance Group 추가
9a2b430 fix(70-loadbalancers): VM이 아직 생성되지 않은 경우 안전하게 처리
```

---

## 교훈

### ✅ 좋았던 점
1. 2단계 필터링으로 깔끔하게 문제 해결
2. Terragrunt dependency 활용한 자동화
3. 선택적 로드밸런싱 구조 유지
4. proj-default-templet 동기화 완료

### ⚠️ 개선할 점
1. vm_details.auto.tfvars를 처음부터 만들지 말았어야 함
2. 자동화된 시스템에 수동 파일 추가는 안티패턴
3. 코드 검증 시 정밀하게 확인 필요 (Redis Cluster vs Instance, Cloud NAT 라우터 이름 등)

---

## 다음 작업 예정

1. 70-loadbalancers README 업데이트
2. Troubleshooting 가이드 추가
3. 다른 로드밸런서 추가 (app, lobby, web)
4. gcby-gs03 복원 (삭제 테스트 완료 후)
