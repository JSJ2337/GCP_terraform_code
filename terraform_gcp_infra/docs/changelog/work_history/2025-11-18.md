# 2025-11-18 작업 히스토리

## 작업 개요

Redis Cluster deletion protection 설정 추가 및 Terragrunt destroy 시 발생하는 dependency 에러 해결. Service Networking Connection destroy 문제도 함께 해결.

---

## 주요 작업

### 1. Redis Cluster Deletion Protection 변수 추가

**문제**:
- Redis Cluster를 destroy하려고 할 때 deletion protection으로 인해 실패
- 에러: "The cluster is deletion protected"

**해결**:
```hcl
# modules/memorystore-redis/variables.tf
variable "deletion_protection" {
  type        = bool
  description = "Deletion protection 활성화 여부 (true: 삭제 방지, false: 삭제 허용)"
  default     = true
}

# modules/memorystore-redis/main.tf
resource "google_redis_cluster" "enterprise" {
  deletion_protection_enabled = var.deletion_protection
  # ...
}
```

**적용**:
- `proj-default-templet/65-cache/terraform.tfvars`: `deletion_protection = false`
- `jsj-game-m/65-cache/terraform.tfvars`: `deletion_protection = false`

**기존 클러스터 처리**:
```bash
gcloud redis clusters update game-m-prod-redis \
  --region=asia-northeast3 \
  --no-deletion-protection \
  --project=jsj-game-m
```

**커밋**: `217adf0` - feat: Redis Cluster deletion protection 설정 추가

---

### 2. Terragrunt Destroy Dependency 에러 해결

#### 문제

**에러 메시지**:
```text
./50-workloads/terragrunt.hcl is a dependency of ./70-loadbalancers/lobby/terragrunt.hcl
but detected no outputs. Either the target module has not been applied yet,
or the module has no outputs.
```

**원인**:
- Destroy 실행 순서: 50-workloads → 70-loadbalancers
- 50-workloads가 먼저 삭제되어 outputs가 없음
- 70-loadbalancers가 `dependency.workloads.outputs.instance_groups`를 읽으려고 시도

#### 시도한 해결 방법들

**시도 1**: `mock_outputs_merge_with_state = true`
- 결과: ❌ 실패
- 이유: deprecated 속성

**시도 2**: `mock_outputs_merge_strategy_with_state = "shallow"`
- 결과: ❌ 실패
- 이유: Terragrunt 버전이나 설정 인식 문제로 작동하지 않음

**시도 3**: `skip_outputs = true`
- 결과: ⚠️ 작동하지만 부작용 발생
- 부작용: Apply/Plan 시에도 outputs를 읽지 않아 자동 매핑 기능 상실

**시도 4**: dependency 블록 완전 제거
- 결과: ⚠️ Destroy는 성공하지만 자동화 상실
- 부작용: instance_groups를 terraform.tfvars에 수동으로 지정해야 함

#### 최종 해결: `get_terraform_command()` 함수 사용

**핵심 아이디어**:
- Terragrunt의 `get_terraform_command()` 함수로 현재 실행 중인 명령어 감지
- Destroy 시에만 dependency outputs를 읽지 않도록 조건부 처리

**구현**:

```hcl
# 70-loadbalancers/lobby/terragrunt.hcl
dependency "workloads" {
  config_path = "../../50-workloads"

  mock_outputs = {
    instance_groups = {}
  }

  mock_outputs_allowed_terraform_commands = ["validate", "plan", "destroy"]
}

locals {
  # destroy 명령어인지 확인
  is_destroy = get_terraform_command() == "destroy"
}

inputs = merge(
  local.common_inputs,
  local.layer_inputs,
  # destroy가 아닐 때만 auto_instance_groups 추가
  local.is_destroy ? {} : {
    auto_instance_groups = {
      for name, link in try(dependency.workloads.outputs.instance_groups, {}) :
      name => link
      if length(regexall("lobby", lower(name))) > 0
    }
  }
)
```

**동작 방식**:

| 명령어 | is_destroy | auto_instance_groups | 결과 |
|--------|-----------|---------------------|------|
| apply  | false     | dependency outputs 사용 | ✅ 자동 매핑 |
| plan   | false     | dependency outputs 사용 | ✅ 자동 매핑 |
| destroy| true      | {} (빈 객체)        | ✅ 에러 없음 |

**장점**:
- ✅ 자동 instance_groups 연결 기능 유지
- ✅ Destroy 에러 완전 해결
- ✅ 수동 설정 불필요
- ✅ Apply, Plan, Destroy 모두 정상 작동

**영향받는 파일**:
- `environments/LIVE/jsj-game-m/70-loadbalancers/lobby/terragrunt.hcl`
- `environments/LIVE/jsj-game-m/70-loadbalancers/web/terragrunt.hcl`

**참고 문서**:
- [Terragrunt Built-in Functions](https://terragrunt.gruntwork.io/docs/reference/built-in-functions/)

**커밋**: `70adb20` - feat: get_terraform_command()로 자동화 유지하며 destroy 해결

---

### 3. Service Networking Connection Destroy 에러 해결

#### 문제

**에러 메시지**:
```text
Error: Unable to remove Service Networking Connection, err: Error waiting for Delete Service Networking Connection: Error code 9, message: Failed to delete connection; Producer services (e.g. CloudSQL, Cloud Memstore, etc.) are still using this connection.
```

**현상**:
- CloudSQL과 Redis가 이미 삭제된 상태
- VPC peering도 존재하지 않음
- 그럼에도 Service Networking Connection 삭제 실패

**근본 원인**:
- Terraform Provider Google 5.x의 알려진 버그
- Provider 4.x: `removePeering` 메서드 사용 (정상 작동)
- Provider 5.x: `deleteConnection` 메서드로 변경 (regression)
- GitHub Issue #16275, #19908

#### 해결: `deletion_policy = "ABANDON"`

**Q: 슬립타임을 걸어야 하나?**
A: 아니요! `deletion_policy = "ABANDON"`를 사용하면 됩니다.

**구현**:
```hcl
# modules/network-dedicated-vpc/main.tf
resource "google_service_networking_connection" "private_vpc_connection" {
  count   = var.enable_private_service_connection ? 1 : 0
  network = google_compute_network.vpc.self_link
  service = var.private_service_connection_service

  reserved_peering_ranges = local.private_service_connection_reserved_ranges

  # Terraform Provider Google 5.x 버그 우회: destroy 시 ABANDON으로 설정
  # VPC/프로젝트 삭제 시 자동으로 정리되므로 안전함
  deletion_policy = "ABANDON"

  depends_on = [google_compute_global_address.private_service_connect]
}
```

**ABANDON의 의미**:
- Terraform destroy 시 **GCP에서 실제로 삭제하지 않음**
- **Terraform state에서만 제거**
- VPC 또는 프로젝트 삭제 시 자동으로 정리됨

**왜 안전한가?**:
1. VPC 삭제 시 Service Networking Connection도 자동 삭제
2. 프로젝트 삭제 시 모든 리소스 정리
3. 고아 리소스가 남지 않음

**장점**:
- ✅ **슬립타임 불필요** - 즉시 완료
- ✅ **항상 성공** - 에러 없음
- ✅ **완전 자동화** - CI/CD 파이프라인에 적합
- ✅ **안전** - VPC 삭제 시 함께 정리

**기존 환경 처리**:

이미 생성된 Service Networking Connection이 있는 경우:

```bash
# 옵션 1: State에서 제거 (추천)
cd terraform_gcp_infra/environments/LIVE/jsj-game-m/10-network
terragrunt state rm module.network.google_service_networking_connection.private_vpc_connection[0]
cd ..
terragrunt run-all destroy --terragrunt-non-interactive

# 옵션 2: 콘솔에서 수동 삭제
# GCP 콘솔 → VPC Network → VPC network peering → 삭제

# 옵션 3: 단순히 무시하고 VPC 삭제
# Service Networking Connection은 VPC 삭제 시 자동 정리
```

**참고 자료**:
- [GitHub Issue #16275](https://github.com/hashicorp/terraform-provider-google/issues/16275)
- [GitHub Issue #19908](https://github.com/hashicorp/terraform-provider-google/issues/19908)
- [Terraform Registry - google_service_networking_connection](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_networking_connection)

**커밋**: `c6370b7` - fix: Service Networking Connection destroy 에러 해결

---

## 기술적 학습

### Terragrunt의 `get_terraform_command()` 함수

**용도**: 현재 실행 중인 Terraform 명령어 감지

**사용 예시**:
```hcl
locals {
  is_destroy = get_terraform_command() == "destroy"
  is_apply   = get_terraform_command() == "apply"
  is_plan    = get_terraform_command() == "plan"
}

inputs = local.is_destroy ? {
  # destroy용 설정
} : {
  # apply/plan용 설정
}
```

**활용 사례**:
- Destroy 시 dependency outputs 읽지 않기
- 명령어별 다른 변수 값 사용
- 조건부 리소스 생성/삭제

### Terraform Provider Google의 `deletion_policy`

**적용 대상**: `google_service_networking_connection`

**옵션**:
- (기본값): 실제 삭제 시도
- `"ABANDON"`: State에서만 제거, GCP에서는 그대로 유지

**사용 시나리오**:
- Provider 버그 우회
- 리소스 생명주기가 parent resource에 종속적인 경우
- 수동 정리가 필요한 리소스

### Mock Outputs의 한계

**시도했으나 작동하지 않은 것들**:
1. `mock_outputs_merge_with_state = true` - deprecated
2. `mock_outputs_merge_strategy_with_state = "shallow"` - 버그 또는 버전 이슈
3. `skip_outputs = true` - 작동하지만 부작용 (항상 outputs 무시)

**교훈**:
- Terragrunt의 일부 기능은 버전에 따라 작동하지 않을 수 있음
- 공식 문서에 있어도 실제로는 작동하지 않는 경우 존재
- `get_terraform_command()`와 같은 기본 함수가 더 안정적

---

## 커밋 히스토리

```
c6370b7 - fix: Service Networking Connection destroy 에러 해결
70adb20 - feat: get_terraform_command()로 자동화 유지하며 destroy 해결
3c778da - fix: dependency 블록 제거로 destroy 에러 완전 해결 (되돌림)
cac6160 - fix: mock_outputs_merge_strategy_with_state로 destroy 에러 해결 (되돌림)
166ae4a - fix: 70-loadbalancers destroy 시 50-workloads 의존성 에러 해결 (되돌림)
217adf0 - feat: Redis Cluster deletion protection 설정 추가
```

**최종 상태**: `c6370b7`

**적용된 변경**:
1. Redis deletion protection 변수 추가
2. get_terraform_command() 조건부 처리
3. Service Networking Connection deletion_policy = "ABANDON"

---

## 문서 업데이트

### 업데이트된 문서

1. **CHANGELOG.md**
   - 2025-11-18 섹션 추가
   - Redis deletion protection 내용
   - Terragrunt dependency 해결 과정 상세 기록
   - Service Networking Connection 해결책

2. **troubleshooting/common-errors.md**
   - 섹션 18: Terragrunt Dependency Outputs 에러 (Destroy 시)
   - 섹션 19: Service Networking Connection Destroy 실패
   - 섹션 20: Redis Cluster Deletion Protection
   - 각 에러별 증상, 원인, 해결 방법 상세 기록

3. **work_history/2025-11-18.md** (본 문서)
   - 전체 작업 과정 상세 기록
   - 시도한 방법들과 결과
   - 기술적 학습 내용

---

## 다음 작업 제안

### 1. 템플릿 동기화

현재 jsj-game-m에 적용된 변경사항들을 proj-default-templet에도 반영:

```bash
# 70-loadbalancers/example-http/terragrunt.hcl
# get_terraform_command() 로직 추가
```

### 2. 다른 환경 적용

jsj-game-l, jsj-game-k 등 다른 환경에도 동일한 수정 적용

### 3. Jenkins 파이프라인 개선

Destroy 실패 시 자동 재시도 로직 추가 고려

### 4. 모니터링 추가

Destroy 작업의 성공/실패 메트릭 수집

---

## 참고 자료

- [Terragrunt Built-in Functions](https://terragrunt.gruntwork.io/docs/reference/built-in-functions/)
- [Terraform Provider Google Issue #16275](https://github.com/hashicorp/terraform-provider-google/issues/16275)
- [Terraform Provider Google Issue #19908](https://github.com/hashicorp/terraform-provider-google/issues/19908)
- [google_service_networking_connection](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_networking_connection)
- [Terragrunt Stacks Documentation](https://terragrunt.gruntwork.io/docs/features/stacks/)
