# 2025-11-18 작업 히스토리

## 작업 개요

Redis Cluster deletion protection 설정 추가 및 Terragrunt destroy 시 발생하는 dependency 에러 해결. Service Networking Connection destroy 문제도 함께 해결. 최종적으로 환경변수 기반 dependency 제어 방식으로 자동화와 destroy 안정성 모두 확보.

---

## 주요 작업

### 1. Redis Cluster Deletion Protection 변수 추가

**문제**:
- Redis Cluster를 destroy하려고 할 때 deletion protection으로 인해 실패
- 에러: "The cluster is deletion protected"

**해결**:
```hcl
# modules/memorystore-redis/variables.tf
variable "deletion_protection" {
  type        = bool
  description = "Deletion protection 활성화 여부 (true: 삭제 방지, false: 삭제 허용)"
  default     = true
}

# modules/memorystore-redis/main.tf
resource "google_redis_cluster" "enterprise" {
  deletion_protection_enabled = var.deletion_protection
  # ...
}
```

**적용**:
- `proj-default-templet/65-cache/terraform.tfvars`: `deletion_protection = false`
- `jsj-game-m/65-cache/terraform.tfvars`: `deletion_protection = false`

**기존 클러스터 처리**:
```bash
gcloud redis clusters update game-m-prod-redis \
  --region=asia-northeast3 \
  --no-deletion-protection \
  --project=jsj-game-m
```

**커밋**: `217adf0` - feat: Redis Cluster deletion protection 설정 추가

---

### 2. Terragrunt Destroy Dependency 에러 해결

#### 문제

**에러 메시지**:
```text
./50-workloads/terragrunt.hcl is a dependency of ./70-loadbalancers/lobby/terragrunt.hcl
but detected no outputs. Either the target module has not been applied yet,
or the module has no outputs.
```

**원인**:
- Destroy 실행 순서: 50-workloads → 70-loadbalancers
- 50-workloads가 먼저 삭제되어 outputs가 없음
- 70-loadbalancers가 `dependency.workloads.outputs.instance_groups`를 읽으려고 시도

#### 시도한 해결 방법들

**시도 1**: `mock_outputs_merge_with_state = true`
- 결과: ❌ 실패
- 이유: deprecated 속성

**시도 2**: `mock_outputs_merge_strategy_with_state = "shallow"`
- 결과: ❌ 실패
- 이유: Terragrunt 버전이나 설정 인식 문제로 작동하지 않음

**시도 3**: `skip_outputs = true`
- 결과: ⚠️ 작동하지만 부작용 발생
- 부작용: Apply/Plan 시에도 outputs를 읽지 않아 자동 매핑 기능 상실

**시도 4**: `get_terraform_command()` 조건 분기
- 결과: ❌ 실패
- 이유: dependency 블록 평가 시점에 이미 에러 발생
- mock_outputs_allowed_terraform_commands가 작동하지 않음

**시도 5**: dependency 블록 완전 제거
- 결과: ⚠️ Destroy는 성공하지만 자동화 상실
- 부작용: instance_groups를 terraform.tfvars에 수동으로 지정해야 함

#### 최종 해결: 환경변수 기반 `skip_outputs` 제어

**핵심 아이디어**:
- `get_env()` 함수로 환경변수를 읽어서 `skip_outputs` 동적 제어
- 일반 사용 시: 자동 매핑 유지
- run-all destroy 시: 환경변수 설정으로 dependency 건너뛰기

**구현**:

```hcl
# 70-loadbalancers/lobby/terragrunt.hcl
dependency "workloads" {
  config_path = "../../50-workloads"

  # SKIP_WORKLOADS_DEPENDENCY=true 환경변수 설정 시 outputs 건너뛰기
  skip_outputs = get_env("SKIP_WORKLOADS_DEPENDENCY", "false") == "true"

  mock_outputs = {
    instance_groups = {}
  }

  mock_outputs_allowed_terraform_commands = ["validate", "plan"]
}

inputs = merge(
  local.common_inputs,
  local.layer_inputs,
  {
    auto_instance_groups = {
      for name, link in try(dependency.workloads.outputs.instance_groups, {}) :
      name => link
      if length(regexall("lobby", lower(name))) > 0
    }
  }
)
```

**사용법**:

```bash
# 일반 사용 (자동 매핑 ✅)
cd 70-loadbalancers/lobby
terragrunt apply

# run-all destroy (환경변수 설정)
cd environments/LIVE/jsj-game-m
SKIP_WORKLOADS_DEPENDENCY=true terragrunt run-all destroy --terragrunt-non-interactive

# 개별 destroy (환경변수 불필요)
cd 70-loadbalancers/lobby
terragrunt destroy
```

**동작 방식**:

| 상황 | SKIP_WORKLOADS_DEPENDENCY | skip_outputs | auto_instance_groups | 결과 |
|------|--------------------------|--------------|---------------------|------|
| **일반 apply** | (설정 안 함) | false | 실제 outputs 매핑 | ✅ 자동화 |
| **일반 destroy** | (설정 안 함) | false | 실제 outputs 매핑 | ✅ 정상 |
| **run-all destroy** | true | true | {} (빈 객체) | ✅ 에러 없음 |

**장점**:
- ✅ 자동 instance_groups 연결 기능 유지
- ✅ run-all destroy 안정성 확보
- ✅ 필요시에만 환경변수 설정
- ✅ 유연한 제어

**영향받는 파일**:
- `environments/LIVE/jsj-game-m/70-loadbalancers/lobby/terragrunt.hcl`
- `environments/LIVE/jsj-game-m/70-loadbalancers/web/terragrunt.hcl`
- `proj-default-templet/70-loadbalancers/example-http/terragrunt.hcl`

**README 추가**:
- `environments/LIVE/jsj-game-m/70-loadbalancers/README.md`
- `proj-default-templet/70-loadbalancers/README.md`

**커밋 시퀀스**:
```
9e5126a - feat: 환경변수로 dependency 제어하여 자동화와 destroy 안정성 모두 확보
4e3b9ab - fix: dependency 블록 완전 제거로 destroy 에러 해결 (되돌림)
0391e23 - fix: is_destroy 조건 제거하여 mock_outputs 활용 (되돌림)
473d291 - fix: mock_outputs_merge_strategy_with_state로 destroy 시 state 병합 (되돌림)
bcd6c98 - fix: skip_outputs로 destroy 시 dependency outputs 읽기 완전 차단 (되돌림)
d8a5c65 - fix: init 단계에서도 dependency outputs 읽기 차단 (되돌림)
15b6d78 - fix: dependencies 블록에서 50-workloads 제거하여 destroy 에러 완전 해결
70adb20 - feat: get_terraform_command()로 자동화 유지하며 destroy 해결 (되돌림)
```

---

### 3. Service Networking Connection Destroy 에러 해결

#### 문제

**에러 메시지**:
```text
Error: Unable to remove Service Networking Connection, err: Error waiting for Delete Service Networking Connection: Error code 9, message: Failed to delete connection; Producer services (e.g. CloudSQL, Cloud Memstore, etc.) are still using this connection.
```

**현상**:
- CloudSQL과 Redis가 이미 삭제된 상태
- VPC peering도 존재하지 않음
- 그럼에도 Service Networking Connection 삭제 실패

**근본 원인**:
- Terraform Provider Google 5.x의 알려진 버그
- Provider 4.x: `removePeering` 메서드 사용 (정상 작동)
- Provider 5.x: `deleteConnection` 메서드로 변경 (regression)
- GitHub Issue #16275, #19908

#### 해결: `deletion_policy = "ABANDON"`

**구현**:
```hcl
# modules/network-dedicated-vpc/main.tf
resource "google_service_networking_connection" "private_vpc_connection" {
  count   = var.enable_private_service_connection ? 1 : 0
  network = google_compute_network.vpc.self_link
  service = var.private_service_connection_service

  reserved_peering_ranges = local.private_service_connection_reserved_ranges

  # Terraform Provider Google 5.x 버그 우회: destroy 시 ABANDON으로 설정
  # VPC/프로젝트 삭제 시 자동으로 정리되므로 안전함
  deletion_policy = "ABANDON"

  depends_on = [google_compute_global_address.private_service_connect]
}
```

**ABANDON의 의미**:
- Terraform destroy 시 **GCP에서 실제로 삭제하지 않음**
- **Terraform state에서만 제거**
- VPC 또는 프로젝트 삭제 시 자동으로 정리됨

**왜 안전한가?**:
1. VPC 삭제 시 Service Networking Connection도 자동 삭제
2. 프로젝트 삭제 시 모든 리소스 정리
3. 고아 리소스가 남지 않음

**장점**:
- ✅ **슬립타임 불필요** - 즉시 완료
- ✅ **항상 성공** - 에러 없음
- ✅ **완전 자동화** - CI/CD 파이프라인에 적합
- ✅ **안전** - VPC 삭제 시 함께 정리

**커밋**: `c6370b7` - fix: Service Networking Connection destroy 에러 해결

---

### 4. proj-default-templet 업데이트

jsj-game-m의 개선사항을 템플릿에 반영하여 새 환경 생성 시 즉시 활용 가능하도록 함.

**변경사항**:
- 환경변수 기반 skip_outputs 제어 추가
- dependencies 블록에서 50-workloads 제거
- auto_instance_groups 자동 매핑 기능 추가
- 필터링 패턴 예시 및 주석 추가
- README 작성 (사용법, 설정 방법)

**커밋**: `d738e9e` - feat: proj-default-templet에 자동 instance_groups 매핑 기능 추가

---

## 기술적 학습

### Terragrunt의 `get_env()` 함수

**용도**: 환경변수를 읽어서 동적 설정 제어

**사용 예시**:
```hcl
skip_outputs = get_env("SKIP_WORKLOADS_DEPENDENCY", "false") == "true"
```

**활용 사례**:
- Destroy 시 dependency outputs 건너뛰기
- 환경별 다른 설정 적용
- CI/CD 파이프라인에서 동적 제어

### `get_terraform_command()` vs `get_env()`

**`get_terraform_command()` 문제점**:
- dependency 블록 평가 시점에 이미 에러 발생
- mock_outputs_allowed_terraform_commands가 제대로 작동하지 않음
- init 단계에서도 outputs 접근 시도

**`get_env()` 장점**:
- 명시적 제어: 사용자가 의도적으로 환경변수 설정
- 유연성: 필요할 때만 설정
- 안정성: 검증된 Terragrunt 기본 함수

### Terraform Provider Google의 `deletion_policy`

**적용 대상**: `google_service_networking_connection`

**옵션**:
- (기본값): 실제 삭제 시도
- `"ABANDON"`: State에서만 제거, GCP에서는 그대로 유지

**사용 시나리오**:
- Provider 버그 우회
- 리소스 생명주기가 parent resource에 종속적인 경우
- 수동 정리가 필요한 리소스

### Mock Outputs의 한계

**시도했으나 작동하지 않은 것들**:
1. `mock_outputs_merge_with_state = true` - deprecated
2. `mock_outputs_merge_strategy_with_state = "shallow"` - 버그 또는 버전 이슈
3. `mock_outputs_allowed_terraform_commands = ["destroy"]` - 평가 시점 문제
4. `get_terraform_command()` 조건 분기 - dependency 평가 시점에 이미 실패

**교훈**:
- Terragrunt의 일부 기능은 버전에 따라 작동하지 않을 수 있음
- 공식 문서에 있어도 실제로는 작동하지 않는 경우 존재
- 명시적 제어(환경변수)가 더 안정적

---

## 커밋 히스토리

```
d738e9e - feat: proj-default-templet에 자동 instance_groups 매핑 기능 추가
9e5126a - feat: 환경변수로 dependency 제어하여 자동화와 destroy 안정성 모두 확보
4e3b9ab - fix: dependency 블록 완전 제거로 destroy 에러 해결
0391e23 - fix: is_destroy 조건 제거하여 mock_outputs 활용
473d291 - fix: mock_outputs_merge_strategy_with_state로 destroy 시 state 병합
bcd6c98 - fix: skip_outputs로 destroy 시 dependency outputs 읽기 완전 차단
d8a5c65 - fix: init 단계에서도 dependency outputs 읽기 차단
15b6d78 - fix: dependencies 블록에서 50-workloads 제거하여 destroy 에러 완전 해결
c6370b7 - fix: Service Networking Connection destroy 에러 해결
70adb20 - feat: get_terraform_command()로 자동화 유지하며 destroy 해결
3c778da - fix: dependency 블록 제거로 destroy 에러 완전 해결
9497f53 - docs: 2025-11-18 작업 내역 CHANGELOG에 추가
cac6160 - fix: mock_outputs_merge_strategy_with_state로 destroy 에러 해결
166ae4a - fix: 70-loadbalancers destroy 시 50-workloads 의존성 에러 해결
217adf0 - feat: Redis Cluster deletion protection 설정 추가
```

**최종 상태**: `d738e9e`

**적용된 변경**:
1. Redis deletion protection 변수 추가
2. 환경변수 기반 dependency 제어
3. Service Networking Connection deletion_policy = "ABANDON"
4. proj-default-templet 업데이트

---

## 문서 업데이트

### 업데이트 필요 문서

1. **CHANGELOG.md** ⚠️
   - 환경변수 방식 최종 해결책 업데이트 필요

2. **troubleshooting/common-errors.md** ⚠️
   - Dependency 에러 해결 방법 업데이트 필요

3. **work_history/2025-11-18.md** ✅
   - 본 문서: 전체 작업 과정 상세 기록 완료

4. **70-loadbalancers/README.md** ✅
   - jsj-game-m 및 proj-default-templet 모두 작성 완료

---

## 다음 작업 제안

### 1. 다른 환경 적용

jsj-game-l, jsj-game-k 등 다른 환경에도 동일한 패턴 적용

### 2. Jenkins 파이프라인 개선

Destroy 파이프라인에 환경변수 자동 설정:
```groovy
environment {
    SKIP_WORKLOADS_DEPENDENCY = 'true'
}
```

### 3. 모니터링 추가

Destroy 작업의 성공/실패 메트릭 수집

### 4. 문서 완성

- CHANGELOG.md 최종 업데이트
- common-errors.md에 환경변수 방식 반영

---

## 참고 자료

- [Terragrunt Built-in Functions](https://terragrunt.gruntwork.io/docs/reference/built-in-functions/)
- [Terraform Provider Google Issue #16275](https://github.com/hashicorp/terraform-provider-google/issues/16275)
- [Terraform Provider Google Issue #19908](https://github.com/hashicorp/terraform-provider-google/issues/19908)
- [google_service_networking_connection](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_networking_connection)
- [Terragrunt Stacks Documentation](https://terragrunt.gruntwork.io/docs/features/stacks/)
