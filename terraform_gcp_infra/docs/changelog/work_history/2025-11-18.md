# ì‘ì—… íˆìŠ¤í† ë¦¬ - 2025ë…„ 11ì›” 18ì¼

## ì‘ì—… ê°œìš”

Load Balancer ì¤‘ë³µ ì½”ë“œ ì œê±°ë¥¼ ìœ„í•œ ë¦¬íŒ©í† ë§ ì‹œë„ ë° Terragrunt source ê²½ë¡œ ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ê¸°ë¡í•©ë‹ˆë‹¤.

---

## 1. ğŸ› Load Balancer Terragrunt Source ê²½ë¡œ ë¬¸ì œ

### ë¬¸ì œ ìƒí™©

ì–´ì œ(11ì›” 17ì¼) ì§„í–‰í•œ Load Balancer ë¦¬íŒ©í† ë§ í›„ Jenkins ë°°í¬ ì‹¤íŒ¨:

```
Error: Unreadable module directory

Unable to evaluate directory symlink: lstat ../../../../../modules: no such
file or directory

The directory could not be read for module "load_balancer" at main.tf:45.
The directory could not be read for module "naming" at main.tf:8.
```

### ì›ì¸ ë¶„ì„

**ë¦¬íŒ©í† ë§ êµ¬ì¡° (11ì›” 17ì¼)**:
```
70-loadbalancers/
â”œâ”€â”€ _common/              â† ê³µí†µ ì½”ë“œ
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â””â”€â”€ outputs.tf
â”œâ”€â”€ lobby/
â”‚   â”œâ”€â”€ terragrunt.hcl   # source = "../_common"
â”‚   â””â”€â”€ terraform.tfvars
â””â”€â”€ web/
    â”œâ”€â”€ terragrunt.hcl   # source = "../_common"
    â””â”€â”€ terraform.tfvars
```

**ë¬¸ì œì **:
1. Terragruntê°€ `source = "../_common"`ì„ `.terragrunt-cache`ë¡œ ë³µì‚¬
2. ë³µì‚¬ëœ `_common` ë‚´ë¶€ì˜ `main.tf`ê°€ ëª¨ë“ˆ ì°¸ì¡°:
   - `source = "../../../../../modules/naming"`
   - `source = "../../../../../modules/load-balancer"`
3. `.terragrunt-cache` ë‚´ë¶€ì—ì„œëŠ” í•´ë‹¹ ìƒëŒ€ ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ

---

## 2. ğŸ”§ í•´ê²° ì‹œë„ #1: ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©

### ì‹œë„ ë‚´ìš©

Terragruntì˜ `//` í”„ë¦¬í”½ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ repo root ê¸°ì¤€ ì ˆëŒ€ ê²½ë¡œ ì§€ì •:

```hcl
# lobby/terragrunt.hcl
terraform {
  source = "//terraform_gcp_infra/environments/LIVE/jsj-game-m/70-loadbalancers/_common"
}
```

### ì‹¤íŒ¨ ì´ìœ 

- âŒ í”„ë¡œì íŠ¸ë³„ í•˜ë“œì½”ë”© (`jsj-game-m`)
- âŒ í”„ë¡œì íŠ¸ ê°„ ë³µì‚¬ ì‹œ ìˆ˜ì • í•„ìš”
- âŒ í™•ì¥ì„± ì—†ìŒ

### ê´€ë ¨ ì»¤ë°‹

```
24a2934 - fix: Load Balancer terragrunt source ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •
```

---

## 3. ğŸ”§ í•´ê²° ì‹œë„ #2: _common ë‚´ë¶€ ëª¨ë“ˆ ê²½ë¡œ ì ˆëŒ€í™”

### ì‹œë„ ë‚´ìš©

1. `terragrunt.hcl`ì˜ sourceëŠ” ë™ì  ê²½ë¡œ ìœ ì§€:
   ```hcl
   source = "${get_terragrunt_dir()}/../_common"
   ```

2. `_common/main.tf` ë‚´ë¶€ ëª¨ë“ˆë§Œ ì ˆëŒ€ ê²½ë¡œ:
   ```hcl
   module "naming" {
     source = "//terraform_gcp_infra/modules/naming"
   }

   module "load_balancer" {
     source = "//terraform_gcp_infra/modules/load-balancer"
   }
   ```

### ì‹¤íŒ¨ ì´ìœ 

```
Error: Invalid module source address

on main.tf line 9, in module "naming":
   9:   source = "//terraform_gcp_infra/modules/naming"

Failed to parse module source address: invalid source address: .
```

- âŒ `//` ë¬¸ë²•ì€ **Terragrunt ì „ìš©** (terragrunt.hclì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥)
- âŒ **Terraform íŒŒì¼(.tf)**ì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€ëŠ¥
- âŒ Terraformì€ ìƒëŒ€ ê²½ë¡œ, ì ˆëŒ€ ê²½ë¡œ, ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê²½ë¡œë§Œ ì§€ì›

### ê´€ë ¨ ì»¤ë°‹

```
add3036 - fix: Load Balancer ëª¨ë“ˆ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì—¬ terragrunt-cache ë¬¸ì œ í•´ê²°
```

---

## 4. ğŸ”§ í•´ê²° ì‹œë„ #3: ì •ì‹ ëª¨ë“ˆí™” (load-balancer-layer)

### ì‹œë„ ë‚´ìš©

`_common`ì„ `modules/load-balancer-layer`ë¡œ ì´ë™í•˜ì—¬ ì •ì‹ ëª¨ë“ˆí™”:

```
modules/
â”œâ”€â”€ load-balancer-layer/  â† High-level wrapper
â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€ module "naming" { source = "../naming" }
â”‚   â”‚   â””â”€ module "load_balancer" { source = "../load-balancer" }
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ outputs.tf
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ naming/
â””â”€â”€ load-balancer/
```

```hcl
# lobby/terragrunt.hcl
terraform {
  source = "../../../../../modules/load-balancer-layer"
}
```

### ì‹¤íŒ¨ ì´ìœ 

```
Error: Unreadable module directory

Unable to evaluate directory symlink: lstat ../load-balancer: no such file
or directory

The directory could not be read for module "load_balancer" at main.tf:45.
```

**ê·¼ë³¸ ì›ì¸**: Terragruntì˜ source ë³µì‚¬ ë©”ì»¤ë‹ˆì¦˜
- TerragruntëŠ” `source`ë¡œ ì§€ì •ëœ **ë‹¨ì¼ í´ë”ë§Œ** `.terragrunt-cache`ë¡œ ë³µì‚¬
- `modules/load-balancer-layer`ë§Œ ë³µì‚¬ë¨
- ì¸ì ‘í•œ `modules/naming`, `modules/load-balancer`ëŠ” ë³µì‚¬ë˜ì§€ ì•ŠìŒ
- ë”°ë¼ì„œ ìƒëŒ€ ê²½ë¡œ `../naming`, `../load-balancer` ì°¸ì¡° ì‹¤íŒ¨

### ê´€ë ¨ ì»¤ë°‹

```
808a980 - refactor: Load Balancerë¥¼ ì •ì‹ ëª¨ë“ˆ(load-balancer-layer)ë¡œ ì „í™˜
124cd31 - docs: load-balancer-layer ëª¨ë“ˆ README ì¶”ê°€
```

---

## 5. âœ… ìµœì¢… í•´ê²°: ë¦¬íŒ©í† ë§ ì›ë³µ (ì¤‘ë³µ ì½”ë“œ í—ˆìš©)

### ê²°ì • ì‚¬ìœ 

**Terragruntì˜ êµ¬ì¡°ì  ì œì•½**:
1. `source`ëŠ” ë‹¨ì¼ í´ë”ë§Œ ë³µì‚¬
2. ëª¨ë“ˆ ê°„ ì˜ì¡´ì„±ì´ ìˆëŠ” ê²½ìš° ê³µí†µí™” ë¶ˆê°€ëŠ¥
3. `.tf` íŒŒì¼ì—ì„œ `//` ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš© ë¶ˆê°€

**ëŒ€ì•ˆ ê²€í† **:
| ë°©ë²• | ì¥ì  | ë‹¨ì  | ì„ íƒ |
|------|------|------|------|
| ì¤‘ë³µ ì½”ë“œ í—ˆìš© | âœ… ì•ˆì •ì  ë™ì‘<br>âœ… êµ¬ì¡° ë‹¨ìˆœ | âŒ 700ì¤„ ì¤‘ë³µ<br>âŒ ìˆ˜ì • ì‹œ 2ê³³ ë³€ê²½ | âœ… ì„ íƒ |
| ì‹¬ë³¼ë¦­ ë§í¬ | âœ… ì¤‘ë³µ ì œê±° | âŒ ë³´ì•ˆ ì·¨ì•½<br>âŒ Git ê´€ë¦¬ ë³µì¡ | âŒ ì œì™¸ |
| í…œí”Œë¦¿ ìŠ¤í¬ë¦½íŠ¸ | âœ… ì¤‘ë³µ ì œê±° | âŒ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ ë³µì¡í™” | âŒ ì œì™¸ |

### ì›ë³µ ë‚´ìš©

**ë³µì›ëœ êµ¬ì¡°**:
```
70-loadbalancers/
â”œâ”€â”€ lobby/
â”‚   â”œâ”€â”€ main.tf          â† ë³µì› (124ì¤„)
â”‚   â”œâ”€â”€ variables.tf     â† ë³µì› (200ì¤„)
â”‚   â”œâ”€â”€ outputs.tf       â† ë³µì› (30ì¤„)
â”‚   â”œâ”€â”€ terragrunt.hcl   # source ë¸”ë¡ ì œê±° (in-place ì‹¤í–‰)
â”‚   â””â”€â”€ terraform.tfvars
â””â”€â”€ web/
    â”œâ”€â”€ main.tf          â† ë³µì› (124ì¤„)
    â”œâ”€â”€ variables.tf     â† ë³µì› (200ì¤„)
    â”œâ”€â”€ outputs.tf       â† ë³µì› (30ì¤„)
    â”œâ”€â”€ terragrunt.hcl   # source ë¸”ë¡ ì œê±° (in-place ì‹¤í–‰)
    â””â”€â”€ terraform.tfvars
```

**ë³€ê²½ì‚¬í•­**:
- âœ… lobby/webì— ê°ê° terraform íŒŒì¼ ë³µì›
- âœ… `modules/load-balancer-layer` ì‚­ì œ
- âœ… terragrunt.hclì—ì„œ `source` ë¸”ë¡ ì œê±° (in-place ì‹¤í–‰)
- âœ… 10-networkì²˜ëŸ¼ ê° ë ˆì´ì–´ê°€ ìì²´ terraform íŒŒì¼ ë³´ìœ 

**Git í†µê³„**:
```
9 files changed, 540 insertions(+), 250 deletions(-)
```

### ê´€ë ¨ ì»¤ë°‹

```
836ebf8 - Revert "Load Balancer ë¦¬íŒ©í† ë§"
```

---

## ì „ì²´ ì»¤ë°‹ ì´ë ¥

```
836ebf8 - Revert "Load Balancer ë¦¬íŒ©í† ë§"
124cd31 - docs: load-balancer-layer ëª¨ë“ˆ README ì¶”ê°€
808a980 - refactor: Load Balancerë¥¼ ì •ì‹ ëª¨ë“ˆ(load-balancer-layer)ë¡œ ì „í™˜
add3036 - fix: Load Balancer ëª¨ë“ˆ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì—¬ terragrunt-cache ë¬¸ì œ í•´ê²°
24a2934 - fix: Load Balancer terragrunt source ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •
```

---

## í•™ìŠµ ë° êµí›ˆ

### Terragrunt Source ë©”ì»¤ë‹ˆì¦˜

**ë™ì‘ ë°©ì‹**:
1. `source`ë¡œ ì§€ì •ëœ í´ë”ë¥¼ `.terragrunt-cache/<hash>/`ë¡œ ë³µì‚¬
2. ë³µì‚¬ëœ í´ë” ë‚´ë¶€ì—ì„œ `terraform init` ì‹¤í–‰
3. **ì˜¤ì§ ì§€ì •ëœ í´ë”ë§Œ** ë³µì‚¬ (ì£¼ë³€ í´ë”ëŠ” ë³µì‚¬ ì•ˆ ë¨)

**ì œì•½ì‚¬í•­**:
- ìƒëŒ€ ê²½ë¡œ ëª¨ë“ˆ ì°¸ì¡° ì‹œ ì œì•½ ë°œìƒ
- ëª¨ë“ˆ ê°„ ì˜ì¡´ì„±ì´ ìˆìœ¼ë©´ ê³µí†µí™” ì–´ë ¤ì›€
- `//` ë¬¸ë²•ì€ terragrunt.hcl ì „ìš© (Terraformì—ì„œ ë¶ˆê°€)

### ì¤‘ë³µ vs ì¬ì‚¬ìš© íŠ¸ë ˆì´ë“œì˜¤í”„

**ì¤‘ë³µ í—ˆìš©ì´ ë‚˜ì€ ê²½ìš°**:
- âœ… ë ˆì´ì–´ ìˆ˜ê°€ ì ìŒ (2-3ê°œ)
- âœ… ë³€ê²½ ë¹ˆë„ê°€ ë‚®ìŒ
- âœ… ì•ˆì •ì„±ì´ ìµœìš°ì„ 
- âœ… Terragrunt source ì œì•½ì´ ìˆìŒ

**ê³µí†µí™”ê°€ ë‚˜ì€ ê²½ìš°**:
- âœ… ë ˆì´ì–´ ìˆ˜ê°€ ë§ìŒ (10ê°œ+)
- âœ… ë³€ê²½ì´ ë¹ˆë²ˆí•¨
- âœ… in-place ì‹¤í–‰ ê°€ëŠ¥ (source ë¸”ë¡ ì—†ìŒ)

### í”„ë¡œì íŠ¸ êµ¬ì¡° ì›ì¹™

**í™˜ê²½ ë ˆì´ì–´ íŒ¨í„´**:
- ê° ë ˆì´ì–´ëŠ” ìì²´ terraform íŒŒì¼ ë³´ìœ  (10-network ë°©ì‹)
- terragrunt.hclì—ì„œ `source` ë¸”ë¡ ì—†ì´ in-place ì‹¤í–‰
- ê³µí†µ ë¡œì§ì€ `modules/`ë¡œ ì¶”ìƒí™” (low-level)
- ë ˆì´ì–´ë³„ ì°¨ì´ëŠ” `terraform.tfvars`ë¡œ ê´€ë¦¬

**ëª¨ë“ˆ ì„¤ê³„ ì›ì¹™**:
- `modules/`ëŠ” ë²”ìš©ì ì´ê³  ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„
- ë ˆì´ì–´ ê°„ ê³µí†µ ì½”ë“œë¥¼ ì–µì§€ë¡œ ê³µí†µí™”í•˜ì§€ ì•ŠìŒ
- ì¤‘ë³µ < ë³µì¡ë„ trade-off ê³ ë ¤

---

## í–¥í›„ ê°œì„  ë°©ì•ˆ

### 1. í…œí”Œë¦¿ ê¸°ë°˜ ìƒì„± (ì„ íƒì )

ìƒˆ Load Balancer ì¶”ê°€ ì‹œ í…œí”Œë¦¿ì—ì„œ ìƒì„±:

```bash
# scripts/create_loadbalancer.sh
LAYER_NAME=$1  # api, admin ë“±
cp -r templates/loadbalancer-layer environments/.../70-loadbalancers/${LAYER_NAME}/
# terraform.tfvars ìˆ˜ì •
```

### 2. ë¬¸ì„œí™” ê°•í™”

- Load Balancer ì¶”ê°€ ê°€ì´ë“œ ì‘ì„±
- lobby/web ìˆ˜ì • ì‹œ ë‘˜ ë‹¤ ë³€ê²½í•´ì•¼ í•œë‹¤ëŠ” ì£¼ì˜ì‚¬í•­ ëª…ì‹œ

### 3. ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] lobbyì™€ webì˜ ë¡œì§ì´ ë™ì¼í•œì§€ í™•ì¸
- [ ] ë³€ê²½ ì‹œ ë‘ í´ë” ëª¨ë‘ ìˆ˜ì •í–ˆëŠ”ì§€ ê²€ì¦

---

## ë‹¤ìŒ ì‘ì—… ì œì•ˆ

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. Jenkins ë°°í¬ í…ŒìŠ¤íŠ¸ (ì›ë³µëœ ì½”ë“œë¡œ)
2. ëª¨ë‹ˆí„°ë§ ì‹¤ì œ ì ìš© (Slack Webhook ì„¤ì •)

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„
3. Load Balancer ì¶”ê°€ ê°€ì´ë“œ ë¬¸ì„œ ì‘ì„±
4. CI/CD ê°œì„  (tflint, tfsec)

---

## ì°¸ê³  ë¬¸ì„œ

- [Terragrunt Source ë¬¸ë²•](https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/#terraform)
- [Terraform Module Sources](https://www.terraform.io/language/modules/sources)
- [Jenkins CI/CD ê°€ì´ë“œ](../guides/jenkins-cicd.md)
- [ì–´ì œ ì‘ì—… ì´ë ¥ (11ì›” 17ì¼)](./2025-11-17.md)
