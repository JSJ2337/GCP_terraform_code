# 2025-11-19 작업 내역

## 작업 개요

Jenkins 신규 프로젝트 생성 워크플로우를 대폭 간소화하여 불필요한 브랜치 생성 및 PR 프로세스를 제거했습니다.

## 주요 변경사항

### 1. Jenkins 프로젝트 생성 워크플로우 간소화

#### 배경
- 기존: Jenkins에서 `feature/create-project-{PROJECT_ID}` 브랜치를 생성하고 PR을 자동 생성
- 문제점:
  - 불필요하게 복잡한 프로세스
  - Jenkins가 detached HEAD 상태로 checkout하여 브랜치 연결 실패
  - PR 생성 시 gh CLI 의존성
  - 로컬 PC에서 받기 위해 추가 작업 필요

#### 해결 방법
- **433_code 브랜치에 직접 커밋하고 GitHub에 푸시하는 방식으로 단순화**
- Jenkins Job 실행 → 프로젝트 생성 → 433_code에 커밋 → GitHub 푸시 → 로컬에서 pull

#### 변경된 파일

**1. `Jenkinsfile.create-project`**
- ✅ Checkout stage에 브랜치 전환 로직 추가
  ```groovy
  sh """
      git checkout 433_code || git checkout -b 433_code
      git pull origin 433_code || true
  """
  ```
- ✅ Push to Remote stage 추가
  ```groovy
  def currentBranch = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
  git push origin ${currentBranch}
  ```
- ❌ Create Pull Request stage 제거
- ❌ CREATE_PR 파라미터 제거

**2. `scripts/create_project.sh`**
- ✅ 현재 브랜치에 커밋하도록 변경
  ```bash
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
  git add "environments/${ENVIRONMENT}/${PROJECT_ID}"
  git commit -m "feat: ${PROJECT_ID} 프로젝트 생성"
  ```
- ❌ 브랜치 생성 로직 제거 (`git checkout -b`)
- ❌ PR 생성 로직 제거 (gh CLI 관련)

**3. `docs/CREATE_NEW_PROJECT.md`**
- ✅ 개요 섹션 업데이트: "433_code 브랜치에 직접 커밋"으로 변경
- ✅ Jenkins 실행 결과 섹션 업데이트: PR 생성 단계 제거
- ✅ 로컬 PC에서 받기 섹션 추가
  ```bash
  git checkout 433_code
  git pull origin 433_code
  ```
- ✅ 트러블슈팅 섹션에 detached HEAD 해결 방법 추가
- ❌ PR 관련 내용 모두 제거

### 2. detached HEAD 문제 해결

#### 문제 상황
Jenkins Console Output:
```
ℹ 현재 브랜치: HEAD
[detached HEAD 6606944] feat: jsj-game-n 프로젝트 생성
```

#### 원인 분석
- Jenkins의 `checkout scm`은 특정 커밋을 checkout하여 detached HEAD 상태가 됨
- 이 상태에서 커밋하면 브랜치에 연결되지 않아 push 실패

#### 해결 방법
Jenkinsfile의 Checkout stage에서 명시적으로 브랜치 전환:
```groovy
sh """
    git checkout 433_code || git checkout -b 433_code
    git pull origin 433_code || true
"""
```

### 3. 문서 업데이트

#### 업데이트된 문서
1. **docs/CREATE_NEW_PROJECT.md**
   - 전체 워크플로우를 433_code 브랜치 기준으로 재작성
   - PR 관련 내용 제거
   - detached HEAD 트러블슈팅 추가

2. **docs/changelog/CHANGELOG.md**
   - 2025-11-19 섹션 추가
   - Jenkins 워크플로우 간소화 내역 기록

3. **docs/changelog/work_history/2025-11-19.md** (이 파일)
   - 오늘 작업 상세 내역 기록

## 실행 흐름

### Jenkins Job 실행 프로세스

```
1. Checkout
   - cleanWs() - workspace 정리
   - checkout scm
   - git checkout 433_code (detached HEAD 방지)

2. Validate Parameters
   - PROJECT_ID, PROJECT_NAME, ORGANIZATION 필수 확인
   - PROJECT_ID 형식 검증 (소문자, 숫자, 하이픈, 6-30자)

3. Check Duplicate
   - environments/{ENVIRONMENT}/{PROJECT_ID} 중복 확인

4. Install Dependencies
   - git, yq 설치 확인

5. Create Project
   - scripts/create_project.sh 실행
   - proj-default-templet 복사
   - 설정 파일 치환 (root.hcl, common.naming.tfvars 등)
   - git add & commit (433_code 브랜치)

6. Push to Remote
   - git push origin 433_code (GitHub에 푸시)

7. Success
   - 프로젝트 생성 완료 메시지 출력
```

### 로컬 PC에서 받기

```bash
git checkout 433_code
git pull origin 433_code

# 생성된 프로젝트 확인
ls terraform_gcp_infra/environments/LIVE/jsj-game-n/
```

## 테스트 결과

### 성공 케이스
- ✅ Jenkins Job 실행 성공
- ✅ jsj-game-n 프로젝트 생성 (63개 파일)
- ✅ 433_code 브랜치에 커밋
- ✅ GitHub에 정상 푸시
- ✅ 로컬 PC에서 pull로 정상 수신

### Console Output
```
16:16:55  ℹ 신규 프로젝트 생성 시작
16:16:55  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
16:16:55    PROJECT_ID     : jsj-game-n
16:16:55    PROJECT_NAME   : game-n
16:16:55    ORGANIZATION   : jsj
16:16:55    ENVIRONMENT    : LIVE
16:16:55    REGION_PRIMARY : asia-northeast3
16:16:55    REGION_BACKUP  : asia-northeast1
16:16:55  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
16:16:57  [433_code 6606944] feat: jsj-game-n 프로젝트 생성
16:16:57   63 files changed, 5084 insertions(+)
16:16:57  ✓ Git 커밋 완료
16:16:57  ✓ 프로젝트 생성 완료!
```

## 개선 효과

### Before (기존 방식)
1. Jenkins Job 실행
2. 새 브랜치 생성 (`feature/create-project-{PROJECT_ID}`)
3. PR 생성 (gh CLI 필요)
4. GitHub에서 PR 확인
5. PR 머지
6. 로컬에서 main 브랜치 pull
7. 작업 브랜치로 merge 또는 rebase

**단점:**
- 복잡한 프로세스 (7단계)
- gh CLI 의존성
- detached HEAD 에러 발생 가능
- 불필요한 브랜치 생성

### After (개선 방식)
1. Jenkins Job 실행
2. 433_code 브랜치에 직접 푸시
3. 로컬에서 `git pull origin 433_code`

**장점:**
- 간단한 프로세스 (3단계)
- 외부 의존성 없음 (gh CLI 불필요)
- detached HEAD 문제 해결
- 즉시 로컬에서 사용 가능

## 커밋 이력

```bash
63b3831 fix: detached HEAD 문제 해결
58819bb fix: Push to Remote stage 추가
8b5466f refactor: 브랜치 생성 및 PR 생성 로직 제거
4df1fdf revert: Jenkins 브랜치 빌드 번호 제거
5066e03 fix: Jenkins 브랜치 이름 중복 방지 및 코드 정리
```

---

## 추가 작업 (오후)

### 4. 70-loadbalancers 모듈 경로 오류 수정

#### 문제 발견
```
Error: Unreadable module directory
Unable to evaluate directory symlink: lstat ../../../../modules: no such file or directory
```

#### 원인 분석
- **템플릿 위치**: `proj-default-templet/70-loadbalancers/example-http/main.tf`
  - 상대 경로: `../../../../modules` (4단계 상위)
  - 실제로는 3단계만 올라가면 terraform_gcp_infra/modules 도달
- **배포 위치**: `environments/LIVE/project/70-loadbalancers/example-http/main.tf`
  - 필요한 경로: `../../../../../modules` (6단계 상위)

#### 해결 과정

**1차 시도** (커밋: a59017b)
- create_project.sh에 sed 변환 로직 추가 (step 6/6)
- 템플릿의 4단계 경로를 6단계로 자동 변환

**문제점 발견**
- 템플릿의 경로가 잘못되어 있었음 (4단계 → 저장소 밖으로 벗어남)
- 올바른 템플릿 경로는 3단계여야 함

**2차 수정** (커밋: e33f7ea)
- 템플릿 경로를 4단계 → 3단계로 수정
- 하지만 이렇게 하면 sed 변환 로직이 복잡해짐

**최종 해결** (커밋: 0c83758)
- **템플릿을 처음부터 6단계 경로로 설정**
- create_project.sh의 sed 변환 로직 완전 제거 (15줄 삭제)
- 템플릿을 그대로 복사하면 올바른 경로가 되도록 단순화

#### 변경 파일
**proj-default-templet/70-loadbalancers/example-http/main.tf**
```diff
module "naming" {
-  source = "../../../../modules/naming"
+  source = "../../../../../modules/naming"
}

module "load_balancer" {
-  source = "../../../../modules/load-balancer"
+  source = "../../../../../modules/load-balancer"
}
```

**scripts/create_project.sh**
```diff
-# -----------------------------------------------------------------------------
-# 6. 70-loadbalancers/*/main.tf - modules 경로 수정
-# -----------------------------------------------------------------------------
-log_info "[6/6] 70-loadbalancers/*/main.tf modules 경로 수정 중..."
-
-# proj-default-templet: ../../../modules (3단계)
-# environments/LIVE/project: ../../../../../modules (6단계)
-# 차이: ../ 3개 추가
-
-find "${TARGET_DIR}/70-loadbalancers" -name "main.tf" -type f 2>/dev/null | while read -r mainfile; do
-  sed -i 's|source\s*=\s*"../../../modules/|source = "../../../../../modules/|g' "${mainfile}"
-done
-
-log_success "70-loadbalancers/*/main.tf modules 경로 수정 완료"
```

### 5. create_project.sh Jenkinsfile 치환 로직 개선

#### 문제 발견
```bash
sed -i "s|TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/[^']*'|..."
```
- 'LIVE'가 하드코딩되어 있어서 QA/STG 환경 생성 불가

#### 해결 방법 (커밋: 089c10b)

**1. Configuration 섹션에 변수 추가**
```bash
# Terraform GCP Infra 디렉토리 설정 (Jenkinsfile에서 사용)
TF_GCP_INFRA_DIR_NAME="terraform_gcp_infra"
```

**2. sed 패턴 개선**
```bash
# 기존 (LIVE만 매칭)
sed -i "s|TG_WORKING_DIR = 'terraform_gcp_infra/environments/LIVE/[^']*'|..."

# 개선 (LIVE/QA/STG 모두 매칭)
sed -i "s|TG_WORKING_DIR = '${TF_GCP_INFRA_DIR_NAME}/${ENVIRONMENTS_DIR_NAME}/[^/]*/[^']*'|..."
```

#### 효과
- QA, STG 환경에서도 정상적으로 프로젝트 생성 가능
- 유지보수성 향상 (경로가 변경되어도 Configuration 섹션만 수정)

### 6. 스크립트 유지보수성 향상

#### create_project.sh Configuration 섹션 추가
```bash
# =============================================================================
# 설정값 (Configuration)
# =============================================================================

# 기본 리전 설정
DEFAULT_REGION_BACKUP="asia-northeast1"  # 도쿄

# Terraform Remote State 설정 (yq 없을 때 사용될 기본값)
DEFAULT_REMOTE_STATE_BUCKET="jsj-terraform-state-prod"
DEFAULT_REMOTE_STATE_PROJECT="jsj-system-mgmt"
DEFAULT_REMOTE_STATE_LOCATION="US"

# GCP 조직 및 빌링 설정 (yq 없을 때 사용될 기본값)
DEFAULT_ORG_ID="REDACTED_ORG_ID"
DEFAULT_BILLING_ACCOUNT="REDACTED_BILLING_ACCOUNT"

# 디렉토리 및 파일명 설정
CONFIG_FILE_NAME="configs/defaults.yaml"
TEMPLATE_DIR_NAME="proj-default-templet"
ENVIRONMENTS_DIR_NAME="environments"
TF_GCP_INFRA_DIR_NAME="terraform_gcp_infra"
```

#### gcp_project_guard.sh Configuration 섹션 + 한글 주석
```bash
# =============================================================================
# 설정값 (Configuration)
# =============================================================================

# Bootstrap 디렉토리 설정
BOOTSTRAP_DIR_NAME="bootstrap"

# 폴더 구조 기본값 (bootstrap에서 찾지 못했을 때 사용)
DEFAULT_FOLDER_PRODUCT="games"      # 제품/서비스 구분
DEFAULT_FOLDER_REGION="kr-region"   # 리전 구분
DEFAULT_FOLDER_ENV="LIVE"           # 환경 구분 (LIVE/QA/STG)

# IAM 역할 설정
ROLE_ORG_PROJECT_CREATOR="roles/resourcemanager.projectCreator"
ROLE_ORG_EDITOR="roles/editor"
ROLE_BILLING_USER="roles/billing.user"
ROLE_PROJECT_EDITOR="roles/editor"
```

#### setup_slack_webhook.sh Configuration 섹션 + 한글 메시지
```bash
# =============================================================================
# 설정값 (Configuration)
# =============================================================================

# Secret Manager 설정
SECRET_NAME="slack-webhook-url"
SECRET_REPLICATION_POLICY="automatic"
API_NAME="secretmanager.googleapis.com"
```

### 7. Terragrunt mock_outputs 개선

#### 문제 발견
```
./50-workloads/terragrunt.hcl is a dependency... but detected no outputs
```

#### 원인
```hcl
mock_outputs_allowed_terraform_commands = ["validate", "plan"]
```
- "init" 명령어가 빠져 있어서 terragrunt init 시 에러 발생

#### 해결 (4개 파일 수정)
```hcl
mock_outputs_allowed_terraform_commands = ["init", "validate", "plan"]
```

**수정된 파일:**
1. `proj-default-templet/70-loadbalancers/example-http/terragrunt.hcl`
2. `environments/LIVE/jsj-game-m/70-loadbalancers/web/terragrunt.hcl`
3. `environments/LIVE/jsj-game-m/70-loadbalancers/lobby/terragrunt.hcl`
4. `environments/LIVE/jsj-game-n/70-loadbalancers/example-http/terragrunt.hcl`

### 8. 65-cache variables.tf 누락 변수 추가

#### 문제 발견
```
Warning: Value for undeclared variable

The root module does not declare a variable named "deletion_protection" but
a value was found in file "terraform.tfvars".
```

#### 원인 분석
- **레이어 구조**: 65-cache는 in-place 실행 방식
- **변수 선언 위치**:
  - ✅ `modules/memorystore-redis/variables.tf`: deletion_protection 선언 있음
  - ❌ `65-cache/variables.tf`: deletion_protection 선언 없음
- **문제**: in-place 실행은 레이어 자체의 variables.tf도 필요

#### 조사 과정
1. 처음에 모듈에서도 지원 안 하는 줄 알고 terraform.tfvars에서 삭제 (커밋: a7eb691)
2. 인터넷 검색으로 GCP Redis Memorystore에 deletion_protection 기능 확인
3. 모듈 코드 확인: `main.tf:78`에서 `deletion_protection_enabled = var.deletion_protection` 사용 중
4. 잘못 삭제한 것 확인하고 revert (커밋: f936b47)
5. 실제 원인 발견: 레이어의 variables.tf에 변수 선언이 없었음

#### 해결 (커밋: de00df3)

**추가된 변수 (3개 파일)**
```hcl
variable "deletion_protection" {
  type        = bool
  description = "삭제 방지 활성화 (true: 삭제 방지, false: 삭제 허용)"
  default     = true
}

variable "enterprise_node_type" {
  type        = string
  description = "Enterprise 티어용 노드 타입"
  default     = "REDIS_STANDARD_SMALL"
}

variable "enterprise_authorization_mode" {
  type        = string
  description = "Enterprise 티어 인증 모드"
  default     = "AUTH_MODE_DISABLED"
}

variable "enterprise_transit_encryption_mode" {
  type        = string
  description = "Enterprise 티어 전송 암호화 모드"
  default     = "TRANSIT_ENCRYPTION_MODE_SERVER_AUTHENTICATION"
}

variable "enterprise_redis_configs" {
  type        = map(string)
  description = "Enterprise 클러스터용 추가 Redis 설정"
  default     = {}
}
```

**수정된 파일:**
1. `proj-default-templet/65-cache/variables.tf`
2. `environments/LIVE/jsj-game-m/65-cache/variables.tf`
3. `environments/LIVE/jsj-game-n/65-cache/variables.tf`

## 최종 커밋 이력 (오후 작업)

```bash
de00df3 fix: 65-cache variables.tf에 deletion_protection 및 Enterprise 변수 추가
f936b47 Revert "fix: 65-cache에서 미지원 deletion_protection 변수 제거"
a7eb691 fix: 65-cache에서 미지원 deletion_protection 변수 제거 (잘못된 수정)
089c10b fix: Jenkinsfile 치환 로직을 모든 환경(LIVE/QA/STG)에 대응하도록 수정
0c83758 refactor: 템플릿 경로를 최종 배포 경로에 맞게 수정하여 단순화
e33f7ea fix: proj-default-templet의 module 경로 수정 (4단계 → 3단계)
a59017b fix: 70-loadbalancers module 경로 오류 수정
```

## 향후 작업

- [ ] Jenkins Job 설정 문서화 (Branch Specifier 설정 등)
- [ ] 다른 환경(QA, STG)에서도 테스트
- [ ] CI/CD 파이프라인에 자동 테스트 추가 검토
- [x] 모듈 경로 문제 해결
- [x] QA/STG 환경 지원
- [x] variables.tf 누락 변수 추가

## 참고 자료

- [docs/CREATE_NEW_PROJECT.md](../CREATE_NEW_PROJECT.md)
- [docs/JENKINS_GITHUB_SETUP.md](../JENKINS_GITHUB_SETUP.md)
- [Jenkinsfile.create-project](../../Jenkinsfile.create-project)
- [scripts/create_project.sh](../../scripts/create_project.sh)
- [modules/memorystore-redis](../../modules/memorystore-redis)
