# 2025-11-19 작업 내역

## 작업 개요

Jenkins 신규 프로젝트 생성 워크플로우를 대폭 간소화하여 불필요한 브랜치 생성 및 PR 프로세스를 제거했습니다.

## 주요 변경사항

### 1. Jenkins 프로젝트 생성 워크플로우 간소화

#### 배경
- 기존: Jenkins에서 `feature/create-project-{PROJECT_ID}` 브랜치를 생성하고 PR을 자동 생성
- 문제점:
  - 불필요하게 복잡한 프로세스
  - Jenkins가 detached HEAD 상태로 checkout하여 브랜치 연결 실패
  - PR 생성 시 gh CLI 의존성
  - 로컬 PC에서 받기 위해 추가 작업 필요

#### 해결 방법
- **433_code 브랜치에 직접 커밋하고 GitHub에 푸시하는 방식으로 단순화**
- Jenkins Job 실행 → 프로젝트 생성 → 433_code에 커밋 → GitHub 푸시 → 로컬에서 pull

#### 변경된 파일

**1. `Jenkinsfile.create-project`**
- ✅ Checkout stage에 브랜치 전환 로직 추가
  ```groovy
  sh """
      git checkout 433_code || git checkout -b 433_code
      git pull origin 433_code || true
  """
  ```
- ✅ Push to Remote stage 추가
  ```groovy
  def currentBranch = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
  git push origin ${currentBranch}
  ```
- ❌ Create Pull Request stage 제거
- ❌ CREATE_PR 파라미터 제거

**2. `scripts/create_project.sh`**
- ✅ 현재 브랜치에 커밋하도록 변경
  ```bash
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
  git add "environments/${ENVIRONMENT}/${PROJECT_ID}"
  git commit -m "feat: ${PROJECT_ID} 프로젝트 생성"
  ```
- ❌ 브랜치 생성 로직 제거 (`git checkout -b`)
- ❌ PR 생성 로직 제거 (gh CLI 관련)

**3. `docs/CREATE_NEW_PROJECT.md`**
- ✅ 개요 섹션 업데이트: "433_code 브랜치에 직접 커밋"으로 변경
- ✅ Jenkins 실행 결과 섹션 업데이트: PR 생성 단계 제거
- ✅ 로컬 PC에서 받기 섹션 추가
  ```bash
  git checkout 433_code
  git pull origin 433_code
  ```
- ✅ 트러블슈팅 섹션에 detached HEAD 해결 방법 추가
- ❌ PR 관련 내용 모두 제거

### 2. detached HEAD 문제 해결

#### 문제 상황
Jenkins Console Output:
```
ℹ 현재 브랜치: HEAD
[detached HEAD 6606944] feat: jsj-game-n 프로젝트 생성
```

#### 원인 분석
- Jenkins의 `checkout scm`은 특정 커밋을 checkout하여 detached HEAD 상태가 됨
- 이 상태에서 커밋하면 브랜치에 연결되지 않아 push 실패

#### 해결 방법
Jenkinsfile의 Checkout stage에서 명시적으로 브랜치 전환:
```groovy
sh """
    git checkout 433_code || git checkout -b 433_code
    git pull origin 433_code || true
"""
```

### 3. 문서 업데이트

#### 업데이트된 문서
1. **docs/CREATE_NEW_PROJECT.md**
   - 전체 워크플로우를 433_code 브랜치 기준으로 재작성
   - PR 관련 내용 제거
   - detached HEAD 트러블슈팅 추가

2. **docs/changelog/CHANGELOG.md**
   - 2025-11-19 섹션 추가
   - Jenkins 워크플로우 간소화 내역 기록

3. **docs/changelog/work_history/2025-11-19.md** (이 파일)
   - 오늘 작업 상세 내역 기록

## 실행 흐름

### Jenkins Job 실행 프로세스

```
1. Checkout
   - cleanWs() - workspace 정리
   - checkout scm
   - git checkout 433_code (detached HEAD 방지)

2. Validate Parameters
   - PROJECT_ID, PROJECT_NAME, ORGANIZATION 필수 확인
   - PROJECT_ID 형식 검증 (소문자, 숫자, 하이픈, 6-30자)

3. Check Duplicate
   - environments/{ENVIRONMENT}/{PROJECT_ID} 중복 확인

4. Install Dependencies
   - git, yq 설치 확인

5. Create Project
   - scripts/create_project.sh 실행
   - proj-default-templet 복사
   - 설정 파일 치환 (root.hcl, common.naming.tfvars 등)
   - git add & commit (433_code 브랜치)

6. Push to Remote
   - git push origin 433_code (GitHub에 푸시)

7. Success
   - 프로젝트 생성 완료 메시지 출력
```

### 로컬 PC에서 받기

```bash
git checkout 433_code
git pull origin 433_code

# 생성된 프로젝트 확인
ls terraform_gcp_infra/environments/LIVE/jsj-game-n/
```

## 테스트 결과

### 성공 케이스
- ✅ Jenkins Job 실행 성공
- ✅ jsj-game-n 프로젝트 생성 (63개 파일)
- ✅ 433_code 브랜치에 커밋
- ✅ GitHub에 정상 푸시
- ✅ 로컬 PC에서 pull로 정상 수신

### Console Output
```
16:16:55  ℹ 신규 프로젝트 생성 시작
16:16:55  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
16:16:55    PROJECT_ID     : jsj-game-n
16:16:55    PROJECT_NAME   : game-n
16:16:55    ORGANIZATION   : jsj
16:16:55    ENVIRONMENT    : LIVE
16:16:55    REGION_PRIMARY : asia-northeast3
16:16:55    REGION_BACKUP  : asia-northeast1
16:16:55  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
16:16:57  [433_code 6606944] feat: jsj-game-n 프로젝트 생성
16:16:57   63 files changed, 5084 insertions(+)
16:16:57  ✓ Git 커밋 완료
16:16:57  ✓ 프로젝트 생성 완료!
```

## 개선 효과

### Before (기존 방식)
1. Jenkins Job 실행
2. 새 브랜치 생성 (`feature/create-project-{PROJECT_ID}`)
3. PR 생성 (gh CLI 필요)
4. GitHub에서 PR 확인
5. PR 머지
6. 로컬에서 main 브랜치 pull
7. 작업 브랜치로 merge 또는 rebase

**단점:**
- 복잡한 프로세스 (7단계)
- gh CLI 의존성
- detached HEAD 에러 발생 가능
- 불필요한 브랜치 생성

### After (개선 방식)
1. Jenkins Job 실행
2. 433_code 브랜치에 직접 푸시
3. 로컬에서 `git pull origin 433_code`

**장점:**
- 간단한 프로세스 (3단계)
- 외부 의존성 없음 (gh CLI 불필요)
- detached HEAD 문제 해결
- 즉시 로컬에서 사용 가능

## 커밋 이력

```bash
63b3831 fix: detached HEAD 문제 해결
58819bb fix: Push to Remote stage 추가
8b5466f refactor: 브랜치 생성 및 PR 생성 로직 제거
4df1fdf revert: Jenkins 브랜치 빌드 번호 제거
5066e03 fix: Jenkins 브랜치 이름 중복 방지 및 코드 정리
```

## 향후 작업

- [ ] Jenkins Job 설정 문서화 (Branch Specifier 설정 등)
- [ ] 다른 환경(QA, STG)에서도 테스트
- [ ] CI/CD 파이프라인에 자동 테스트 추가 검토

## 참고 자료

- [docs/CREATE_NEW_PROJECT.md](../CREATE_NEW_PROJECT.md)
- [docs/JENKINS_GITHUB_SETUP.md](../JENKINS_GITHUB_SETUP.md)
- [Jenkinsfile.create-project](../../Jenkinsfile.create-project)
- [scripts/create_project.sh](../../scripts/create_project.sh)
