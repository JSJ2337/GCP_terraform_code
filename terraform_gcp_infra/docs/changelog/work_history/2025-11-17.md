# ì‘ì—… íˆìŠ¤í† ë¦¬ - 2025ë…„ 11ì›” 17ì¼

## ì‘ì—… ê°œìš”

Jenkins ë°°í¬ ì˜¤ë¥˜ ìˆ˜ì •, ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•, ì½”ë“œ ì¤‘ë³µ ì œê±° ì‘ì—…ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

---

## 1. ğŸ› gcp_project_guard.sh exit code 1 ë¬¸ì œ ìˆ˜ì •

### ë¬¸ì œ ìƒí™©
```
ğŸ›¡ï¸  Ensuring GCP project prerequisites...
[INFO] Project jsj-game-m already exists.
script returned exit code 1
```

Jenkins ë°°í¬ ì¤‘ gcp_project_guard.sh ìŠ¤í¬ë¦½íŠ¸ê°€ ì •ìƒ ë™ì‘í–ˆìŒì—ë„ exit code 1ì„ ë°˜í™˜í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨

### ì›ì¸ ë¶„ì„
- ìŠ¤í¬ë¦½íŠ¸ê°€ `set -euo pipefail`ë¡œ ì‹¤í–‰
- early return íŒ¨í„´ `|| return`ì´ ì¸ì ì—†ì´ í˜¸ì¶œë˜ë©´ ë§ˆì§€ë§‰ ëª…ë ¹ì˜ exit code(1)ë¥¼ ë°˜í™˜
- `FOLDER_ID`ê°€ ë¹„ì–´ìˆì„ ë•Œ `ensure_project_parent()` í•¨ìˆ˜ì—ì„œ ì‹¤íŒ¨

### í•´ê²° ë°©ë²•
**ìˆ˜ì •ëœ í•¨ìˆ˜ë“¤**:
```bash
# Before
ensure_project_parent() {
  [[ -n "${FOLDER_ID:-}" ]] || return  # exit code 1 ë°˜í™˜
}

# After
ensure_project_parent() {
  [[ -n "${FOLDER_ID:-}" ]] || return 0  # ëª…ì‹œì ìœ¼ë¡œ 0 ë°˜í™˜
}
```

**ìˆ˜ì •í•œ 5ê°œ í•¨ìˆ˜**:
1. `ensure_project_parent:228`
2. `ensure_org_binding:269`
3. `ensure_billing_binding:289`
4. `ensure_project_binding:310`
5. `enable_apis:331`

**ì¶”ê°€ ìˆ˜ì •**:
- `lookup_folder_from_bootstrap` ë³€ìˆ˜ ì°¸ì¡° ì˜¤ë¥˜: `\$1` â†’ `$1`

### ê´€ë ¨ íŒŒì¼
- `terraform_gcp_infra/scripts/gcp_project_guard.sh`
- `terraform_gcp_infra/docs/guides/jenkins-cicd.md`
- `terraform_gcp_infra/docs/troubleshooting/common-errors.md`

### ì»¤ë°‹
```
a19ce18 - fix: gcp_project_guard ìŠ¤í¬ë¦½íŠ¸ early return exit code ìˆ˜ì •
```

---

## 2. ğŸ”§ Terraform Provider Lock íŒŒì¼ ìˆ˜ì •

### ë¬¸ì œ ìƒí™©
```
Error: Required plugins are not installed
The installed provider plugins are not consistent with the packages
selected in the dependency lock file:
  - registry.terraform.io/hashicorp/google-beta
```

40-observabilityì™€ 70-loadbalancers/web ë ˆì´ì–´ì—ì„œ provider checksum ë¶ˆì¼ì¹˜ ì˜¤ë¥˜

### í•´ê²° ë°©ë²•
00-projectì˜ ì™„ì „í•œ lock íŒŒì¼ì„ ëª¨ë“  ë ˆì´ì–´ì— ë³µì‚¬í•˜ì—¬ í†µì¼

**ì˜í–¥ ë°›ì€ ë ˆì´ì–´ (8ê°œ)**:
- 10-network, 20-storage, 30-security
- 40-observability, 50-workloads, 65-cache
- 70-loadbalancers/lobby, 70-loadbalancers/web

**ì¶”ê°€ëœ Provider ì •ë³´**:
- `google-beta 7.11.0` (12ê°œ checksum)
- `time 0.13.1` (12ê°œ checksum)

### ì»¤ë°‹
```
5b20b35 - fix: terraform provider lock íŒŒì¼ì— google-beta ì¶”ê°€
7d1bb22 - docs: provider lock íŒŒì¼ ì—ëŸ¬ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì¶”ê°€
```

---

## 3. ğŸ“Š Slack ì—°ë™ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•

### êµ¬í˜„ ë‚´ìš©

#### 3.1 Slack Notification Channel ìë™í™”
- Secret Managerì—ì„œ Webhook URL ì•ˆì „í•˜ê²Œ ê´€ë¦¬
- Terraformìœ¼ë¡œ Notification Channel ìë™ ìƒì„±
- ëª¨ë“  Alert Policyì— ìë™ ì—°ê²°

#### 3.2 ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ í™œì„±í™” (4ê°€ì§€)

**1. VM CPU ì•Œë¦¼**
- ì„ê³„ê°’: 85% (5ë¶„ ì§€ì†)
- í•„í„°: `^jsj-game-m-.*`

**2. Cloud SQL CPU ì•Œë¦¼**
- ì„ê³„ê°’: 75% (10ë¶„ ì§€ì†)
- í•„í„°: `^jsj-game-m:asia-northeast3:jsj-game-m-mysql$`

**3. Redis ë©”ëª¨ë¦¬ ì•Œë¦¼**
- ì„ê³„ê°’: 80% (5ë¶„ ì§€ì†)
- í•„í„°: `^projects/jsj-game-m/locations/asia-northeast3/instances/jsj-game-m-redis$`

**4. Load Balancer 5xx ì•Œë¦¼**
- ì„ê³„ê°’: ë¶„ë‹¹ 10ê°œ (5ë¶„ ì§€ì†)
- í•„í„°: `^jsj-game-m-.*-(http|https)-proxy$`

#### 3.3 í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë° ë¬¸ì„œ

**ìŠ¤í¬ë¦½íŠ¸**: `scripts/setup_slack_webhook.sh`
```bash
./scripts/setup_slack_webhook.sh jsj-system-mgmt \
  "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
```

**ë¬¸ì„œ**: `docs/operations/monitoring-setup.md`
- ì™„ì „í•œ ì„¤ì • ê°€ì´ë“œ (Slack â†’ Secret Manager â†’ Terraform)
- ì„ê³„ê°’ íŠœë‹ ê°€ì´ë“œ
- Regex íŒ¨í„´ ì˜ˆì‹œ
- íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ê´€ë ¨ íŒŒì¼
- `terraform_gcp_infra/modules/observability/` (main.tf, variables.tf, outputs.tf)
- `terraform_gcp_infra/environments/LIVE/jsj-game-m/40-observability/terraform.tfvars`
- `terraform_gcp_infra/scripts/setup_slack_webhook.sh`
- `terraform_gcp_infra/docs/operations/monitoring-setup.md`

### ì»¤ë°‹
```
eab9c36 - feat: Slack ì—°ë™ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•
```

---

## 4. â™»ï¸ Load Balancer ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê³µí†µ ëª¨ë“ˆí™”

### ë¬¸ì œ ë¶„ì„
**ì¤‘ë³µ ì½”ë“œ**: ì•½ **700ì¤„**
- lobby/web í´ë”ì— main.tf, variables.tf, outputs.tfê°€ 100% ë™ì¼

### ë¦¬íŒ©í† ë§ ì „ëµ

**Before**:
```
70-loadbalancers/
â”œâ”€â”€ lobby/
â”‚   â”œâ”€â”€ main.tf (124ì¤„)
â”‚   â”œâ”€â”€ variables.tf (200ì¤„)
â”‚   â”œâ”€â”€ outputs.tf (30ì¤„)
â”‚   â””â”€â”€ terragrunt.hcl
â””â”€â”€ web/ (ë™ì¼í•œ íŒŒì¼ë“¤)
```

**After**:
```
70-loadbalancers/
â”œâ”€â”€ _common/           â† ê³µí†µ ì½”ë“œ
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â””â”€â”€ outputs.tf
â”œâ”€â”€ lobby/             â† ì„¤ì •ë§Œ
â”‚   â”œâ”€â”€ terragrunt.hcl (source = "../_common")
â”‚   â””â”€â”€ terraform.tfvars
â””â”€â”€ web/               â† ì„¤ì •ë§Œ
    â”œâ”€â”€ terragrunt.hcl (source = "../_common")
    â””â”€â”€ terraform.tfvars
```

### íš¨ê³¼
- âœ… ì½”ë“œ ì¤‘ë³µ ì œê±°: 700ì¤„ â†’ 0ì¤„
- âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ: _commonë§Œ ìˆ˜ì •
- âœ… ì¼ê´€ì„± ë³´ì¥
- âœ… ìƒˆ LB ì¶”ê°€ ìš©ì´

### Git ë³€ê²½ì‚¬í•­
```
8 files changed, 10 insertions(+), 538 deletions(-)
```

### ì»¤ë°‹
```
0413bf5 - refactor: Load Balancer ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê³µí†µ ëª¨ë“ˆí™”
```

---

## ì „ì²´ ì»¤ë°‹ ì´ë ¥

```
a19ce18 - fix: gcp_project_guard ìŠ¤í¬ë¦½íŠ¸ early return exit code ìˆ˜ì •
5b20b35 - fix: terraform provider lock íŒŒì¼ì— google-beta ì¶”ê°€
7d1bb22 - docs: provider lock íŒŒì¼ ì—ëŸ¬ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì¶”ê°€
eab9c36 - feat: Slack ì—°ë™ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•
0413bf5 - refactor: Load Balancer ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê³µí†µ ëª¨ë“ˆí™”
```

---

## ë‹¤ìŒ ì‘ì—… ì œì•ˆ

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. ëª¨ë‹ˆí„°ë§ ì‹¤ì œ ì ìš© (Slack Webhook ì„¤ì •)
2. ë³´ì•ˆ ê°•í™” (.gitignore, Jenkins SA ê¶Œí•œ)

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„
3. CI/CD ê°œì„  (tflint, tfsec)
4. ë¹„ìš© ê´€ë¦¬ (Budget í™œì„±í™”)

---

## ì°¸ê³  ë¬¸ì„œ
- [Jenkins CI/CD ê°€ì´ë“œ](../guides/jenkins-cicd.md)
- [ëª¨ë‹ˆí„°ë§ ì„¤ì • ê°€ì´ë“œ](../operations/monitoring-setup.md)
- [íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ](../troubleshooting/common-errors.md)
