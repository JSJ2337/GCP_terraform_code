# 2025-11-20 작업 내역

## 개요
10-network 레이어의 서브넷 이름 및 리전 동적 생성 구현 완료. 템플릿 재사용성을 위한 하드코딩 제거 작업.

## 주요 변경사항

### 1. 10-network 레이어 동적 생성 구현
**목적**: proj-default-templet을 복사하여 새 프로젝트 생성 시 `common.naming.tfvars`만 수정하면 모든 리소스 이름이 자동 생성되도록 개선

#### terraform.tfvars 변경
**이전 (하드코딩)**:
```hcl
additional_subnets = [
  {
    name   = "game-l-subnet-dmz"
    region = "asia-northeast3"
    cidr   = "10.3.0.0/24"
  },
  {
    name   = "game-l-subnet-private"
    region = "asia-northeast3"
    cidr   = "10.3.1.0/24"
  },
  {
    name   = "game-l-subnet-db"
    region = "asia-northeast3"
    cidr   = "10.3.2.0/24"
  }
]

dmz_subnet_name     = "game-l-subnet-dmz"
private_subnet_name = "game-l-subnet-private"
db_subnet_name      = "game-l-subnet-db"

memorystore_psc_region      = "asia-northeast3"
memorystore_psc_subnet_name = "game-l-subnet-private"
```

**변경 후 (CIDR만 정의)**:
```hcl
# name, region은 terragrunt.hcl에서 project_name, region_primary 기반 자동 생성
additional_subnets = [
  {
    cidr = "10.3.0.0/24"  # DMZ subnet
  },
  {
    cidr = "10.3.1.0/24"  # Private subnet
  },
  {
    cidr = "10.3.2.0/24"  # DB subnet
  }
]

# Subnet 이름은 terragrunt.hcl에서 자동 생성
# memorystore_psc_region과 memorystore_psc_subnet_name은 terragrunt.hcl에서 자동 생성
enable_memorystore_psc_policy = true
memorystore_psc_connection_limit = 8
```

#### terragrunt.hcl 변경
**추가된 로직**:
```hcl
locals {
  # 프로젝트명과 리전 추출
  project_name   = local.common_inputs.project_name
  region_primary = local.common_inputs.region_primary

  # Subnet 이름 자동 생성
  subnet_types = ["dmz", "private", "db"]

  # additional_subnets에 name과 region 자동 추가
  additional_subnets_with_metadata = [
    for idx, subnet in try(local.layer_inputs.additional_subnets, []) :
    merge(subnet, {
      name   = "${local.project_name}-subnet-${local.subnet_types[idx]}"
      region = local.region_primary
    })
  ]

  # Subnet 이름들
  dmz_subnet_name     = "${local.project_name}-subnet-dmz"
  private_subnet_name = "${local.project_name}-subnet-private"
  db_subnet_name      = "${local.project_name}-subnet-db"

  # Memorystore PSC 설정
  memorystore_psc_region      = local.region_primary
  memorystore_psc_subnet_name = local.private_subnet_name

  # layer_inputs에서 additional_subnets 제외 (terragrunt에서 처리한 버전을 사용)
  layer_inputs_without_subnets = { for k, v in local.layer_inputs : k => v if k != "additional_subnets" }
}

inputs = merge(
  local.common_inputs,
  local.layer_inputs_without_subnets,
  {
    additional_subnets          = local.additional_subnets_with_metadata
    dmz_subnet_name             = local.dmz_subnet_name
    private_subnet_name         = local.private_subnet_name
    db_subnet_name              = local.db_subnet_name
    memorystore_psc_region      = local.memorystore_psc_region
    memorystore_psc_subnet_name = local.memorystore_psc_subnet_name
  }
)
```

#### variables.tf 변경
**문제**: Terraform이 terraform.tfvars를 검증할 때는 terragrunt의 inputs merge가 아직 실행되지 않아 `name`과 `region`이 required면 에러 발생

**해결**: optional로 변경
```hcl
variable "additional_subnets" {
  description = "추가로 생성할 서브넷 목록 (DMZ, Private/WAS, DB 등 역할 기반 서브넷)"
  type = list(object({
    name                  = optional(string)  # string -> optional(string)
    region                = optional(string)  # string -> optional(string)
    cidr                  = string
    private_google_access = optional(bool, true)
    secondary_ranges = optional(list(object({
      name = string
      cidr = string
    })), [])
  }))
  default = []
}
```

### 2. Terragrunt Inputs Merge 충돌 해결
**문제**: `local.layer_inputs`에 `additional_subnets`가 포함되어 있어 merge 시 terraform.tfvars의 값(name 없음)이 전달되는 문제 발생

**증상**:
```
Error: Invalid object key
  on main.tf line 32, in locals:
  32:     subnet.name => {
      ├────────────────
      │ subnet.name is null

Key expression in 'for' expression must not produce a null value.
```

**해결**:
```hcl
# layer_inputs에서 additional_subnets를 제외한 버전 생성
layer_inputs_without_subnets = { for k, v in local.layer_inputs : k => v if k != "additional_subnets" }

inputs = merge(
  local.common_inputs,
  local.layer_inputs_without_subnets,  # layer_inputs 대신 사용
  {
    additional_subnets = local.additional_subnets_with_metadata  # terragrunt가 처리한 버전만 전달
    ...
  }
)
```

### 3. jsj-game-m 프로젝트 삭제
- 더 이상 사용하지 않는 jsj-game-m 프로젝트 전체 삭제
- 89개 파일, 7,372줄 제거
- 현재 LIVE 환경에는 jsj-game-n 프로젝트만 유지

### 4. 문서 업데이트
**proj-default-templet/10-network/README.md 업데이트**:
- 동적 생성 구조 설명 추가
- terraform.tfvars 예시를 CIDR만 정의하는 버전으로 업데이트
- terragrunt.hcl 자동 생성 로직 설명 추가
- 50-workloads에서 사용하는 방법 업데이트

### 5. 템플릿 70-loadbalancers 레이어 추가
- **배경**: 템플릿에 example-http 단일 디렉터리만 있어, jsj-game-n에서 검증된 web/app/lobby 패턴을 신규 환경에 즉시 복제하기 어려웠음.
- **작업**:
  - `proj-default-templet/70-loadbalancers`에 `web`, `app`, `lobby` 전체 디렉터리(terragrunt/main/variables/outputs/tfvars/example)를 jsj-game-n에서 그대로 이식.
  - Jenkins/Terragrunt 의존성 및 `auto_instance_groups` 필터도 동일하게 유지해 템플릿을 바로 사용할 수 있도록 함.
- **결과**: 템플릿만으로도 세 가지 LB 패턴을 선택해 배포할 수 있으며, create_project.sh가 추가 수정 없이 복사 가능.

### 6. 로드밸런서 네이밍 자동화 (proj-default-templet & jsj-game-n)
- **문제**: 각 tfvars에 `game-n-*` 또는 `default-templet-*` 이름이 하드코딩되어 Terragrunt 없이 `terraform apply`시 프로젝트마다 직접 값을 수정해야 했음.
- **해결**:
  - `terragrunt.hcl`에 `lb_prefix = "${project_name}-${layer_name}"` 로컬을 추가하고, 입력에 이름이 비어 있으면 `*-backend`, `*-url-map`, `*-http-proxy`, `*-lb`, `*-ip`, `*-health` 값을 자동 생성.
  - tfvars에서는 공통 파라미터만 유지해 템플릿/운영 환경 모두 동일 로직을 사용.
- **효과**: 새 프로젝트 추가 시 이름 충돌 없이 일관된 네이밍을 얻으며, 필요할 경우 tfvars에 특정 이름을 덮어쓰는 것도 여전히 가능.

### 7. Cloud SQL 읽기 복제본 입력 보강
- **증상**: Terragrunt가 Plan 시 region/name을 주입해도 Jenkins에서 직접 `terraform apply`를 호출하면 `trimspace(null)` 오류가 발생.
- **조치**:
  - `proj-default-templet` 및 `jsj-game-n` 60-database/main.tf에 정렬된 replica 목록을 만들어, 입력값이 비어 있으면 마스터 리전/자동 이름(`{db_instance_name}-read-XX`)을 채우도록 로직 보강.
  - `variables.tf`에서 `name`, `region`을 optional로 선언해 Terragrunt 주입 전에 Terraform이 검증에 실패하지 않도록 함.
  - 여러 차례 null 처리 보강 후 `can(trimspace(...))` 패턴으로 최종 안정화.
- **결과**: Terragrunt/순수 Terraform 실행 모두에서 읽기 복제본 생성이 안정화되었으며 Jenkins 파이프라인도 더 이상 동일 오류로 중단되지 않음.

### 8. 20-storage CORS 도메인 자동화
- **문제**: Assets 버킷 CORS 규칙에 `default-templet` 도메인이 직접 쓰여 있어 템플릿/운영 환경 모두에서 프로젝트 이름을 바꿀 때마다 수동 수정 필요.
- **해결**:
  - Terragrunt locals에서 `project_name`을 바탕으로 기본 CORS 규칙(`https://{project}.example.com`, `https://cdn.{project}.example.com`)을 생성하고 tfvars에서는 옵션으로만 override.
  - tfvars 파일에는 버킷 설정만 남겨 새 프로젝트에 그대로 복사 가능.
  - locals 간 참조 시 `local.` 접두사가 누락되어 Jenkins 실행이 실패한 문제도 바로잡음.
- **결과**: 템플릿·jsj-game-n 모두 새 프로젝트 이름에 맞는 CORS 도메인을 자동으로 사용하며, 필요 시 tfvars에 커스텀 규칙을 선언하면 그대로 적용됨.

## 적용 범위
- `proj-default-templet/10-network/`, `environments/LIVE/jsj-game-n/10-network/`
- `proj-default-templet/70-loadbalancers/{web,app,lobby}/`
- `environments/LIVE/jsj-game-n/70-loadbalancers/{web,app,lobby}/`
- `proj-default-templet/60-database/`, `environments/LIVE/jsj-game-n/60-database/`

## 기대 효과
1. **템플릿 재사용성 향상**: 서브넷·로드밸런서·읽기 복제본 이름이 모두 자동 생성되어 신규 프로젝트 세팅 시 tfvars 최소화.
2. **휴먼 에러 감소**: 수동 네이밍/리전 입력이 불필요해 오타나 불일치 방지.
3. **일관성 보장**: 모든 프로젝트가 동일한 네이밍 규칙(`{project_name}-{layer}-{suffix}`)을 따름.
4. **유지보수 용이성**: 네이밍 규칙 변경 시 Terragrunt locals만 수정하면 전체 환경에 즉시 반영.

## 관련 커밋
- `5a030ea`, `9fc2321`, `731ebdc` - 10-network 서브넷 동적 생성
- `777c1e4`, `140da48` - 템플릿 70-loadbalancers web/app/lobby 디렉터리 추가 및 정리
- `249552d`, `292f933` - 로드밸런서 이름 자동화(템플릿/게임-n)
- `b7fee4a`, `7c02390`, `aeb8bc9`, `013d499`, `ca68cd8` - Cloud SQL 읽기 복제본 기본값·null-safe 처리
- `6f1241d` - jsj-game-m 환경 삭제
- `8c48ec1` - 20-storage CORS 도메인 자동화
- `3946d90` - 20-storage Terragrunt locals 참조 오류 수정

## 향후 작업
- [ ] 50-workloads 레이어도 동적 생성으로 전환 (현재 `subnetwork_self_link` 하드코딩)
- [ ] 나머지 레이어(예: 20-storage CORS, 65-cache display_name)도 Terragrunt locals로 단계적 정리

## 주의사항
- 기존에 배포된 인프라는 영향 없음 (리소스 이름이 변경되지 않음)
- 새로운 프로젝트 또는 Jenkins 재배포 시 자동 네이밍이 적용되므로, tfvars에 이름을 직접 설정하면 해당 값이 우선 사용됨
- `additional_subnets` 배열 순서가 바뀌면 dmz/private/db 역할 매핑이 달라질 수 있음
