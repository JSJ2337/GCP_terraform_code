# 2025-11-20 작업 내역

## 개요
10-network 레이어의 서브넷 이름 및 리전 동적 생성 구현 완료. 템플릿 재사용성을 위한 하드코딩 제거 작업.

## 주요 변경사항

### 1. 10-network 레이어 동적 생성 구현
**목적**: proj-default-templet을 복사하여 새 프로젝트 생성 시 `common.naming.tfvars`만 수정하면 모든 리소스 이름이 자동 생성되도록 개선

#### terraform.tfvars 변경
**이전 (하드코딩)**:
```hcl
additional_subnets = [
  {
    name   = "game-l-subnet-dmz"
    region = "asia-northeast3"
    cidr   = "10.3.0.0/24"
  },
  {
    name   = "game-l-subnet-private"
    region = "asia-northeast3"
    cidr   = "10.3.1.0/24"
  },
  {
    name   = "game-l-subnet-db"
    region = "asia-northeast3"
    cidr   = "10.3.2.0/24"
  }
]

dmz_subnet_name     = "game-l-subnet-dmz"
private_subnet_name = "game-l-subnet-private"
db_subnet_name      = "game-l-subnet-db"

memorystore_psc_region      = "asia-northeast3"
memorystore_psc_subnet_name = "game-l-subnet-private"
```

**변경 후 (CIDR만 정의)**:
```hcl
# name, region은 terragrunt.hcl에서 project_name, region_primary 기반 자동 생성
additional_subnets = [
  {
    cidr = "10.3.0.0/24"  # DMZ subnet
  },
  {
    cidr = "10.3.1.0/24"  # Private subnet
  },
  {
    cidr = "10.3.2.0/24"  # DB subnet
  }
]

# Subnet 이름은 terragrunt.hcl에서 자동 생성
# memorystore_psc_region과 memorystore_psc_subnet_name은 terragrunt.hcl에서 자동 생성
enable_memorystore_psc_policy = true
memorystore_psc_connection_limit = 8
```

#### terragrunt.hcl 변경
**추가된 로직**:
```hcl
locals {
  # 프로젝트명과 리전 추출
  project_name   = local.common_inputs.project_name
  region_primary = local.common_inputs.region_primary

  # Subnet 이름 자동 생성
  subnet_types = ["dmz", "private", "db"]

  # additional_subnets에 name과 region 자동 추가
  additional_subnets_with_metadata = [
    for idx, subnet in try(local.layer_inputs.additional_subnets, []) :
    merge(subnet, {
      name   = "${local.project_name}-subnet-${local.subnet_types[idx]}"
      region = local.region_primary
    })
  ]

  # Subnet 이름들
  dmz_subnet_name     = "${local.project_name}-subnet-dmz"
  private_subnet_name = "${local.project_name}-subnet-private"
  db_subnet_name      = "${local.project_name}-subnet-db"

  # Memorystore PSC 설정
  memorystore_psc_region      = local.region_primary
  memorystore_psc_subnet_name = local.private_subnet_name

  # layer_inputs에서 additional_subnets 제외 (terragrunt에서 처리한 버전을 사용)
  layer_inputs_without_subnets = { for k, v in local.layer_inputs : k => v if k != "additional_subnets" }
}

inputs = merge(
  local.common_inputs,
  local.layer_inputs_without_subnets,
  {
    additional_subnets          = local.additional_subnets_with_metadata
    dmz_subnet_name             = local.dmz_subnet_name
    private_subnet_name         = local.private_subnet_name
    db_subnet_name              = local.db_subnet_name
    memorystore_psc_region      = local.memorystore_psc_region
    memorystore_psc_subnet_name = local.memorystore_psc_subnet_name
  }
)
```

#### variables.tf 변경
**문제**: Terraform이 terraform.tfvars를 검증할 때는 terragrunt의 inputs merge가 아직 실행되지 않아 `name`과 `region`이 required면 에러 발생

**해결**: optional로 변경
```hcl
variable "additional_subnets" {
  description = "추가로 생성할 서브넷 목록 (DMZ, Private/WAS, DB 등 역할 기반 서브넷)"
  type = list(object({
    name                  = optional(string)  # string -> optional(string)
    region                = optional(string)  # string -> optional(string)
    cidr                  = string
    private_google_access = optional(bool, true)
    secondary_ranges = optional(list(object({
      name = string
      cidr = string
    })), [])
  }))
  default = []
}
```

### 2. Terragrunt Inputs Merge 충돌 해결
**문제**: `local.layer_inputs`에 `additional_subnets`가 포함되어 있어 merge 시 terraform.tfvars의 값(name 없음)이 전달되는 문제 발생

**증상**:
```
Error: Invalid object key
  on main.tf line 32, in locals:
  32:     subnet.name => {
      ├────────────────
      │ subnet.name is null

Key expression in 'for' expression must not produce a null value.
```

**해결**:
```hcl
# layer_inputs에서 additional_subnets를 제외한 버전 생성
layer_inputs_without_subnets = { for k, v in local.layer_inputs : k => v if k != "additional_subnets" }

inputs = merge(
  local.common_inputs,
  local.layer_inputs_without_subnets,  # layer_inputs 대신 사용
  {
    additional_subnets = local.additional_subnets_with_metadata  # terragrunt가 처리한 버전만 전달
    ...
  }
)
```

### 3. jsj-game-m 프로젝트 삭제
- 더 이상 사용하지 않는 jsj-game-m 프로젝트 전체 삭제
- 89개 파일, 7,372줄 제거
- 현재 LIVE 환경에는 jsj-game-n 프로젝트만 유지

### 4. 문서 업데이트
**proj-default-templet/10-network/README.md 업데이트**:
- 동적 생성 구조 설명 추가
- terraform.tfvars 예시를 CIDR만 정의하는 버전으로 업데이트
- terragrunt.hcl 자동 생성 로직 설명 추가
- 50-workloads에서 사용하는 방법 업데이트

## 적용 범위
- `proj-default-templet/10-network/` (템플릿)
- `environments/LIVE/jsj-game-n/10-network/` (운영 환경)

## 기대 효과
1. **템플릿 재사용성 향상**: 새 프로젝트 생성 시 `common.naming.tfvars`의 `project_name`과 `region_primary`만 변경하면 모든 서브넷 이름이 자동 생성됨
2. **휴먼 에러 감소**: 수동으로 이름을 입력할 필요가 없어 오타나 불일치 방지
3. **일관성 보장**: 모든 프로젝트가 동일한 명명 규칙을 따름 (`{project_name}-subnet-{type}`)
4. **유지보수 용이성**: 네이밍 규칙 변경 시 terragrunt.hcl만 수정하면 됨

## 관련 커밋
1. `5a030ea` - refactor: 10-network 서브넷 이름 및 리전 동적 생성으로 변경
2. `6f1241d` - chore: jsj-game-m 프로젝트 삭제
3. `9fc2321` - fix: 10-network additional_subnets의 name과 region을 optional로 변경
4. `731ebdc` - fix: terragrunt inputs merge에서 additional_subnets 충돌 해결

## 향후 작업
- [ ] 50-workloads 레이어도 동적 생성으로 전환
  - 현재: `subnetwork_self_link` 하드코딩 필요
  - 목표: terragrunt에서 자동 생성
- [ ] 70-loadbalancers 레이어 동적 생성 검토
- [ ] 다른 레이어들도 하드코딩 제거 검토

## 주의사항
- 기존에 배포된 인프라는 영향 없음 (리소스 이름이 변경되지 않음)
- 새로운 프로젝트 생성 시에만 동적 생성 로직 적용됨
- `additional_subnets` 배열의 순서가 중요함 (인덱스 기반으로 dmz/private/db 타입 매핑)
