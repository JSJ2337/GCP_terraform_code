## ğŸ“… ì„¸ì…˜ 6 ì‘ì—… ë‚´ì—­ (2025-10-29)

**ì‘ì—…ì**: jsj
**ëª©ì **: Cloud SQL MySQL ë¡œê¹… ë° Observability ê°œì„ 

### ğŸ¯ ì‘ì—… ìš”ì•½

Cloud SQL ëª¨ë“ˆì— ì¿¼ë¦¬ ë¡œê¹… ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…ì„ ìœ„í•œ Cloud Logging í†µí•©ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### ì™„ë£Œëœ ì‘ì—… âœ…

#### 1. Cloud SQL ëª¨ë“ˆ ë¡œê¹… ë³€ìˆ˜ ì¶”ê°€

**ì¶”ê°€ëœ ë³€ìˆ˜** (`modules/cloudsql-mysql/variables.tf`):
- `enable_slow_query_log` (bool, ê¸°ë³¸ê°’: `true`): ëŠë¦° ì¿¼ë¦¬ ë¡œê¹… í™œì„±í™”
- `slow_query_log_time` (number, ê¸°ë³¸ê°’: `2`): ëŠë¦° ì¿¼ë¦¬ ê¸°ì¤€ ì‹œê°„ (ì´ˆ)
- `enable_general_log` (bool, ê¸°ë³¸ê°’: `false`): ì¼ë°˜ ì¿¼ë¦¬ ë¡œê¹… í™œì„±í™”
- `log_output` (string, ê¸°ë³¸ê°’: `"FILE"`): ë¡œê·¸ ì¶œë ¥ ë°©ì‹ (FILE/TABLE)

**ê²€ì¦ ê·œì¹™**:
- `log_output`ì€ "FILE" ë˜ëŠ” "TABLE"ë§Œ í—ˆìš©
- FILE: Cloud Loggingìœ¼ë¡œ ìë™ ì „ì†¡ (ê¶Œì¥)
- TABLE: MySQL í…Œì´ë¸”ì— ì €ì¥

#### 2. Cloud SQL main.tf ë¡œê¹… êµ¬ì„±

**ìë™ í”Œë˜ê·¸ ìƒì„±** (`modules/cloudsql-mysql/main.tf`):
```terraform
locals {
  logging_flags = concat(
    var.enable_slow_query_log ? [
      { name = "slow_query_log", value = "on" },
      { name = "long_query_time", value = tostring(var.slow_query_log_time) }
    ] : [],
    var.enable_general_log ? [
      { name = "general_log", value = "on" }
    ] : [],
    [
      { name = "log_output", value = var.log_output }
    ]
  )
  all_database_flags = concat(var.database_flags, local.logging_flags)
}
```

**ë™ì‘ ë°©ì‹**:
- ì‚¬ìš©ìê°€ ì„¤ì •í•œ `database_flags`ì™€ ë¡œê¹… í”Œë˜ê·¸ë¥¼ ìë™ìœ¼ë¡œ ë³‘í•©
- ì¡°ê±´ë¶€ í”Œë˜ê·¸ ìƒì„±ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ í”Œë˜ê·¸ ì œì™¸
- ê¸°ì¡´ database_flags ë™ì  ë¸”ë¡ì€ `local.all_database_flags` ì‚¬ìš©

#### 3. 60-database ë ˆì´ì–´ ì—…ë°ì´íŠ¸

**ìˆ˜ì •ëœ íŒŒì¼**:
- `variables.tf`: ë¡œê¹… ë³€ìˆ˜ 4ê°œ ì¶”ê°€
- `main.tf`: ëª¨ë“ˆ í˜¸ì¶œ ì‹œ ë¡œê¹… ë³€ìˆ˜ ì „ë‹¬
  ```terraform
  # Logging
  enable_slow_query_log = var.enable_slow_query_log
  slow_query_log_time   = var.slow_query_log_time
  enable_general_log    = var.enable_general_log
  log_output            = var.log_output
  ```
- `terraform.tfvars.example`: ë¡œê¹… ì„¤ì • ì„¹ì…˜ ë° ì£¼ì„ ì¶”ê°€

#### 4. Cloud SQL README ë¬¸ì„œí™”

**ì¶”ê°€ëœ ì„¹ì…˜**:
1. **ê¸°ëŠ¥ ëª©ë¡**: "ë¡œê¹…: ëŠë¦° ì¿¼ë¦¬ ë° ì¼ë°˜ ì¿¼ë¦¬ ë¡œê¹…, Cloud Logging í†µí•©" ì¶”ê°€
2. **ì‚¬ìš© ì˜ˆì œ**: "ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ì„¤ì •" ì˜ˆì œ ì¶”ê°€
3. **ì…ë ¥ ë³€ìˆ˜ í…Œì´ë¸”**: ë¡œê¹… ë³€ìˆ˜ 4ê°œ ì¶”ê°€
4. **ëª¨ë²” ì‚¬ë¡€**: ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ì— ë¡œê¹… ê°€ì´ë“œ ì¶”ê°€
5. **ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ì„¹ì…˜** (ì‹ ê·œ):
   - Cloud Logging í†µí•© ì„¤ëª…
   - ëŠë¦° ì¿¼ë¦¬ ë¡œê·¸, ì¼ë°˜ ë¡œê·¸, ë¡œê·¸ ì¶œë ¥ ë°©ì‹ ì„¤ëª…
   - Cloud Loggingì—ì„œ ë¡œê·¸ í™•ì¸í•˜ëŠ” gcloud ëª…ë ¹ì–´
   - Query Insights ì„¤ëª…
   - ë¡œê¹… ë¹„ìš© ìµœì í™” ê°€ì´ë“œ (í™˜ê²½ë³„ ê¶Œì¥ ì„¤ì •)

**gcloud ë¡œê·¸ í™•ì¸ ëª…ë ¹ì–´**:
```bash
# ëŠë¦° ì¿¼ë¦¬ ë¡œê·¸
gcloud logging read "resource.type=cloudsql_database AND
  logName=projects/PROJECT_ID/logs/cloudsql.googleapis.com%2Fmysql-slow.log"

# ì¼ë°˜ ì¿¼ë¦¬ ë¡œê·¸
gcloud logging read "resource.type=cloudsql_database AND
  logName=projects/PROJECT_ID/logs/cloudsql.googleapis.com%2Fmysql.log"

# ì—ëŸ¬ ë¡œê·¸
gcloud logging read "resource.type=cloudsql_database AND
  logName=projects/PROJECT_ID/logs/cloudsql.googleapis.com%2Fmysql.err"
```

#### 5. ë¬¸ì„œ ì—…ë°ì´íŠ¸

**02_CHANGELOG.md**:
- "Observability ê°œì„ " ì„¹ì…˜ ì¶”ê°€
- Cloud SQL ë¡œê¹… ê¸°ëŠ¥ ìƒì„¸ ì„¤ëª…

**03_QUICK_REFERENCE.md**:
- ì„¸ì…˜ 6 ìš”ì•½ ì¶”ê°€
- ì™„ë£Œ í•­ëª©ì— 17ë²ˆ ì¶”ê°€

**04_WORK_HISTORY.md**:
- ì„¸ì…˜ 6 ìƒì„¸ ì‘ì—… ë‚´ì—­ ì¶”ê°€ (ì´ ë¬¸ì„œ)

### ğŸ“Š í†µê³„

- **ìˆ˜ì •ëœ íŒŒì¼**: 7ê°œ
  - `modules/cloudsql-mysql/variables.tf` (ë¡œê¹… ë³€ìˆ˜ ì¶”ê°€)
  - `modules/cloudsql-mysql/main.tf` (ë¡œê¹… í”Œë˜ê·¸ ë¡œì§ ì¶”ê°€)
  - `modules/cloudsql-mysql/README.md` (ë¡œê¹… ì„¹ì…˜ ì¶”ê°€)
  - `environments/prod/proj-default-templet/60-database/variables.tf`
  - `environments/prod/proj-default-templet/60-database/main.tf`
  - `environments/prod/proj-default-templet/60-database/terraform.tfvars.example`
  - ë¬¸ì„œ 3ê°œ (02_CHANGELOG.md, 03_QUICK_REFERENCE.md, 04_WORK_HISTORY.md)

- **ì¶”ê°€ëœ ì½”ë“œ ë¼ì¸**: ì•½ 150ì¤„
  - Variables: 30ì¤„
  - Locals ë¡œì§: 15ì¤„
  - README ë¬¸ì„œ: 90ì¤„
  - ê¸°íƒ€: 15ì¤„

### ğŸ” ê¸°ìˆ ì  ê²°ì •

#### 1. ì™œ database_flagsë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë³„ë„ ë³€ìˆ˜ë¥¼ ë§Œë“¤ì—ˆë‚˜?

**ì´ìœ **:
- **ì‚¬ìš©ì ì¹œí™”ì„±**: ë³µì¡í•œ database_flags êµ¬ì¡° ëŒ€ì‹  ê°„ë‹¨í•œ boolean/number ë³€ìˆ˜ ì œê³µ
- **ìë™í™”**: ë¡œê¹… í™œì„±í™” ì‹œ í•„ìš”í•œ ì—¬ëŸ¬ í”Œë˜ê·¸ë¥¼ ìë™ìœ¼ë¡œ êµ¬ì„±
- **ê¸°ë³¸ê°’ ì œê³µ**: í”„ë¡œë•ì…˜ í™˜ê²½ì— ì í•©í•œ ê¸°ë³¸ê°’ ì„¤ì •
- **ì¶©ëŒ ë°©ì§€**: ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë¡œê¹… í”Œë˜ê·¸ë¥¼ ì„¤ì •í•  í•„ìš” ì—†ìŒ

**ì˜ˆì‹œ**:
```hcl
# Before (ë³µì¡í•¨)
database_flags = [
  { name = "slow_query_log", value = "on" },
  { name = "long_query_time", value = "2" },
  { name = "log_output", value = "FILE" }
]

# After (ê°„ë‹¨í•¨)
enable_slow_query_log = true
slow_query_log_time   = 2
```

#### 2. ì™œ ì¼ë°˜ ë¡œê·¸ì˜ ê¸°ë³¸ê°’ì„ falseë¡œ ì„¤ì •í–ˆë‚˜?

**ì´ìœ **:
- **ì„±ëŠ¥ ì˜í–¥**: ëª¨ë“  ì¿¼ë¦¬ë¥¼ ë¡œê¹…í•˜ë©´ ì„±ëŠ¥ ì €í•˜ ë°œìƒ
- **ë¹„ìš© ì¦ê°€**: Cloud Logging ë¹„ìš©ì´ í¬ê²Œ ì¦ê°€
- **í”„ë¡œë•ì…˜ ì•ˆì „ì„±**: ì‹¤ìˆ˜ë¡œ í™œì„±í™”ë˜ëŠ” ê²ƒì„ ë°©ì§€
- **ìš©ë„ ì œí•œ**: ë””ë²„ê¹… ë° ê°ì‚¬ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©

**ê¶Œì¥ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤**:
- âœ… ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œ ë””ë²„ê¹…
- âœ… ë³´ì•ˆ ê°ì‚¬ê°€ í•„ìš”í•œ ê²½ìš°
- âœ… íŠ¹ì • ë¬¸ì œ ì¬í˜„ ì‹œ ì„ì‹œ í™œì„±í™”
- âŒ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ìƒì‹œ í™œì„±í™”

#### 3. ë¡œê·¸ ì¶œë ¥ ë°©ì‹ìœ¼ë¡œ FILEì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„ íƒí•œ ì´ìœ 

**FILEì˜ ì¥ì **:
- Cloud Loggingìœ¼ë¡œ ìë™ ì „ì†¡
- ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ê´€ë¦¬
- Logs Explorerì—ì„œ ì¿¼ë¦¬ ë° í•„í„°ë§ ê°€ëŠ¥
- ë‹¤ë¥¸ GCP ì„œë¹„ìŠ¤ì™€ í†µí•© ìš©ì´
- ì•Œë¦¼ ë° ëª¨ë‹ˆí„°ë§ ì„¤ì • ê°€ëŠ¥

**TABLEì˜ ë‹¨ì **:
- ë¡œê·¸ê°€ MySQL í…Œì´ë¸”ì— ì €ì¥ë¨
- ì¶”ê°€ ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ë°œìƒ
- ë¡œê·¸ ì¡°íšŒë¥¼ ìœ„í•´ SQL ì¿¼ë¦¬ í•„ìš”
- Cloud Logging í†µí•© ì•ˆ ë¨

### ğŸ“ í•™ìŠµ ë‚´ìš©

#### Cloud SQL ë¡œê¹… ë©”ì»¤ë‹ˆì¦˜

1. **Database Flags**:
   - MySQL ì„œë²„ ë³€ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì •
   - ì¸ìŠ¤í„´ìŠ¤ ì¬ì‹œì‘ ì—†ì´ ì ìš© ê°€ëŠ¥ (ëŒ€ë¶€ë¶„ì˜ í”Œë˜ê·¸)
   - `slow_query_log`, `general_log`, `log_output` ë“±

2. **Cloud Logging í†µí•©**:
   - `log_output = "FILE"`ë¡œ ì„¤ì •í•˜ë©´ ìë™ ì „ì†¡
   - ë¡œê·¸ íƒ€ì…ë³„ ë³„ë„ì˜ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼:
     - `mysql-slow.log`: ëŠë¦° ì¿¼ë¦¬
     - `mysql.log`: ì¼ë°˜ ì¿¼ë¦¬ (í™œì„±í™” ì‹œ)
     - `mysql.err`: ì—ëŸ¬ ë¡œê·¸

3. **Query Insights vs ë¡œê¹…**:
   - **Query Insights**:
     - GUI ê¸°ë°˜ ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„
     - ìƒìœ„ Nê°œ ì¿¼ë¦¬ ìë™ ì‹ë³„
     - CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í¬í•¨
     - ì¶”ê°€ ë¹„ìš© ì—†ìŒ
   - **Slow Query Log**:
     - ê¸°ì¤€ ì‹œê°„ ì´ìƒ ì¿¼ë¦¬ë§Œ ê¸°ë¡
     - í…ìŠ¤íŠ¸ ë¡œê·¸ í˜•ì‹
     - Cloud Logging ë¹„ìš© ë°œìƒ
     - ë” ìƒì„¸í•œ ì¿¼ë¦¬ ì •ë³´

### ğŸ’¡ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

#### í™˜ê²½ë³„ ë¡œê¹… ì„¤ì • ê¶Œì¥

**í”„ë¡œë•ì…˜**:
```hcl
enable_slow_query_log = true   # âœ… í™œì„±í™”
slow_query_log_time   = 2      # 2ì´ˆ ì´ìƒ
enable_general_log    = false  # âŒ ë¹„í™œì„±í™”
query_insights_enabled = true  # âœ… í™œì„±í™”
```

**ìŠ¤í…Œì´ì§•**:
```hcl
enable_slow_query_log = true   # âœ… í™œì„±í™”
slow_query_log_time   = 1      # 1ì´ˆ ì´ìƒ (ë” ë¯¼ê°í•˜ê²Œ)
enable_general_log    = false  # âŒ ë¹„í™œì„±í™” (í•„ìš”ì‹œë§Œ)
query_insights_enabled = true  # âœ… í™œì„±í™”
```

**ê°œë°œ**:
```hcl
enable_slow_query_log = true   # âœ… í™œì„±í™”
slow_query_log_time   = 1      # 1ì´ˆ ì´ìƒ
enable_general_log    = true   # âœ… ë””ë²„ê¹…ì„ ìœ„í•´ í™œì„±í™” ê°€ëŠ¥
query_insights_enabled = true  # âœ… í™œì„±í™”
```

### ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

**ì¦‰ì‹œ ê°€ëŠ¥**:
1. ì‹¤ì œ Cloud SQL ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ ë° ë¡œê¹… í…ŒìŠ¤íŠ¸
2. Cloud Loggingì—ì„œ ë¡œê·¸ í™•ì¸
3. ë¡œê¹… ê¸°ë°˜ ì•Œë¦¼ ì„¤ì •

**í–¥í›„ ê°œì„ **:
1. PostgreSQL ëª¨ë“ˆì—ë„ ë™ì¼í•œ ë¡œê¹… ê¸°ëŠ¥ ì¶”ê°€
2. ë¡œê·¸ ê¸°ë°˜ ë©”íŠ¸ë¦­ (log-based metrics) ìƒì„±
3. ìë™ ì•Œë¦¼ ì„¤ì • (ì˜ˆ: ëŠë¦° ì¿¼ë¦¬ê°€ ì„ê³„ê°’ ì´ˆê³¼ ì‹œ)
4. ë¡œê·¸ ë³´ì¡´ ì •ì±… ì„¤ì •

### ğŸ› ë²„ê·¸ ìˆ˜ì • (ì„¸ì…˜ 6 í›„ë°˜)

#### deletion_policy ì†ì„± ì˜¤ë¥˜ ìˆ˜ì •

**ë¬¸ì œ 1 (ì²« ë²ˆì§¸ ì‹œë„)**:
- VSCode Terraform ê²€ì¦ì—ì„œ ì—ëŸ¬ ë°œìƒ:
  ```
  Unexpected attribute: An attribute named "deletion_policy" is not expected here
  ```
- `google_project` ë¦¬ì†ŒìŠ¤ëŠ” `deletion_policy` ì†ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ

**í•´ê²° ì‹œë„ 1**:
- `deletion_policy` â†’ `prevent_destroy` ë³€ìˆ˜ë¡œ ë³€ê²½
- `lifecycle { prevent_destroy = var.prevent_destroy }` ì‚¬ìš©

**ë¬¸ì œ 2 (ë‘ ë²ˆì§¸ ì—ëŸ¬)**:
- ê°™ì€ ì—ëŸ¬ ê³„ì† ë°œìƒ:
  ```
  Unexpected attribute: An attribute named "prevent_destroy" is not expected here
  ```
- **ê·¼ë³¸ ì›ì¸**: Terraformì˜ `lifecycle` ë¸”ë¡ì€ **ë©”íƒ€-ì¸ì**ì´ë©° ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
- `lifecycle { prevent_destroy }` ê°’ì€ ë°˜ë“œì‹œ **ìƒìˆ˜(literal)**ì—¬ì•¼ í•¨
- ì´ëŠ” Terraformì˜ ì„¤ê³„ ì œí•œì‚¬í•­

**ìµœì¢… í•´ê²°ì±…**:
1. **prevent_destroy ë³€ìˆ˜ ì™„ì „ ì œê±°**:
   - ëª¨ë“ˆ ë³€ìˆ˜ë¡œ ì œì–´í•  ìˆ˜ ì—†ìŒ
   - ì£¼ì„ ì²˜ë¦¬ëœ lifecycle ë¸”ë¡ìœ¼ë¡œ ëŒ€ì²´

2. **ë³€ê²½ëœ íŒŒì¼**:
   ```
   modules/project-base/variables.tf: prevent_destroy ë³€ìˆ˜ ì œê±°
   modules/project-base/main.tf: lifecycle ë¸”ë¡ ì£¼ì„ ì²˜ë¦¬ + ì•ˆë‚´ ì¶”ê°€
   environments/prod/proj-default-templet/00-project/variables.tf
   environments/prod/proj-default-templet/00-project/main.tf
   environments/prod/proj-default-templet/00-project/terraform.tfvars.example
   ```

3. **ìµœì¢… ì½”ë“œ**:
   ```terraform
   resource "google_project" "this" {
     project_id = var.project_id
     # ... ê¸°íƒ€ ì†ì„± ...

     # ì°¸ê³ : í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‚­ì œ ë°©ì§€ê°€ í•„ìš”í•œ ê²½ìš°
     # ì•„ë˜ lifecycle ë¸”ë¡ì˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”
     # lifecycle {
     #   prevent_destroy = true
     # }
   }
   ```

**ì‚¬ìš© ë°©ë²•**:
- ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½: ì£¼ì„ ìœ ì§€ (ììœ ë¡­ê²Œ ì‚­ì œ ê°€ëŠ¥)
- í”„ë¡œë•ì…˜ í™˜ê²½: ì£¼ì„ í•´ì œí•˜ì—¬ `prevent_destroy = true` í™œì„±í™”

**í•™ìŠµ ë‚´ìš©**:
- Terraformì˜ ë©”íƒ€-ì¸ì (`lifecycle`, `depends_on`, `count`, `for_each`)ëŠ” ë™ì  ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
- ì´ëŸ¬í•œ ê°’ë“¤ì€ Terraformì´ ì‹¤í–‰ ê³„íšì„ ì„¸ìš°ê¸° ì „ì— í‰ê°€ë˜ì–´ì•¼ í•¨
- ë³€ìˆ˜ë¥¼ í†µí•œ ë™ì  ì œì–´ê°€ í•„ìš”í•˜ë‹¤ë©´ ë³„ë„ì˜ ë¦¬ì†ŒìŠ¤ë‚˜ ëª¨ë“ˆ ë¶„ë¦¬ í•„ìš”

### ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€

```
fix: prevent_destroy ë³€ìˆ˜ ì œê±° ë° ì£¼ì„ ì•ˆë‚´ë¡œ ë³€ê²½

- Terraform lifecycle ë¸”ë¡ì€ ë³€ìˆ˜ ì‚¬ìš© ë¶ˆê°€ (ë©”íƒ€-ì¸ì ì œí•œ)
- prevent_destroy ë³€ìˆ˜ ì™„ì „ ì œê±°
- ì£¼ì„ ì²˜ë¦¬ëœ lifecycle ë¸”ë¡ìœ¼ë¡œ ì‚¬ìš©ìê°€ í•„ìš” ì‹œ í™œì„±í™”
- project-base ëª¨ë“ˆì— ì£¼ì„ìœ¼ë¡œ ì‚¬ìš© ì•ˆë‚´ ì¶”ê°€
- VSCode Terraform ê²€ì¦ ì—ëŸ¬ ìˆ˜ì •

ğŸ¤– Generated with Claude Code
```

---

