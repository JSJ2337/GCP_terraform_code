# 작업 이력 - 2025-11-13

**작업자**: jsj  
**브랜치**: 433_code

---

## 🎯 작업 요약
- jsj-game-l 환경의 `70-loadbalancer`에 auto instance group 로직을 복구하고 Jenkins 컨테이너에서 Terragrunt로 직접 검증
- 폐기된 jsj-game-k 환경 전체를 레포에서 제거

---

## ✅ 완료된 작업
1. **로드밸런서 자동 백엔드 복구**
   - 템플릿과 jsj-game-l의 `main.tf`, `variables.tf`, `README.md`를 동기화해 `auto_instance_groups` 입력을 `local.auto_backends`로 합산
   - Jenkins 컨테이너에서 bootstrap 키를 사용해 `terragrunt run -- console`로 `local.auto_backends`에 8개 IG가 모두 포함되는지 확인
2. **jsj-game-k 환경 삭제**
   - `/terraform_gcp_infra/environments/LIVE/jsj-game-k` 전체를 삭제하고 `chore: jsj-game-k 환경 제거` 커밋으로 반영
3. **문서/작업자 표기 정리**
   - load balancer README에 auto 등록 주의사항을 포함하고 템플릿과 jsj-game-l 버전을 맞춤

---

## 🐛 해결한 이슈
- 70-loadbalancer가 50-workloads의 instance group 출력을 사용하지 않아 자동 등록이 동작하지 않던 문제 → 템플릿 최신 코드로 교체해 해결
- 폐기된 jsj-game-k 환경이 남아 있어 혼선을 주던 문제 → 디렉터리 삭제 및 커밋 완료

---

## 🔗 관련 커밋
- `chore: jsj-game-k 환경 제거`
- `docs: 문서 재구성 반영`
- `docs: 작업자 표기 정리`

---

## 📌 추가 메모
- Jenkins 컨테이너에서 Terragrunt를 수동 실행할 때는 `/tmp/jenkins-sa-key.json`에 bootstrap 키를 복사한 후 `GOOGLE_APPLICATION_CREDENTIALS`를 export 해야 함 (작업 후 키 파일은 삭제 완료)
- jsj-game-l에서 `terragrunt run --queue-include-dir '70-loadbalancer' --all apply`를 한 번 더 실행하면 자동 백엔드 구성이 실환경 GCP에도 반영됨

---

## 🛠 game-m 로드밸런서 안정화 (Codex)
- 로비/웹 스택에서 네이밍 모듈 기본값을 유지하면서 `health_check_name`을 tfvars로 오버라이드하도록 로직 확장
- 헬스체크 리소스에 `create_before_destroy`를 추가해 백엔드 서비스가 기존 헬스체크를 참조 중일 때도 안전하게 교체되도록 함
- Terragrunt 의존성(`50-workloads`) 출력 전달을 위해 `skip_outputs` 제거 후, MIG 이름 필터를 `regexall` 기반으로 수정해 문자열 포함 여부를 정확히 판별
- 위 변경 사항을 `fix(loadbalancer): game-m 헬스체크 이름 충돌 해소`, `fix(loadbalancer): 헬스체크 recreate 순서 보장`, `fix(loadbalancer): terragrunt 의존성 출력 활성화` 커밋으로 정리하고 원격 브랜치(`433_code`)에 푸시 완료

### 다음 액션
1. Jenkins에서 `terragrunt run-all plan/apply ./70-loadbalancers` 실행 시 MIG self-link가 자동으로 주입되는지 확인
2. game-m 로드밸런서 apply 후 GCP 콘솔에서 백엔드 연결 상태(Healthy) 체크
