# 2025-11-25 작업 내역

## 개요

proj-default-templet과 jsj-game-n 전체 비교 및 동기화, Bootstrap 레이어의 GCS backend 전환 및 Jenkinsfile 추가, Provider checksum 불일치 에러 해결.

## 주요 변경사항

### 1. proj-default-templet 템플릿 완전 동기화

**목적**: jsj-game-n과 proj-default-templet 간 누락된 설정 동기화

#### 수정된 파일들

**50-workloads/terragrunt.hcl**:

```hcl
# 변경 전
mock_outputs_allowed_terraform_commands = ["init", "plan", "validate"]

# 변경 후
mock_outputs_allowed_terraform_commands = ["init", "plan", "validate", "destroy"]
```

**Jenkinsfile**:

- `prepare-destroy` 액션 추가
- Phase 7 cleanup resources stage 추가
- Phase 6 PSC cleanup 대기 로직 추가
- runPhaseDestroy에 Redis deletion protection 비활성화 추가
- `--queue-strict-include` 옵션 추가
- Phase 2 network destroy 시 PSC 연결 재시도 로직 추가

#### 검증된 동일 파일들

- 모든 terragrunt.hcl 파일 (00-project ~ 75-dns)
- 20-storage/main.tf

#### 의도적 차이 (유지)

- **root.hcl**: 템플릿은 환경변수 기반 플레이스홀더 검증 로직 포함
- **terraform.tfvars**: 프로젝트별 실제 값
- **줄바꿈 문자**: jsj-game-n은 CRLF, 템플릿은 LF

---

### 2. Bootstrap 레이어 GCS Backend 전환

**목적**: Bootstrap도 다른 프로젝트와 동일하게 GCS backend 사용

#### main.tf 변경

```hcl
# 변경 전
backend "local" {
  path = "terraform.tfstate"
}

# 변경 후
backend "gcs" {
  bucket = "jsj-terraform-state-prod"
  prefix = "bootstrap"
}
```

#### Jenkinsfile 생성

Bootstrap 전용 Jenkinsfile 생성:

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| `ACTION` | `plan` | plan / apply / destroy |
| `MANAGE_FOLDERS` | `false` | GCP 폴더 구조 관리 여부 |
| `MANAGE_ORG_IAM` | `false` | 조직 레벨 IAM 관리 여부 |
| `ENABLE_BILLING_BINDING` | `false` | Billing 계정 바인딩 여부 |

#### State 마이그레이션 방법

```bash
cd terraform_gcp_infra/bootstrap
terraform init -migrate-state
# "yes" 입력
```

---

### 3. Provider Checksum 불일치 에러 해결

**증상**:

```text
Error: Required plugins are not installed

The installed provider plugins are not consistent with the packages
selected in the dependency lock file:
  - registry.terraform.io/hashicorp/null: the cached package does not match checksums
```

**원인**: Jenkins의 `TF_PLUGIN_CACHE_DIR`에 캐시된 provider와 `.terraform.lock.hcl`의 checksum 불일치

**해결**: Jenkinsfile 수정

```groovy
// init 전에 lock 파일 삭제 추가
sh """
    find '${env.WORKSPACE}/${TG_WORKING_DIR}' -name ".terraform.lock.hcl" -type f -delete || true
"""

// init에 -upgrade 옵션 추가
sh "terragrunt run --all --working-dir '${env.WORKSPACE}/${TG_WORKING_DIR}' -- init -upgrade"
```

---

## 커밋 내역

### 1. `840a928` - refactor(templet): jsj-game-n 기반 템플릿 완전 동기화

- 50-workloads: mock_outputs_allowed_terraform_commands에 destroy 추가
- Jenkinsfile: prepare-destroy 액션 추가
- Jenkinsfile: Phase 7 cleanup resources stage 추가
- Jenkinsfile: Phase 6 PSC cleanup 대기 로직 추가
- Jenkinsfile: runPhaseDestroy에 Redis deletion protection 비활성화 추가
- Jenkinsfile: --queue-strict-include 옵션 추가

### 2. `0bfa2b7` - feat(bootstrap): Jenkins 파이프라인 추가

- Bootstrap 레이어용 Jenkinsfile 생성
- plan/apply/destroy 액션 지원
- 조직 폴더 구조 관리 옵션 (MANAGE_FOLDERS)
- 조직 레벨 IAM 관리 옵션 (MANAGE_ORG_IAM)
- Billing 계정 바인딩 옵션 (ENABLE_BILLING_BINDING)
- Destroy 시 강력한 경고 메시지 표시

### 3. `524a62a` - refactor(bootstrap): backend를 local에서 GCS로 변경

- backend "local" → backend "gcs" 변경
- bucket: jsj-terraform-state-prod
- prefix: bootstrap
- Jenkinsfile에 backend 정보 주석 추가

### 4. `6b4860b` - fix(jenkins): provider 체크섬 불일치 에러 해결

- .terraform.lock.hcl 파일 삭제 추가
- init에 -upgrade 옵션 추가로 provider 재다운로드
- jsj-game-n과 proj-default-templet 모두 적용

---

## 문서 업데이트

### bootstrap/README.md

- 로컬 backend → GCS backend 내용으로 수정
- Jenkins 파이프라인 섹션 추가
- State 마이그레이션 방법 추가
- 디렉토리 구조에 Jenkinsfile 추가

### docs/getting-started/bootstrap-setup.md

- GCS backend 정보 추가
- State 마이그레이션 섹션 수정

### docs/troubleshooting/common-errors.md

- Provider Checksum 불일치 에러 해결 방법 업데이트 (2025-11-25 기준)

---

## 영향

### Bootstrap

- ✅ 원격 State 관리로 Jenkins 자동화 가능
- ✅ 다른 프로젝트와 일관된 backend 구조
- ✅ 로컬 백업 필요 없음

### Jenkinsfile

- ✅ Provider checksum 문제 자동 해결
- ✅ 모든 환경에서 일관된 init 동작
- ✅ 캐시 불일치로 인한 실패 방지

### 템플릿 동기화

- ✅ 새 프로젝트 생성 시 최신 기능 자동 포함
- ✅ destroy 시 dependency 문제 해결
- ✅ Redis/PSC 관련 cleanup 로직 포함

---

## 다음 단계

### 1. Bootstrap State 마이그레이션

- [ ] GCP 인증 후 `terraform init -migrate-state` 실행
- [ ] GCS에 state 업로드 확인

### 2. Jenkins 파이프라인 테스트

- [ ] Bootstrap 파이프라인 plan 실행
- [ ] jsj-game-n 파이프라인 plan/apply 실행 (provider checksum 문제 해결 확인)

---

## 참고사항

### GCS Backend vs Local Backend

| 항목 | Local | GCS |
|------|-------|-----|
| 위치 | 로컬 파일 | Cloud Storage |
| 공유 | 불가 | 팀 전체 공유 |
| 백업 | 수동 필요 | Versioning 자동 |
| CI/CD | 어려움 | Jenkins 통합 |
| Lock | 없음 | State Locking 지원 |

### Provider Plugin Cache

Jenkins에서 `TF_PLUGIN_CACHE_DIR` 환경변수로 provider 캐시 공유:

- 장점: 다운로드 시간 절약
- 단점: 플랫폼 간 checksum 불일치 가능

해결책: `init -upgrade`로 매번 provider 갱신
