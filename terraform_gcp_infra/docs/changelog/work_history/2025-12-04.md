# 2025-12-04 작업 이력

## 작업 개요

### 주요 작업
1. gcp-gcby 환경 하드코딩 제거 - 코드 재사용성 향상
2. Bootstrap 10-network outputs.tf 에러 수정
3. root.hcl common.naming.tfvars 경로 수정
4. 65-cache/terragrunt.hcl 환경변수 기본값 추가

---

## 1. gcp-gcby 환경 하드코딩 제거

### 배경
- `gcp-gcby` 환경의 코드를 다른 프로젝트에서 재사용하기 어려움
- 하드코딩된 값들이 여러 파일에 분산되어 있음
- 새 프로젝트 생성 시 `common.naming.tfvars`만 수정하면 되도록 개선 필요

### 수정 내용

#### 1.1 root.hcl - 환경변수 지원 추가

**변경 전:**
```hcl
locals {
  remote_state_bucket = "delabs-terraform-state-live"
  remote_state_project = "delabs-gcp-mgmt"
  # ...
}

inputs = {
  org_id = "1034166519592"
  billing_account = "01B77E-0A986D-CB2651"
  # ...
}
```

**변경 후:**
```hcl
locals {
  # root.hcl이 있는 디렉토리에서 common.naming.tfvars 참조
  root_dir          = dirname(find_in_parent_folders("root.hcl"))
  raw_common_inputs = read_tfvars_file("${local.root_dir}/common.naming.tfvars")
  common_inputs     = try(jsondecode(local.raw_common_inputs), local.raw_common_inputs)

  # 환경변수 > 기본값 순 우선순위
  remote_state_bucket   = get_env("TG_STATE_BUCKET", "delabs-terraform-state-live")
  remote_state_project  = get_env("TG_STATE_PROJECT", try(local.common_inputs.management_project_id, "delabs-gcp-mgmt"))
  remote_state_location = get_env("TG_STATE_LOCATION", "ASIA")
  project_state_prefix  = local.common_inputs.project_id
}

inputs = {
  org_id          = get_env("TG_ORG_ID", "1034166519592")
  billing_account = get_env("TG_BILLING_ACCOUNT", "01B77E-0A986D-CB2651")
  management_project_id = try(local.common_inputs.management_project_id, "")
  # ...
}
```

**지원되는 환경변수:**
| 환경변수 | 설명 | 기본값 |
|---------|------|--------|
| TG_STATE_BUCKET | State 버킷 이름 | delabs-terraform-state-live |
| TG_STATE_PROJECT | State 버킷 프로젝트 | common.naming.tfvars에서 |
| TG_STATE_LOCATION | State 버킷 위치 | ASIA |
| TG_ORG_ID | GCP Organization ID | 1034166519592 |
| TG_BILLING_ACCOUNT | Billing Account ID | 01B77E-0A986D-CB2651 |

---

#### 1.2 10-network/variables.tf - PSC IP 기본값 제거

**변경 전:**
```hcl
variable "psc_cloudsql_ip" {
  type    = string
  default = "10.10.12.51"  # 하드코딩
}

variable "psc_redis_ips" {
  type    = list(string)
  default = ["10.10.12.101", "10.10.12.102"]  # 하드코딩
}
```

**변경 후:**
```hcl
variable "psc_cloudsql_ip" {
  type    = string
  default = ""  # terragrunt.hcl에서 network_config.psc_endpoints.cloudsql 주입
}

variable "psc_redis_ips" {
  type    = list(string)
  default = []  # terragrunt.hcl에서 network_config.psc_endpoints.redis 주입
}
```

---

#### 1.3 50-workloads - VM 이름 동적화

**문제점:**
- terraform.tfvars에서 인스턴스 키가 `"gcby-gs01"`, `"gcby-gs02"`로 하드코딩됨
- 새 프로젝트에서 재사용 시 모든 키를 수정해야 함

**해결:**
1. terraform.tfvars에서 인스턴스 키를 `vm_ip_key`와 동일하게 변경 (`gs01`, `gs02`)
2. terragrunt.hcl에서 `${project_name}-${key}` 형태로 VM 이름 자동 생성

**50-workloads/terraform.tfvars 변경:**
```hcl
# 변경 전
instances = {
  "gcby-gs01" = {
    vm_ip_key = "gs01"
    # ...
  }
  "gcby-gs02" = {
    vm_ip_key = "gs02"
    # ...
  }
}

# 변경 후
instances = {
  "gs01" = {  # 키를 vm_ip_key와 동일하게
    vm_ip_key = "gs01"
    # ...
  }
  "gs02" = {
    vm_ip_key = "gs02"
    # ...
  }
}
```

**50-workloads/terragrunt.hcl 변경:**
```hcl
locals {
  # common.naming.tfvars에서 project_name 가져오기
  project_name = local.common_inputs.project_name

  # 인스턴스 키를 "${project_name}-${key}" 형태로 변환
  instances_with_zones = {
    for k, v in try(local.layer_inputs.instances, {}) :
    "${local.project_name}-${k}" => merge(v, {  # gcby-gs01, gcby-gs02 형태로 변환
      zone       = "${local.region_primary}-${v.zone_suffix}"
      network_ip = try(local.vm_ips[v.vm_ip_key], try(v.network_ip, null))
    })
  }

  # instance_groups도 동일한 패턴 적용
  instance_groups_with_zones = {
    for k, v in try(local.layer_inputs.instance_groups, {}) :
    "${local.project_name}-${k}" => merge(v, {
      zone = "${local.region_primary}-${v.zone_suffix}"
    })
  }
}
```

**결과:**
- terraform.tfvars의 `gs01` → 실제 VM 이름 `gcby-gs01`
- terraform.tfvars의 `gs02` → 실제 VM 이름 `gcby-gs02`
- 새 프로젝트 `abc`에서 동일한 tfvars 사용 시 → `abc-gs01`, `abc-gs02`

---

### 커밋: 363ee19

**메시지:**
```
refactor: gcp-gcby 환경 하드코딩 제거 - root.hcl, network, workloads 동적화

- root.hcl: org_id, billing_account, management_project_id를 환경변수(TG_*)로 변경
  - TG_STATE_BUCKET, TG_STATE_PROJECT, TG_STATE_LOCATION 지원
  - TG_ORG_ID, TG_BILLING_ACCOUNT 환경변수 fallback 추가
- 10-network/variables.tf: PSC IP 기본값 제거 (common.naming.tfvars에서 주입)
  - psc_cloudsql_ip default "" 변경
  - psc_redis_ips default [] 변경
- 50-workloads: VM 이름 동적화
  - terraform.tfvars: 인스턴스 키를 vm_ip_key 값으로 변경 (gcby-gs01 → gs01)
  - terragrunt.hcl: ${project_name}-${key} 형태로 VM 이름 자동 생성
```

**수정 파일:** 4개 (+42줄, -21줄)
- environments/LIVE/gcp-gcby/root.hcl
- environments/LIVE/gcp-gcby/10-network/variables.tf
- environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars
- environments/LIVE/gcp-gcby/50-workloads/terragrunt.hcl

---

## 2. Bootstrap 10-network outputs.tf 에러 수정

### 에러 메시지
```
Error: Reference to undeclared resource
  on outputs.tf line 53, in output "subnet_us_west1_id":
  53:   value = google_compute_subnetwork.mgmt_subnet_us_west1.id

A managed resource "google_compute_subnetwork" "mgmt_subnet_us_west1" has
not been declared in the root module.
```

### 원인
- 이전 세션에서 리소스 이름을 `mgmt_subnet_us_west1` → `mgmt_subnet_secondary`로 변경
- outputs.tf에서 일부 output만 수정되고 나머지가 누락됨

### 해결 (Commit: 1e411ef)

**변경 전:**
```hcl
output "subnet_us_west1_id" {
  value = google_compute_subnetwork.mgmt_subnet_us_west1.id
}
output "subnet_us_west1_name" {
  value = google_compute_subnetwork.mgmt_subnet_us_west1.name
}
output "subnet_us_west1_self_link" {
  value = google_compute_subnetwork.mgmt_subnet_us_west1.self_link
}
```

**변경 후:**
```hcl
output "subnet_secondary_id" {
  value = google_compute_subnetwork.mgmt_subnet_secondary.id
}
output "subnet_secondary_name" {
  value = google_compute_subnetwork.mgmt_subnet_secondary.name
}
output "subnet_secondary_self_link" {
  value = google_compute_subnetwork.mgmt_subnet_secondary.self_link
}
```

---

## 3. root.hcl common.naming.tfvars 경로 수정

### 에러 메시지
```
Error: Error in function call
  on ./root.hcl line 14, in locals:
  14:   raw_common_inputs = read_tfvars_file("${local.parent_dir}/common.naming.tfvars")
with local.parent_dir as "./60-database"

Call to function "read_tfvars_file" failed: TFVarFileNotFound: Could not find a
./60-database/common.naming.tfvars.
```

### 원인
- `get_terragrunt_dir()`가 레이어 디렉토리(예: `./60-database`)를 반환
- `common.naming.tfvars`는 `gcp-gcby/` 루트에 존재
- 결과적으로 `./60-database/common.naming.tfvars`를 찾으려 함

### 해결 (Commit: 2f76c61)

**변경 전:**
```hcl
locals {
  parent_dir        = get_terragrunt_dir()  # ./60-database 반환
  raw_common_inputs = read_tfvars_file("${local.parent_dir}/common.naming.tfvars")
}
```

**변경 후:**
```hcl
locals {
  # root.hcl이 있는 디렉토리 (gcp-gcby/)를 찾음
  root_dir          = dirname(find_in_parent_folders("root.hcl"))
  raw_common_inputs = read_tfvars_file("${local.root_dir}/common.naming.tfvars")
}
```

**동작 방식:**
1. `find_in_parent_folders("root.hcl")` → `gcp-gcby/root.hcl` 경로 반환
2. `dirname(...)` → `gcp-gcby/` 디렉토리 추출
3. `${local.root_dir}/common.naming.tfvars` → `gcp-gcby/common.naming.tfvars`

---

## 4. 65-cache/terragrunt.hcl 환경변수 기본값 추가

### 에러 메시지
```
Error: Error in function call
  on ./65-cache/terragrunt.hcl line 23, in locals:
  23:   state_bucket = get_env("TG_STATE_BUCKET")

Call to function "get_env" failed: EnvVarNotFoundError: Required environment
variable TG_STATE_BUCKET - not found.
```

### 원인
- `65-cache/terragrunt.hcl`에서 `get_env("TG_STATE_BUCKET")`가 기본값 없이 호출
- Jenkins에서 해당 환경변수가 설정되지 않으면 에러 발생

### 해결 (Commit: d3aab9d)

**변경 전:**
```hcl
locals {
  state_bucket = get_env("TG_STATE_BUCKET")  # 기본값 없음 - 필수
}
```

**변경 후:**
```hcl
locals {
  state_bucket = get_env("TG_STATE_BUCKET", "delabs-terraform-state-live")  # 기본값 추가
}
```

---

## 커밋 이력 요약

| 커밋 | 설명 |
|------|------|
| 363ee19 | gcp-gcby 환경 하드코딩 제거 - root.hcl, network, workloads 동적화 |
| 1e411ef | bootstrap/10-network outputs.tf - mgmt_subnet_us_west1 → mgmt_subnet_secondary |
| 2f76c61 | root.hcl common.naming.tfvars 경로 수정 |
| d3aab9d | 65-cache/terragrunt.hcl TG_STATE_BUCKET 기본값 추가 |

---

## 영향을 받은 파일

### 환경 파일 (gcp-gcby)
- `environments/LIVE/gcp-gcby/root.hcl` - 환경변수 지원, 경로 수정
- `environments/LIVE/gcp-gcby/10-network/variables.tf` - PSC IP 기본값 제거
- `environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars` - VM 키 동적화
- `environments/LIVE/gcp-gcby/50-workloads/terragrunt.hcl` - VM 이름 자동 생성
- `environments/LIVE/gcp-gcby/65-cache/terragrunt.hcl` - 환경변수 기본값 추가

### Bootstrap 파일
- `bootstrap/10-network/outputs.tf` - 리소스 참조 수정

---

## 학습 사항

### Terragrunt 함수 비교

| 함수 | 반환값 | 용도 |
|------|--------|------|
| `get_terragrunt_dir()` | 현재 terragrunt.hcl 위치 | 레이어 디렉토리 참조 |
| `find_in_parent_folders("root.hcl")` | root.hcl 전체 경로 | 상위 설정 파일 찾기 |
| `dirname(path)` | 디렉토리 경로 | 파일 경로에서 디렉토리 추출 |

### get_env() 사용 패턴

```hcl
# 필수 환경변수 (기본값 없음) - 에러 발생 가능
state_bucket = get_env("TG_STATE_BUCKET")

# 선택적 환경변수 (기본값 있음) - 권장
state_bucket = get_env("TG_STATE_BUCKET", "default-bucket-name")
```

### 코드 재사용성 향상 패턴

1. **중앙 설정 파일**: `common.naming.tfvars`에 프로젝트별 설정 집중
2. **동적 이름 생성**: terragrunt.hcl에서 `${project_name}-${key}` 패턴 사용
3. **환경변수 fallback**: `get_env("VAR", "default")` 패턴으로 유연성 확보
4. **기본값 제거**: 하드코딩된 기본값 대신 terragrunt에서 주입

---

## 다음 단계

### 완료된 작업
- [x] gcp-gcby 환경 하드코딩 제거
- [x] Bootstrap outputs.tf 에러 수정
- [x] root.hcl 경로 수정
- [x] 65-cache 환경변수 기본값 추가

### 향후 계획
1. **proj-default-templet 동기화** (우선순위: 높)
   - gcp-gcby 변경사항을 템플릿에 반영
   - 새 프로젝트 생성 시 일관성 유지

2. **main 브랜치 merge** (우선순위: 높)
   - 433_code 브랜치 변경사항을 main에 반영
   - Jenkins가 main 브랜치 사용 시 필요

3. **문서화** (우선순위: 중)
   - 새 프로젝트 생성 가이드 업데이트
   - 환경변수 설정 방법 문서화

---

## 요약

### 핵심 성과
1. **코드 재사용성 향상**: gcp-gcby 폴더 복사 후 `common.naming.tfvars`만 수정하면 새 프로젝트 배포 가능
2. **환경변수 지원**: TG_* 환경변수로 다양한 환경 설정 가능
3. **동적 이름 생성**: VM, Instance Group 이름이 project_name 기반으로 자동 생성
4. **에러 수정**: Jenkins 배포 시 발생한 4개 에러 모두 해결

### 변경 규모
- **커밋 수**: 4개
- **수정 파일**: 6개
- **코드 변경**: +약 50줄, -약 30줄

---

## 5. 50-workloads network_ip 주입 문제 해결 (Session 2)

### 문제 현상
Jenkins Plan에서 VM의 `network_ip`가 설정한 값이 아닌 `(known after apply)`로 표시됨

**기대값:**
- gs01: `10.10.11.3`
- gs02: `10.10.11.6`

**실제 결과:**
```
network_ip = (known after apply)
```

### 근본 원인 분석

#### 1차 문제: `instances_with_network_ip` local 정의 누락
베스트 프랙티스 리팩토링 과정에서 network_ip를 주입하는 local 변수가 삭제됨

**작동했던 버전 (commit c998508):**
```hcl
locals {
  instances_with_zones = {
    for k, v in try(local.layer_inputs.instances, {}) :
    "${local.project_name}-${k}" => merge(v, {
      zone       = "${local.region_primary}-${v.zone_suffix}"
      network_ip = try(local.vm_ips[v.vm_ip_key], try(v.network_ip, null))
    })
  }
}
```

**깨진 버전:**
```hcl
locals {
  # instances_with_network_ip 정의가 없음!
}

inputs = {
  instances = local.instances_with_network_ip  # ← 존재하지 않는 local 참조
}
```

#### 2차 문제: terraform.tfvars 자동 로드 충돌
Terraform은 `terraform.tfvars` 파일을 **자동으로 로드**함. Terragrunt in-place 실행 모드에서:
1. `terraform.tfvars`의 `instances` (network_ip 없음)가 Terraform에 의해 자동 로드
2. Terragrunt inputs의 `instances` (network_ip 있음)도 전달
3. **terraform.tfvars가 우선 적용**되어 network_ip가 null이 됨

### 해결 방법

#### Step 1: terragrunt.hcl에 instances_with_network_ip 재정의
```hcl
locals {
  # VM Static IP 맵 (common.naming.tfvars에서 가져오기)
  vm_ips = try(
    local.common_inputs.vm_static_ips,
    try(local.common_inputs.network_config.vm_ips, {})
  )

  # instances에 network_ip 주입
  instances_with_network_ip = {
    for k, v in try(local.layer_inputs.instances, {}) :
    k => merge(v, {
      network_ip = try(v.network_ip, lookup(local.vm_ips, k, null))
    })
  }
}
```

#### Step 2: terraform.tfvars → workloads.tfvars로 파일명 변경
```bash
mv terraform.tfvars workloads.tfvars
```

```hcl
# terragrunt.hcl 수정
locals {
  # Note: terraform.tfvars는 Terraform이 자동으로 로드하므로, 충돌을 피하기 위해 다른 파일명 사용
  raw_layer_inputs = try(read_tfvars_file("${get_terragrunt_dir()}/workloads.tfvars"), tomap({}))
}
```

### 테스트 결과

**수정 전:**
```
network_ip = (known after apply)
```

**수정 후:**
```
+ network_ip = "10.10.11.3"  # gs01
+ network_ip = "10.10.11.6"  # gs02
```

### 커밋 이력

| 커밋 | 설명 |
|------|------|
| 9d8bb51 | fix: 50-workloads network_ip 주입 수정 - terraform.tfvars 자동로드 충돌 해결 |
| 112ca7a | refactor: common.naming.tfvars에서 중복 vm_ips 제거 |
| ae1a845 | fix: 12-dns에서 vm_static_ips 사용하도록 수정 |

---

## 6. common.naming.tfvars 중복 설정 정리

### 변경 전
```hcl
network_config = {
  # ...
  vm_ips = {           # 중복!
    gs01 = "10.10.11.3"
    gs02 = "10.10.11.6"
  }
}

# 최상위 레벨
vm_static_ips = {      # 실제 사용되는 설정
  gs01 = "10.10.11.3"
  gs02 = "10.10.11.6"
}
```

### 변경 후
```hcl
network_config = {
  # vm_ips 제거
}

# VM Static IP (최상위 레벨만 사용)
vm_static_ips = {
  gs01 = "10.10.11.3"
  gs02 = "10.10.11.6"
}
```

---

## 7. 12-dns terragrunt.hcl 수정

### 에러
```
Error: Unsupported attribute
  on ./12-dns/terragrunt.hcl line 61, in locals:
  61:       rrdatas = [local.network_config.vm_ips.gs01]
This object does not have an attribute named "vm_ips".
```

### 원인
common.naming.tfvars에서 `network_config.vm_ips`를 제거했으나 12-dns에서 여전히 참조

### 해결
```hcl
# 변경 전
rrdatas = [local.network_config.vm_ips.gs01]
rrdatas = [local.network_config.vm_ips.gs02]

# 변경 후
vm_static_ips = try(local.common_inputs.vm_static_ips, {})
rrdatas = [local.vm_static_ips.gs01]
rrdatas = [local.vm_static_ips.gs02]
```

---

## 학습 사항 (Session 2)

### Terraform 자동 로드 파일

| 파일명 | 자동 로드 | 설명 |
|--------|----------|------|
| `terraform.tfvars` | ✅ 예 | Terraform이 항상 자동 로드 |
| `terraform.tfvars.json` | ✅ 예 | JSON 형식도 자동 로드 |
| `*.auto.tfvars` | ✅ 예 | auto 접미사는 자동 로드 |
| `*.auto.tfvars.json` | ✅ 예 | JSON auto도 자동 로드 |
| `custom.tfvars` | ❌ 아니오 | `-var-file` 옵션 필요 |
| `workloads.tfvars` | ❌ 아니오 | terragrunt에서만 읽음 |

### Terragrunt in-place 실행 시 주의사항

1. **terraform.tfvars 충돌**: Terraform 자동 로드와 terragrunt inputs가 같은 변수를 정의하면 충돌
2. **해결책**: tfvars 파일명을 `terraform.tfvars`가 아닌 다른 이름으로 변경
3. **권장 패턴**:
   ```
   environments/LIVE/gcp-gcby/50-workloads/
   ├── terragrunt.hcl      # inputs 정의
   ├── workloads.tfvars    # terragrunt에서만 읽는 변수
   ├── main.tf
   └── variables.tf
   ```

### try() vs lookup() vs coalesce()

| 함수 | 용도 | 예시 |
|------|------|------|
| `try()` | 속성 접근 에러 처리 | `try(v.network_ip, null)` - 속성이 없으면 null |
| `lookup()` | 맵에서 키 조회 | `lookup(map, key, default)` - 키가 없으면 default |
| `coalesce()` | 첫 번째 non-null 값 | `coalesce(a, b, c)` - null이 아닌 첫 값 반환 |

**주의**: `try(v.network_ip, fallback)`에서 `v.network_ip`가 `null`이면 `null`을 반환 (에러가 아님)

---

## 영향을 받은 파일 (Session 2)

### 수정된 파일
- `environments/LIVE/gcp-gcby/50-workloads/terragrunt.hcl` - network_ip 주입 로직 복원
- `environments/LIVE/gcp-gcby/50-workloads/workloads.tfvars` - terraform.tfvars에서 이름 변경
- `environments/LIVE/gcp-gcby/common.naming.tfvars` - 중복 vm_ips 제거
- `environments/LIVE/gcp-gcby/12-dns/terragrunt.hcl` - vm_static_ips 사용

### 삭제된 파일
- `environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars` - workloads.tfvars로 대체

---

## 전체 커밋 이력 (2025-12-04)

| 커밋 | 설명 | Session |
|------|------|---------|
| 363ee19 | gcp-gcby 환경 하드코딩 제거 | Session 1 |
| 1e411ef | bootstrap/10-network outputs.tf 수정 | Session 1 |
| 2f76c61 | root.hcl common.naming.tfvars 경로 수정 | Session 1 |
| d3aab9d | 65-cache/terragrunt.hcl 환경변수 기본값 추가 | Session 1 |
| 9d8bb51 | 50-workloads network_ip 주입 수정 | Session 2 |
| 112ca7a | common.naming.tfvars 중복 vm_ips 제거 | Session 2 |
| ae1a845 | 12-dns에서 vm_static_ips 사용 | Session 2 |

---

## 최종 요약

### Session 2 핵심 성과
1. **network_ip 문제 해결**: VM Static IP가 올바르게 설정됨
2. **근본 원인 파악**: terraform.tfvars 자동 로드로 인한 충돌
3. **코드 정리**: 중복 설정 제거, 일관된 변수 참조

### VM IP 관리 구조 (최종)
```
common.naming.tfvars
└── vm_static_ips = { gs01 = "10.10.11.3", gs02 = "10.10.11.6" }
       │
       ├──→ 50-workloads/terragrunt.hcl (network_ip 주입)
       └──→ 12-dns/terragrunt.hcl (DNS 레코드 생성)
```

---

# Session 3: Cross-Project PSC Redis 연결 및 DNS Zone 충돌 해결

## 개요

- **시작 시간**: Session 2 이후
- **주요 작업**:
  1. Cross-project Redis PSC 연결 완료 및 테스트
  2. Bootstrap 12-dns DNS Zone 충돌 에러 해결
  3. DNS 아키텍처 정리

---

## 8. Cross-Project Redis PSC 연결 테스트

### 작업 배경
- mgmt VPC의 bastion에서 gcby 프로젝트의 Redis Cluster에 접근 필요
- PSC (Private Service Connect)를 통한 cross-project 연결 구성 완료

### Redis CLI TLS 연결 테스트
Redis Cluster Enterprise는 `AUTH_MODE_DISABLED`여도 TLS 연결이 필수입니다.

```bash
# Bastion에서 Redis CLI로 연결 테스트 (TLS 필수)
./src/redis-cli -h 10.250.20.101 -p 6379 --tls --insecure PING
# 결과: PONG
```

### PSC 연결 구조
```
mgmt VPC (delabs-gcp-mgmt)
└── PSC Forwarding Rules
    ├── gcby-live-redis-0-psc-fr → 10.250.20.101 (Discovery)
    └── gcby-live-redis-1-psc-fr → 10.250.20.102 (Shard)
         │
         ▼
    Service Attachments (gcby 프로젝트)
         │
         ▼
    Redis Cluster (gcby-live-cache)
```

---

## 9. 12-dns DNS Zone 충돌 에러 해결

### 에러 상황
Jenkins에서 bootstrap apply 시 다음 에러 발생:

```
Error: Error updating ManagedZone "projects/delabs-gcp-mgmt/managedZones/delabsgames-internal":
googleapi: Error 400: The DNS name 'delabsgames.internal.' is already being used on network 'gcby-live-vpc'., dnsNameInUse
```

### 원인 분석
1. mgmt DNS Zone (`delabsgames.internal.`)이 gcby-live-vpc를 additional_network로 추가하려 함
2. 그러나 gcby 프로젝트에 이미 동일한 도메인의 DNS Zone이 존재
3. GCP에서는 같은 VPC에 동일 DNS 이름의 Zone을 중복 연결할 수 없음

### 두 가지 옵션
| 옵션 | 설명 | 장단점 |
|------|------|--------|
| **Option 1** | gcby DNS Zone 삭제, mgmt에서 중앙 관리 | 작업량 많음, 다운타임 리스크 |
| **Option 2** | gcby VPC를 mgmt DNS Zone에서 제외 | 최소 변경, 안전 ✅ |

### 선택: Option 2 - has_own_dns_zone 플래그 패턴

### 수정 내용

#### 1. bootstrap/common.hcl
```hcl
projects = {
  gcby = {
    project_id       = "gcp-gcby"
    environment      = "live"
    vpc_name         = "gcby-live-vpc"
    network_url      = "projects/gcp-gcby/global/networks/gcby-live-vpc"
    has_own_dns_zone = true  # 자체 DNS Zone 있음 - mgmt DNS Zone에서 제외
    # ... 나머지 설정
  }
}
```

#### 2. bootstrap/12-dns/terragrunt.hcl
```hcl
inputs = merge(
  local.common_vars.locals,
  local.layer_vars.locals,
  {
    vpc_self_link = dependency.network.outputs.vpc_self_link

    # projects map에서 프로젝트의 network_url 추출하여 DNS Zone에 추가
    # 단, 자체 DNS Zone이 있는 프로젝트(gcby 등)는 제외 (같은 DNS 이름 충돌 방지)
    additional_networks = [
      for key, project in local.common_vars.locals.projects : project.network_url
      if try(project.has_own_dns_zone, false) == false
    ]
  }
)
```

### 검증
```bash
TG_USE_LOCAL_BACKEND=true terragrunt plan
# 결과: No changes. Your infrastructure matches the configuration.
```

---

## 10. DNS 아키텍처 (최종)

### Per-VPC DNS Zone 구조
동일한 도메인(`delabsgames.internal.`)에 대해 VPC별로 다른 IP 해석:

| VPC | DNS Zone | 같은 DNS 이름 → 다른 IP |
|-----|----------|------------------------|
| **gcby-live-vpc** | gcby DNS Zone | gcby-live-gdb-m1 → 10.10.12.51 (내부 IP) |
| **mgmt VPC** | mgmt DNS Zone | gcby-live-gdb-m1 → 10.250.20.51 (PSC IP) |

### 사용 시나리오
```
┌─────────────────────────────────────────────────────────────┐
│  gcby-live-vpc (게임 서버)                                   │
│  ─────────────────────────────────────────────────────────  │
│  GS01/GS02 → gcby-live-gdb-m1.delabsgames.internal          │
│           → 10.10.12.51 (Cloud SQL 내부 IP)                 │
│                                                             │
│  GS01/GS02 → gcby-live-cache.delabsgames.internal           │
│           → 10.10.12.3 (Redis 내부 IP)                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  mgmt VPC (Jenkins/Bastion)                                 │
│  ─────────────────────────────────────────────────────────  │
│  Bastion → gcby-live-gdb-m1.delabsgames.internal            │
│         → 10.250.20.51 (PSC Endpoint)                       │
│                                                             │
│  Bastion → gcby-live-redis.delabsgames.internal             │
│         → 10.250.20.101 (PSC Endpoint)                      │
└─────────────────────────────────────────────────────────────┘
```

### 새 프로젝트 추가 시 가이드

1. **자체 DNS Zone이 있는 프로젝트**
   - `bootstrap/common.hcl`에 `has_own_dns_zone = true` 설정
   - mgmt DNS Zone에 해당 VPC가 추가되지 않음

2. **자체 DNS Zone이 없는 프로젝트**
   - `has_own_dns_zone` 생략 또는 `false`
   - mgmt DNS Zone의 additional_networks에 자동 추가

---

## Session 3 커밋 이력

| 커밋 | 설명 | 내용 |
|------|------|------|
| 42e7a9c | fix: 12-dns에서 자체 DNS Zone 있는 프로젝트 제외 | has_own_dns_zone 플래그 패턴 도입 |

---

## 전체 커밋 이력 (2025-12-04, 업데이트)

| 커밋 | 설명 | Session |
|------|------|---------|
| 363ee19 | gcp-gcby 환경 하드코딩 제거 | Session 1 |
| 1e411ef | bootstrap/10-network outputs.tf 수정 | Session 1 |
| 2f76c61 | root.hcl common.naming.tfvars 경로 수정 | Session 1 |
| d3aab9d | 65-cache/terragrunt.hcl 환경변수 기본값 추가 | Session 1 |
| 9d8bb51 | 50-workloads network_ip 주입 수정 | Session 2 |
| 112ca7a | common.naming.tfvars 중복 vm_ips 제거 | Session 2 |
| ae1a845 | 12-dns에서 vm_static_ips 사용 | Session 2 |
| 42e7a9c | 12-dns에서 자체 DNS Zone 있는 프로젝트 제외 | Session 3 |

---

## 최종 요약 (전체 Session)

### Session 1: 하드코딩 제거
- gcp-gcby 환경의 하드코딩된 값들을 naming 모듈 참조로 변경
- cross-project PSC 구조 개선

### Session 2: VM Static IP 문제 해결
- terraform.tfvars 자동 로드로 인한 충돌 해결
- vm_static_ips 일관된 참조 구조 확립

### Session 3: DNS Zone 충돌 해결 및 Redis PSC 검증
- has_own_dns_zone 플래그 패턴으로 DNS Zone 충돌 방지
- Cross-project Redis PSC 연결 검증 완료 (PING → PONG)
