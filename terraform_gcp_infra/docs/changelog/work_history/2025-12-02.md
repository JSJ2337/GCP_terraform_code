# 2025-12-02 작업 이력

## 작업 개요

### 주요 작업
1. Terraform Lock 파일 정리 및 일관성 확보
2. gcp-gcby 프로젝트 코드 점검 및 수정
3. IPv6 네트워킹 문제 해결
4. Terraform depends_on 최적화
5. Cloud SQL PSC 설정 수정
6. Private Service Connection IP 대역 사용자 지정
7. Cross-Project PSC 접근 구성 (mgmt → gcp-gcby)

---

## 1. Lock 파일 정리

### 문제점
- 37개 lock 파일에 7가지 다른 해시 존재
- jsj-game-n 프로젝트 사용하지 않음
- 일관성 없는 provider 버전

### 해결
```bash
# jsj-game-n 프로젝트 삭제
rm -rf environments/LIVE/jsj-game-n

# 모든 lock 파일 삭제 (26개)
find . -name ".terraform.lock.hcl" -delete
find . -type d -name ".terraform" -exec rm -rf {} +
```

### 결과
- Jenkins에서 provider 재다운로드 후 일관된 lock 파일 생성 예정

---

## 2. gcp-gcby 코드 점검

### 발견된 문제

**문제 1**: SSH 태그 불일치
- **파일**: `environments/LIVE/gcp-gcby/50-workloads/terraform.tfvars:17`
- **문제**: `tags = ["game", "ssh-allowed"]`
- **수정**: `tags = ["game", "ssh-from-iap"]`
- **커밋**: e9228b6

**문제 2**: subnet_types에 불필요한 "db" 포함
- **파일**: `environments/LIVE/gcp-gcby/10-network/main.tf:30`
- **문제**: `subnet_types = ["dmz", "private", "db"]`
- **수정**: `subnet_types = ["dmz", "private"]`
- **이유**: DB subnet 제거 완료, subnet 불필요
- **커밋**: e9228b6

---

## 3. IPv6 네트워킹 문제 해결

### 에러
```
Error: oauth2: cannot fetch token: dial tcp [2404:6800:4008:c02::5f]:443:
connect: network is unreachable
```

### 원인
- WSL2 환경에서 IPv6 활성화되어 있으나 실제 라우팅 불가
- Terraform이 Google API 접근 시 IPv6 시도

### 해결
**파일**: `bootstrap/Jenkinsfile`, `gcp-gcby/Jenkinsfile`, `proj-default-templet/Jenkinsfile.example`

```groovy
environment {
    // IPv4 강제 사용 (IPv6 unreachable 문제 해결)
    GODEBUG = 'netdns=cgo'
}
```

**효과**:
- Go runtime이 IPv4 DNS resolution만 사용
- Google API 접근 정상화

**커밋**: 22c032d

---

## 4. NAT Dependency 문제 해결

### 문제
```
Error: The subnetwork resource 'gcby-subnet-db' is already being used by
'gcby-live-vpc-cr-Nat', resourceInUseByAnotherResource
```

### 분석

**Plan 출력**:
```
~ module.net.google_compute_router_nat.nat will be updated in-place
  - subnetwork { gcby-subnet-db }  # 제거

- module.net.google_compute_subnetwork.subnets["gcby-subnet-db"] will be destroyed
```

**실제 Apply 동작**:
1. Subnet 삭제 시도 (실패 - NAT가 사용 중)
2. NAT 업데이트 (너무 늦음)

### 원인
Terraform의 Dynamic Block `for_each` 축소 시 implicit dependency가 Apply 단계에서 제대로 추적되지 않는 알려진 limitation

### 해결 시도

**시도 1**: NAT에서 DB subnet 제거
- **파일**: `environments/LIVE/gcp-gcby/10-network/main.tf`
- **변경**: `nat_subnet_self_links`에서 `local.db_subnet_self_link` 제거
- **결과**: 실패 (여전히 같은 에러)
- **커밋**: e6e6469

**시도 2**: lifecycle { create_before_destroy }
- **변경**: NAT 리소스에 lifecycle policy 추가
- **결과**: 실패
- **커밋**: a1da6e9 (이후 revert)

**최종 해결**: depends_on 재추가
- **파일**: `modules/network-dedicated-vpc/main.tf`
- **변경**:
```hcl
resource "google_compute_router_nat" "nat" {
  # ...

  # CRITICAL: Terraform의 Dynamic Block for_each 축소 시
  # dependency tracking 버그 우회
  # Plan: NAT 업데이트 → Subnet 삭제 (올바른 순서)
  # Apply: Subnet 삭제 시도 → NAT 업데이트 (잘못된 순서)
  # depends_on으로 명시적 순서 강제
  depends_on = [google_compute_subnetwork.subnets]
}
```
- **커밋**: 8224302

### 웹 리서치 결과
- HashiCorp 공식 문서: implicit dependency 권장
- **하지만**: Dynamic block for_each 축소 시 limitation 존재
- **결론**: 이 경우는 depends_on이 필요한 예외 케이스

**참고**: https://github.com/hashicorp/terraform/issues/28699

---

## 5. depends_on 최적화 검토

### 배경
NAT depends_on 이슈로 인해 전체 codebase의 depends_on 사용 검토

### 분석 결과

**✅ 유지 (Hidden Dependency)**:
- API 활성화 + time_sleep (타이밍 의존성)
- Load balancer cleanup null_resource (destroy provisioner)
- IAM permission propagation (권한 전파 대기)
- **NAT subnetwork** (Dynamic block for_each 축소 시)

**❌ 제거 (Implicit Dependency 가능)**:
- VPC Peering (network 속성으로 암시적 의존성)
- Private Service Connection (reserved_peering_ranges 속성)
- Bootstrap subnet (network 속성)

### 수정 사항
- `environments/LIVE/gcp-gcby/10-network/main.tf`: VPC Peering depends_on 제거
- `modules/network-dedicated-vpc/main.tf`: PSC connection depends_on 제거
- `bootstrap/10-network/main.tf`: VPC Peering depends_on 제거

**커밋**: 28f7548

---

## 6. Cloud SQL PSC Service Class 수정

### 문제
```
Error 400: serviceClass gcp-cloud-sql does not exist: invalid argument
```

### 원인
잘못된 service class 이름 사용

### 해결
- **잘못된 이름**: `gcp-cloud-sql`
- **올바른 이름**: `google-cloud-sql`

**파일 수정**:
- `environments/LIVE/gcp-gcby/10-network/main.tf`
- `proj-default-templet/10-network/main.tf`

```hcl
resource "google_network_connectivity_service_connection_policy" "cloudsql_psc" {
  service_class = "google-cloud-sql"  # 수정
  # ...
}
```

**참고**: GCP 공식 문서 - https://cloud.google.com/sql/docs/mysql/configure-private-service-connect

**커밋**: 9a13f3b

---

## 7. Private Service Connection IP 대역 변경

### 배경
기존 10.201.3.0/24 (자동 할당) → 10.10.12.0/24 (사용자 지정)

### 문제점
servicenetworking connection은 IP 변경 불가능

### 작업 순서

**1. Cloud SQL 인스턴스 삭제**
```bash
gcloud sql instances delete gcby-live-gdb-m1-read-01 --project=gcp-gcby --quiet
gcloud sql instances delete gcby-live-gdb-m1 --project=gcp-gcby --quiet
```

**2. 기존 IP 주소 삭제**
```bash
gcloud compute addresses delete gcby-live-vpc-psc --global --project=gcp-gcby --quiet
```

**3. Terraform 코드 수정**
- **파일**: `environments/LIVE/gcp-gcby/10-network/terraform.tfvars`
```hcl
enable_private_service_connection = true
private_service_connection_address = "10.10.12.0"
private_service_connection_prefix_length = 24
```

- **파일**: `proj-default-templet/10-network/terraform.tfvars` (템플릿도 동일)
```hcl
enable_private_service_connection = true
private_service_connection_address = "10.3.2.0"
private_service_connection_prefix_length = 24
```

**커밋**: c809268

### 결과
- 향후 Cloud SQL 생성 시 10.10.12.0/24 대역 사용
- 프로젝트 간 통일된 IP 체계 확립

---

## 8. Cross-Project PSC 접근 설정

### 목적
mgmt VPC의 bastion에서 gcp-gcby Cloud SQL 접근 가능하도록 설정

### 아키텍처
```
mgmt VPC (delabs-gcp-mgmt)
  └─ bastion (10.250.10.6)
      ↓ PSC Endpoint
      ↓ Forwarding Rule → Service Attachment
      ↓
gcp-gcby 프로젝트
  └─ Cloud SQL (PSC Endpoint)
      └─ allowed_consumer_projects = ["delabs-gcp-mgmt"]
```

### 구현

**1. Cloud SQL Allowed Consumer Projects**

**파일**: `modules/cloudsql-mysql/main.tf`
```hcl
ip_configuration {
  dynamic "psc_config" {
    for_each = var.enable_psc ? [1] : []
    content {
      psc_enabled               = true
      allowed_consumer_projects = var.psc_allowed_consumer_projects  # 추가
    }
  }
}
```

**파일**: `modules/cloudsql-mysql/variables.tf`
```hcl
variable "psc_allowed_consumer_projects" {
  type        = list(string)
  description = "PSC 엔드포인트 생성을 허용할 프로젝트 ID 목록"
  default     = []
}
```

**파일**: `environments/LIVE/gcp-gcby/60-database/terraform.tfvars`
```hcl
psc_allowed_consumer_projects = [
  "gcp-gcby",         # 자기 프로젝트
  "delabs-gcp-mgmt"   # mgmt 프로젝트
]
```

**2. mgmt VPC PSC Endpoint 리소스**

**파일**: `bootstrap/12-dns/main.tf`
```hcl
# PSC Endpoint IP 예약
resource "google_compute_address" "psc_endpoints" {
  for_each = var.psc_endpoints

  project      = var.management_project_id
  name         = each.value.name
  address_type = "INTERNAL"
  purpose      = "GCE_ENDPOINT"
  region       = each.value.region
  subnetwork   = each.value.subnetwork
  address      = try(each.value.ip_address, null)
}

# PSC Forwarding Rule
resource "google_compute_forwarding_rule" "psc_endpoints" {
  for_each = var.psc_endpoints

  project               = var.management_project_id
  name                  = "${each.value.name}-fr"
  region                = each.value.region
  network               = var.vpc_self_link
  ip_address            = google_compute_address.psc_endpoints[each.key].id
  load_balancing_scheme = ""
  target                = each.value.service_attachment
}

# DNS 레코드 자동 생성
resource "google_dns_record_set" "psc_endpoint_records" {
  for_each = var.psc_endpoints

  project      = var.management_project_id
  managed_zone = google_dns_managed_zone.private.name
  name         = "${each.value.dns_name}.${var.dns_domain}"
  type         = "A"
  ttl          = 300
  rrdatas      = [google_compute_address.psc_endpoints[each.key].address]
}
```

**파일**: `bootstrap/12-dns/layer.hcl` (템플릿)
```hcl
psc_endpoints = {
  # Cloud SQL 생성 후 Service Attachment URI를 얻어서 주석 해제
  # "gcby-cloudsql" = {
  #   name               = "gcby-cloudsql-psc"
  #   region             = "us-west1"
  #   subnetwork         = "projects/delabs-gcp-mgmt/regions/us-west1/subnetworks/delabs-gcp-mgmt-subnet"
  #   service_attachment = "projects/gcp-gcby/regions/us-west1/serviceAttachments/INSTANCE-pscsa-RANDOM"
  #   dns_name           = "gcby-db"
  #   ip_address         = "10.250.10.20"
  # }
}
```

**커밋**: 3a78fc8

### 다음 단계
1. Jenkins gcp-gcby Phase 2/6 실행
2. Cloud SQL Service Attachment URI 확인
3. bootstrap/12-dns/layer.hcl 주석 해제 및 URI 입력
4. Bootstrap Phase 3 실행
5. Bastion에서 DB 접속 테스트

---

## 9. 변수 정의 누락 수정

### 문제 1
```
Warning: Value for undeclared variable "private_service_connection_address"
```

**원인**: terraform.tfvars에서 사용하나 variables.tf에 정의 없음

**해결**:
- `environments/LIVE/gcp-gcby/10-network/variables.tf`
- `proj-default-templet/10-network/variables.tf`

```hcl
variable "private_service_connection_address" {
  type        = string
  description = "사설 서비스 연결용 예약 IP 범위 시작 주소 (예: 10.10.12.0)"
  default     = ""
}
```

**커밋**: 90acf38

### 문제 2
```
Warning: Value for undeclared variable "psc_allowed_consumer_projects"
```

**해결**:
- `environments/LIVE/gcp-gcby/60-database/variables.tf`

```hcl
variable "psc_allowed_consumer_projects" {
  type        = list(string)
  description = "PSC 엔드포인트 생성을 허용할 프로젝트 ID 목록"
  default     = []
}
```

**커밋**: 02847ab

---

## 10. 문서 업데이트

### 첫 번째 업데이트
- `docs/architecture/network-design.md`
  - service_class 올바른 이름 수정 (`google-cloud-sql`)
  - Private Service Connection IP 대역 사용자 지정 섹션 추가
  - Cross-Project PSC 접근 섹션 추가

### 두 번째 업데이트 (PSC 리전 제약사항 추가)
- `docs/architecture/network-design.md`
  - PSC 리전 제약사항 섹션 추가
  - mgmt VPC 멀티리전 서브넷 구성 예시 추가
  - PSC Endpoint 설정 예시를 실제 us-west1 구성으로 업데이트
  - DNS 이름을 gcby-live-gdb-m1로 업데이트
  - Bastion 접속 테스트 명령어 추가

- `docs/changelog/work_history/2025-12-02.md`
  - PSC 리전 제약사항 해결 섹션 추가
  - mgmt VPC us-west1 서브넷 추가 작업 기록
  - 커밋 요약에 새 커밋 4개 추가
  - 주요 배운 점에 PSC 리전 제약사항 추가

---

## 11. PSC 리전 제약사항 해결

### 문제 발견

Jenkins에서 Bootstrap 12-dns apply 실행 시 에러:

```
Error: Error creating Address: googleapi: Error 404: The resource
'projects/delabs-gcp-mgmt/regions/us-west1/subnetworks/delabs-gcp-mgmt-subnet'
was not found, notFound
```

### 원인 분석

**PSC Endpoint 리전 제약사항**:
- PSC Endpoint는 Service Attachment와 **동일 리전**에 있어야 함
- 리전 간 PSC는 지원되지 않음

**현재 상황**:
```text
❌ Cloud SQL: us-west1
   PSC Endpoint 시도: asia-northeast3 (mgmt 기본 서브넷)
   → 리전 불일치로 실패
```

### 해결 방법

mgmt VPC에 us-west1 서브넷 추가:

**파일**: `bootstrap/10-network/layer.hcl`

```hcl
locals {
  # Primary Subnet (asia-northeast3)
  subnet_cidr = "10.250.10.0/24"

  # us-west1 Subnet (PSC Endpoint용)
  subnet_cidr_us_west1 = "10.250.20.0/24"
}
```

**파일**: `bootstrap/10-network/main.tf`

```hcl
# us-west1 subnet 추가
resource "google_compute_subnetwork" "mgmt_subnet_us_west1" {
  name          = "${var.management_project_id}-subnet-us-west1"
  ip_cidr_range = var.subnet_cidr_us_west1
  region        = "us-west1"
  network       = google_compute_network.mgmt_vpc.id

  private_ip_google_access = true
}

# us-west1 Router 및 NAT
resource "google_compute_router" "mgmt_router_us_west1" {
  name    = "${var.management_project_id}-router-us-west1"
  region  = "us-west1"
  network = google_compute_network.mgmt_vpc.id
  bgp { asn = 64515 }
}

resource "google_compute_router_nat" "mgmt_nat_us_west1" {
  name   = "${var.management_project_id}-nat-us-west1"
  router = google_compute_router.mgmt_router_us_west1.name
  region = "us-west1"

  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"
}
```

### PSC Endpoint 설정 수정

**파일**: `bootstrap/12-dns/layer.hcl`

```hcl
psc_endpoints = {
  "gcby-cloudsql" = {
    name               = "gcby-cloudsql-psc"
    region             = "us-west1"  # Cloud SQL과 동일 리전
    subnetwork         = "projects/delabs-gcp-mgmt/regions/us-west1/subnetworks/delabs-gcp-mgmt-subnet-us-west1"
    service_attachment = "projects/va89486946f7d978dp-tp/regions/us-west1/serviceAttachments/a-be04a6986d44-psc-service-attachment-a54302c8eccd8399"
    dns_name           = "gcby-live-gdb-m1"
    ip_address         = "10.250.20.20"  # us-west1 서브넷 대역
  }
}
```

### 변경사항 요약

| 항목 | Before | After |
|------|--------|-------|
| **mgmt 서브넷** | asia-northeast3만 | asia-northeast3 + us-west1 |
| **서브넷 CIDR** | 10.250.10.0/24 | 10.250.10.0/24 + 10.250.20.0/24 |
| **PSC Endpoint IP** | 10.250.10.20 | 10.250.20.20 |
| **DNS 이름** | gcby-db | gcby-live-gdb-m1 |

**커밋**:
- e7a4636 - mgmt VPC PSC Endpoint 초기 설정
- ccb060e - DNS 이름을 gcby-gdb-m1로 변경
- 53966da - DNS 이름에 live 추가 (gcby-live-gdb-m1)
- 32470ca - mgmt VPC us-west1 서브넷 추가 및 PSC Endpoint 리전 수정

---

## 커밋 요약

| 커밋 | 제목 | 파일 |
|------|------|------|
| e9228b6 | gcp-gcby 코드 점검 및 수정 | 10-network/main.tf, 50-workloads/terraform.tfvars |
| 277a016 | proj-default-templet 동기화 | proj-default-templet/10-network/main.tf |
| 22c032d | IPv6 문제 해결 (GODEBUG) | */Jenkinsfile |
| e6e6469 | NAT에서 DB subnet 제거 | 10-network/main.tf |
| a1da6e9 | NAT lifecycle policy 추가 (revert) | - |
| 154a456 | depends_on 제거 시도 (revert) | - |
| 8224302 | NAT depends_on 재추가 (최종) | modules/network-dedicated-vpc/main.tf |
| 28f7548 | depends_on 최적화 | */10-network/main.tf, modules/*, bootstrap/* |
| d36761c | Cloud SQL PSC Policy 비활성화 (오류) | */10-network/terraform.tfvars |
| 9a13f3b | Cloud SQL service class 수정 | */10-network/main.tf |
| c809268 | Private Service Connection IP 변경 | */10-network/terraform.tfvars |
| 3a78fc8 | PSC Cross-Project 접근 설정 | bootstrap/12-dns/*, modules/cloudsql-mysql/*, proj-default-templet/60-database/* |
| 90acf38 | private_service_connection_address 변수 추가 | */10-network/variables.tf |
| f4fe623 | mgmt 프로젝트 접근 허용 | gcp-gcby/60-database/terraform.tfvars |
| 02847ab | psc_allowed_consumer_projects 변수 추가 | gcp-gcby/60-database/variables.tf |
| e7a4636 | mgmt VPC PSC Endpoint 초기 설정 | bootstrap/12-dns/layer.hcl |
| ccb060e | DNS 이름을 gcby-gdb-m1로 변경 | bootstrap/12-dns/layer.hcl |
| 53966da | DNS 이름에 live 추가 | bootstrap/12-dns/layer.hcl |
| 32470ca | mgmt VPC us-west1 서브넷 추가 | bootstrap/10-network/* |
| 0d6c42f | 테스트 | - |
| f660ac1 | Cloud SQL 모듈에 psc_allowed_consumer_projects 전달 누락 수정 | gcp-gcby/60-database/main.tf |
| 7c3fa3d | Read Replica PSC allowed_consumer_projects 빈 배열 오류 수정 | modules/cloudsql-mysql/main.tf |
| 78ea66e | PSC allowed projects를 Terraform best practice로 개선 | modules/cloudsql-mysql/*, gcp-gcby/60-database/*, gcp-gcby/root.hcl, proj-default-templet/* |
| d127fe3 | main.tf에서 management_project_id 자동 추가 로직 구현 | gcp-gcby/60-database/main.tf, proj-default-templet/60-database/main.tf |
| ad5abe3 | PSC Forwarding Rule에 Global Access 활성화 | bootstrap/10-network/* |
| 58f5d87 | PSC Forwarding Rule IP 주소 예약 리소스 추가 | bootstrap/10-network/main.tf |

---

## 주요 배운 점

### 1. Terraform Implicit vs Explicit Dependencies
- **일반 원칙**: Implicit dependency 권장 (HashiCorp best practice)
- **예외**: Dynamic block `for_each` 축소 시 depends_on 필요
- **이유**: Plan과 Apply의 실행 순서 불일치 버그

### 2. GCP Service Class 이름
- Cloud SQL: `google-cloud-sql` (not `gcp-cloud-sql`)
- Memorystore Redis: `gcp-memorystore-redis`
- 공식 문서 확인 필수

### 3. Private Service Connect 종류
- **Service Connection Policy**: Memorystore, Cloud SQL (Service Attachment 자동 생성)
- **PSC Endpoint**: 수동 생성, Service Attachment URI 필요

### 4. WSL2 IPv6 이슈
- `GODEBUG='netdns=cgo'`로 IPv4 강제 사용
- Go 기반 도구들 (Terraform, Terragrunt)에 효과적

### 5. Cross-Project PSC 베스트 프랙티스
- Cloud SQL: `psc_config.allowed_consumer_projects` 설정
- Consumer: PSC Endpoint + Forwarding Rule 생성
- DNS: 중앙 관리 (mgmt VPC)

### 6. PSC 리전 제약사항 (중요!)
- **PSC Endpoint는 Service Attachment와 동일 리전에 있어야 함**
- 리전 간 PSC는 지원되지 않음
- Cloud SQL이 us-west1에 있으면 PSC Endpoint도 us-west1 서브넷에 생성
- 멀티리전 구성: VPC에 필요한 모든 리전의 서브넷 사전 생성
- 각 리전마다 별도의 Router 및 NAT 필요

### 7. PSC Global Access (Cross-Region 접근)
- **PSC Endpoint는 동일 리전에 있어야 하지만**, `allow_psc_global_access = true` 설정으로 다른 리전에서 접근 가능
- 예: Cloud SQL (us-west1), Bastion (asia-northeast3) → Global Access로 연결
- GCP 공식 문서: "clients from all regions can access this forwarding rule"
- **중요**: Service Attachment는 같은 리전, Forwarding Rule에 Global Access 설정

### 8. Terraform tfvars 제약사항
- **terraform.tfvars는 값 할당 파일**이지 변수 참조 불가
- `var.xxx` 사용 불가 → 에러: "Variables not allowed"
- 해결: main.tf의 `locals`에서 변수 조합 후 모듈에 전달

### 9. Terraform Best Practice - DRY 원칙
- **Data Source로 자동 감지**: `data.google_project.current.project_id`
- **중앙 관리**: management_project_id를 root.hcl에서 한 번만 정의
- **Locals로 조합**: 자동 감지 + 중앙 관리 + 추가 프로젝트
- **결과**: 하드코딩 제거, 유지보수성 향상

### 10. GCP Forwarding Rule IP 주소 지정
- **문자열 직접 지정 불가**: `ip_address = "10.x.x.x"` → 에러
- **리소스 참조 필요**: `google_compute_address` 먼저 생성
- `purpose = "GCE_ENDPOINT"` 설정 필수
- Forwarding Rule에서 `ip_address = google_compute_address.xxx.id` 참조

---

## 12. PSC 연결 문제 해결 및 Best Practice 적용

### 문제 1: PSC Forwarding Rule CLOSED 상태

**발견**:
```bash
gcloud compute forwarding-rules describe gcby-cloudsql-psc-fr
# pscConnectionStatus: CLOSED
```

**원인**: 기존 Cloud SQL 삭제 후 새로 생성하면서 Service Attachment가 변경됨

**해결**:
```bash
# CLOSED 상태 Forwarding Rule 삭제
gcloud compute forwarding-rules delete gcby-cloudsql-psc-fr \
  --region=us-west1 --project=delabs-gcp-mgmt --quiet
```

### 문제 2: Cloud SQL allowed_consumer_projects 누락

**에러**: PSC Connection이 PENDING 상태에서 ACCEPTED로 변경 안됨

**원인**: Cloud SQL에 `psc_allowed_consumer_projects` 설정 누락

**해결 1단계**: Module에 변수 전달
```hcl
# environments/LIVE/gcp-gcby/60-database/main.tf
module "mysql" {
  enable_psc                    = var.enable_psc
  psc_allowed_consumer_projects = var.psc_allowed_consumer_projects  # 추가
}
```

**커밋**: f660ac1

### 문제 3: Read Replica PSC 설정 하드코딩

**발견**: Master는 정상이나 Read Replica는 빈 배열

**원인**: modules/cloudsql-mysql/main.tf:205에 하드코딩
```hcl
allowed_consumer_projects = []  # 하드코딩!
```

**해결**:
```hcl
# modules/cloudsql-mysql/main.tf:205
allowed_consumer_projects = var.psc_allowed_consumer_projects
```

**커밋**: 7c3fa3d

### 문제 4: Terraform Best Practice 위반

**이슈**: 프로젝트 ID 하드코딩
```hcl
psc_allowed_consumer_projects = [
  "gcp-gcby",         # 하드코딩
  "delabs-gcp-mgmt"   # 하드코딩
]
```

**Best Practice 적용**:

1. **Module에 Data Source 추가** (modules/cloudsql-mysql/main.tf)
```hcl
# 자기 프로젝트 자동 감지
data "google_project" "current" {
  project_id = var.project_id
}

locals {
  psc_allowed_projects = distinct(concat(
    [data.google_project.current.project_id],  # 자동 포함
    var.psc_allowed_consumer_projects
  ))
}
```

2. **Root에 Management Project 정의** (environments/LIVE/gcp-gcby/root.hcl)
```hcl
inputs = {
  management_project_id = "delabs-gcp-mgmt"  # 한 곳에서 관리
}
```

3. **Layer에서 자동 조합** (environments/LIVE/gcp-gcby/60-database/main.tf)
```hcl
locals {
  psc_allowed_projects = distinct(concat(
    var.psc_allowed_consumer_projects,
    [var.management_project_id]  # root.hcl에서 자동 추가
  ))
}

module "mysql" {
  psc_allowed_consumer_projects = local.psc_allowed_projects
}
```

4. **tfvars 간소화**
```hcl
# 자기 프로젝트와 mgmt는 자동 추가됨
# 추가 프로젝트만 명시
psc_allowed_consumer_projects = []
```

**커밋**: 78ea66e

### 문제 5: tfvars에서 변수 참조 불가

**에러**:
```
Error: Variables not allowed
  on terraform.tfvars line 40:
  40:   var.management_project_id
Variables may not be used here.
```

**원인**: terraform.tfvars는 값 할당 파일이지 변수 참조 불가

**해결**: main.tf의 local 변수에서 자동 추가
```hcl
# environments/LIVE/gcp-gcby/60-database/main.tf
locals {
  psc_allowed_projects = distinct(concat(
    var.psc_allowed_consumer_projects,
    [var.management_project_id]
  ))
}
```

**커밋**: d127fe3

---

## 13. PSC Global Access 문제 발견 및 해결

### 문제 발견

**테스트 실패**:
```bash
# Bastion (asia-northeast3)에서 Cloud SQL (us-west1) 접속 불가
nc -zv gcby-live-gdb-m1.delabsgames.internal 3306
# Ncat: TIMEOUT
```

**원인 조사**:
```bash
gcloud compute forwarding-rules describe gcby-cloudsql-psc-fr \
  --region=us-west1 --project=delabs-gcp-mgmt \
  --format="value(allowPscGlobalAccess)"
# Result: False ❌
```

**GCP 공식 문서 확인**:
> "By using the optional `--allow-psc-global-access` parameter, clients from all regions can access this forwarding rule."

**문제**: Cross-region PSC 접근을 위해서는 Global Access 활성화 필수!

### 해결: Terraform 코드로 관리

**1. layer.hcl에 PSC Endpoint 정의**
```hcl
# bootstrap/10-network/layer.hcl
psc_endpoints = {
  gcby-cloudsql = {
    region                    = "us-west1"
    ip_address                = "10.250.20.20"
    target_service_attachment = "projects/va89486946f7d978dp-tp/regions/us-west1/serviceAttachments/a-ddb66ab8241d-psc-service-attachment-e4480ecfda9f3356"
    allow_global_access       = true  # Cross-region 활성화 ✅
  }
}
```

**2. variables.tf에 변수 추가**
```hcl
# bootstrap/10-network/variables.tf
variable "psc_endpoints" {
  type = map(object({
    region                    = string
    ip_address                = string
    target_service_attachment = string
    allow_global_access       = bool
  }))
  default = {}
}
```

**3. main.tf에 리소스 추가**
```hcl
# bootstrap/10-network/main.tf

# IP 주소 예약
resource "google_compute_address" "psc_addresses" {
  for_each = var.psc_endpoints

  name         = "${each.key}-psc-ip"
  region       = each.value.region
  subnetwork   = each.value.region == "us-west1" ? google_compute_subnetwork.mgmt_subnet_us_west1.id : google_compute_subnetwork.mgmt_subnet.id
  address_type = "INTERNAL"
  address      = each.value.ip_address
  purpose      = "GCE_ENDPOINT"
}

# PSC Forwarding Rule
resource "google_compute_forwarding_rule" "psc_endpoints" {
  for_each = var.psc_endpoints

  name                    = "${each.key}-psc-fr"
  region                  = each.value.region
  network                 = google_compute_network.mgmt_vpc.id
  ip_address              = google_compute_address.psc_addresses[each.key].id
  load_balancing_scheme   = ""
  target                  = each.value.target_service_attachment
  allow_psc_global_access = each.value.allow_global_access  # ✅
}
```

**커밋**:
- ad5abe3 - PSC Forwarding Rule에 Global Access 활성화
- 58f5d87 - IP 주소 예약 리소스 추가 (URL malformed 에러 해결)

### 기술적 이슈: IP 주소 직접 지정 불가

**에러**:
```
Error 400: Invalid value for field 'resource.IPAddress': '10.250.20.20'.
The URL is malformed., invalid
```

**원인**: Forwarding Rule의 `ip_address`는 문자열이 아닌 리소스 참조 필요

**해결**: `google_compute_address` 리소스 먼저 생성
```hcl
resource "google_compute_address" "psc_addresses" {
  address_type = "INTERNAL"
  address      = each.value.ip_address  # 여기서 실제 IP 지정
  purpose      = "GCE_ENDPOINT"
}

resource "google_compute_forwarding_rule" "psc_endpoints" {
  ip_address = google_compute_address.psc_addresses[each.key].id  # 리소스 참조
}
```

---

## 다음 작업 예정

### 즉시
1. ✅ Jenkins gcp-gcby Phase 2 실행 (10-network, 60-database)
2. ✅ Service Attachment URI 확인
3. ✅ mgmt VPC PSC Endpoint 코드 설정
4. ✅ mgmt VPC us-west1 서브넷 추가
5. ✅ Bootstrap Jenkins 10-network apply (us-west1 서브넷 생성)
6. ✅ PSC Global Access 문제 발견 및 해결
7. ⏳ Bootstrap Jenkins 10-network apply (PSC Forwarding Rule 생성)
8. ⏳ Bastion → DB 접속 테스트

### 향후
1. 다른 프로젝트도 동일한 PSC 구조 적용
2. Cloud SQL 백업 자동화 검증
3. Read Replica failover 테스트
4. DB 접근 로그 모니터링 설정

---

## 참고 자료

- [Terraform Dependencies Tutorial](https://developer.hashicorp.com/terraform/tutorials/configuration-language/dependencies)
- [Terraform Issue #28699](https://github.com/hashicorp/terraform/issues/28699) - Dynamic block dependency tracking
- [Cloud SQL PSC Documentation](https://cloud.google.com/sql/docs/mysql/configure-private-service-connect)
- [GCP Service Classes](https://cloud.google.com/vpc/docs/about-service-connection-policies#service-classes)
- [Network Design Document](../architecture/network-design.md)
