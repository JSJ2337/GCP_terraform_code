# ì‘ì—… ì´ë ¥ - 2025-11-09

**ì‘ì—…ì**: jsj
**ë¸Œëœì¹˜**: 433_code

---

## ğŸ¯ ì‘ì—… ìš”ì•½

GCP í´ë” êµ¬ì¡° ìë™í™” ë° ìœ ì—°í•œ ê²Œì„/ë¦¬ì „ ì¡°í•© ì§€ì› ì‹œìŠ¤í…œ êµ¬ì¶•

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. Cloud Logging API í™œì„±í™” íƒ€ì´ë° ì´ìŠˆ í•´ê²°

**ë¬¸ì œ:**
- jsj-game-j/00-project ë°°í¬ ì‹œ Cloud Logging API í™œì„±í™” ì „ì— ë¡œê·¸ ë²„í‚· ìƒì„± ì‹œë„
- ì—ëŸ¬: `Error 403: Cloud Logging API has not been used in project 110061486541`

**í•´ê²°:**
- `modules/project-base/main.tf`ì˜ `google_logging_project_bucket_config` depends_on ìˆ˜ì •
- ê¸°ì¡´: `google_project_service.services` (ì „ì²´ ë§µ)
- ë³€ê²½: `google_project_service.services["logging.googleapis.com"]` (ëª…ì‹œì  ì°¸ì¡°)
- 60ì´ˆ ëŒ€ê¸° ì‹œê°„ê³¼ í•¨ê»˜ ì´ì¤‘ ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ ì ìš©

**íŒŒì¼ ìˆ˜ì •:**
- `modules/project-base/main.tf:79-82`

```hcl
depends_on = [
  google_project_service.services["logging.googleapis.com"],
  time_sleep.wait_for_logging_api
]
```

---

### 2. GCP í´ë” êµ¬ì¡° ìƒì„±

**ìƒì„±ëœ í´ë”:**
```
organizations/REDACTED_ORG_ID (jsj-dev.com)
  â””â”€ games (folders/166306229523)
      â””â”€ kr-region (folders/884457759175)
          â”œâ”€ LIVE (folders/587862617074)
          â”œâ”€ Staging (folders/832653143511)
          â””â”€ GQ-dev (folders/873010178233)
```

**ì‘ì—… ë‚´ìš©:**
- Bootstrapì— google_folder ë¦¬ì†ŒìŠ¤ ì¶”ê°€
- 3ë‹¨ê³„ í´ë” êµ¬ì¡° (ê²Œì„ â†’ ë¦¬ì „ â†’ í™˜ê²½)
- jsj-game-j í”„ë¡œì íŠ¸ë¥¼ LIVE í´ë”ì— ë°°ì¹˜
- í´ë” ID ì¶œë ¥ê°’ ì¶”ê°€

**íŒŒì¼ ìˆ˜ì •:**
- `bootstrap/main.tf`: í´ë” ë¦¬ì†ŒìŠ¤ 5ê°œ ì¶”ê°€
- `bootstrap/outputs.tf`: í´ë” ID ì¶œë ¥ 5ê°œ ì¶”ê°€
- `environments/LIVE/jsj-game-j/00-project/terraform.tfvars`: folder_id ì„¤ì •

---

### 3. Bootstrap Remote Stateë¡œ í´ë” ID ìë™ ì°¸ì¡°

**ë¬¸ì œ:**
- ë§¤ë²ˆ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ í´ë” IDë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•¨
- í™•ì¥ì„± ë¶€ì¡± (games2, games3 ì¶”ê°€ ì‹œ ê´€ë¦¬ ë³µì¡)

**í•´ê²°:**
- Terraform remote state data source ì¶”ê°€
- Bootstrapì˜ outputì„ ìë™ìœ¼ë¡œ ì°¸ì¡°
- terraform.tfvarsì—ì„œ folder_id ìˆ˜ë™ ì…ë ¥ ì œê±°

**íŒŒì¼ ìˆ˜ì •:**
- `environments/LIVE/jsj-game-j/00-project/main.tf`:
  ```hcl
  data "terraform_remote_state" "bootstrap" {
    backend = "local"
    config = {
      path = "../../../../bootstrap/terraform.tfstate"
    }
  }

  folder_id = data.terraform_remote_state.bootstrap.outputs.folder_live_id
  ```

- `environments/LIVE/jsj-game-j/00-project/terraform.tfvars`: folder_id ë¼ì¸ ì œê±°
- `environments/LIVE/jsj-game-j/00-project/variables.tf`: folder_id default = null ì¶”ê°€

**ì¥ì :**
- í´ë” ID ìë™ ì°¸ì¡°
- ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ìˆ˜ë™ ì‘ì—… ìµœì†Œí™”
- Bootstrapì—ì„œ ì¤‘ì•™ ê´€ë¦¬

---

### 4. ê²Œì„ë³„ ë‹¤ë¥¸ ë¦¬ì „ ì¡°í•© ì§€ì›í•˜ëŠ” ìœ ì—°í•œ í´ë” êµ¬ì¡°

**ìš”êµ¬ì‚¬í•­:**
- gamesëŠ” kr-region, us-region ì‚¬ìš©
- games2ëŠ” jp-region, uk-region ì‚¬ìš©
- games3ëŠ” kr-regionë§Œ ì‚¬ìš©
- ê° ê²Œì„ë§ˆë‹¤ ë‹¤ë¥¸ ë¦¬ì „ ì¡°í•© í•„ìš”

**êµ¬í˜„:**
- 3ì°¨ì› for_each êµ¬ì¡° (ê²Œì„ Ã— ë¦¬ì „ Ã— í™˜ê²½)
- `product_regions` ë§µì—ì„œ ê²Œì„ë³„ ì‚¬ìš© ë¦¬ì „ ì •ì˜
- í™˜ê²½(LIVE/Staging/GQ-dev)ì€ ëª¨ë“  ì¡°í•©ì— ìë™ ìƒì„±

**Bootstrap êµ¬ì¡°:**
```hcl
locals {
  product_regions = {
    games  = ["kr-region", "us-region"]
    # games2 = ["jp-region", "uk-region"]
    # games3 = ["kr-region"]
  }

  environments = ["LIVE", "Staging", "GQ-dev"]

  # ê²Œì„-ë¦¬ì „ ì¡°í•© ìë™ ìƒì„±
  product_region_combinations = flatten([...])

  # ê²Œì„-ë¦¬ì „-í™˜ê²½ ì „ì²´ ì¡°í•© ìë™ ìƒì„±
  folder_combinations = flatten([...])
}

resource "google_folder" "products" {
  for_each = toset(keys(local.product_regions))
  ...
}

resource "google_folder" "regions" {
  for_each = { for combo in local.product_region_combinations : combo.key => combo }
  ...
}

resource "google_folder" "environments" {
  for_each = { for combo in local.folder_combinations : combo.key => combo }
  ...
}
```

**Output êµ¬ì¡°:**
```hcl
output "folder_structure" {
  value = {
    for product, regions in local.product_regions : product => {
      for region in regions : region => {
        for env in local.environments : env =>
        google_folder.environments["${product}/${region}/${env}"].name
      }
    }
  }
}
```

**ìƒì„±ëœ í´ë” êµ¬ì¡°:**
```
games/
  â”œâ”€ kr-region/
  â”‚   â”œâ”€ LIVE (folders/587862617074)
  â”‚   â”œâ”€ Staging (folders/832653143511)
  â”‚   â””â”€ GQ-dev (folders/873010178233)
  â””â”€ us-region/
      â”œâ”€ LIVE (folders/577170857863)
      â”œâ”€ Staging (folders/902417803159)
      â””â”€ GQ-dev (folders/1024560108932)
```

**State ì´ë™ ì‘ì—…:**
- `google_folder.games` â†’ `google_folder.products["games"]`
- `google_folder.kr_region` â†’ `google_folder.regions["games/kr-region"]`
- `google_folder.live` â†’ `google_folder.environments["games/kr-region/LIVE"]`
- `google_folder.staging` â†’ `google_folder.environments["games/kr-region/Staging"]`
- `google_folder.gq_dev` â†’ `google_folder.environments["games/kr-region/GQ-dev"]`

**íŒŒì¼ ìˆ˜ì •:**
- `bootstrap/main.tf`: ì •ì  í´ë” â†’ for_each ë™ì  ìƒì„±ìœ¼ë¡œ ì „í™˜ (75ì¤„ ì¶”ê°€)
- `bootstrap/outputs.tf`: folder_structure ì¤‘ì²© ë§µ ì¶œë ¥ ì¶”ê°€

---

### 5. jsj-game-jë¥¼ ìƒˆë¡œìš´ folder_structure ì‚¬ìš©í•˜ë„ë¡ ì—…ë°ì´íŠ¸

**ë³€ê²½:**
```hcl
# Before
folder_id = data.terraform_remote_state.bootstrap.outputs.folder_live_id

# After
folder_id = data.terraform_remote_state.bootstrap.outputs.folder_structure["games"]["kr-region"]["LIVE"]
```

**ì´ìœ :**
- ê²Œì„/ë¦¬ì „/í™˜ê²½ì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
- ë‹¤ë¥¸ ê²Œì„/ë¦¬ì „ ì¡°í•©ìœ¼ë¡œ ì‰½ê²Œ ë³€ê²½ ê°€ëŠ¥

---

### 6. games2 í´ë” í™•ì¥ ë° Terragrunt ë™ì  í´ë” ì…ë ¥

- Bootstrap `local.product_regions`ì— `games2 = ["jp-region", "uk-region"]`ì„ ì¶”ê°€í•˜ê³  `terraform apply`ë¡œ ìµœìƒìœ„/ë¦¬ì „/í™˜ê²½ í´ë”ê¹Œì§€ ì‹¤ì œ ë°°í¬
- `bootstrap/README.md`ì— `product_regions` í¸ì§‘ ê°€ì´ë“œë¥¼ ì¶”ê°€í•´ ë‹¤ë¥¸ ê²Œì„/ë¦¬ì „ ì¡°í•©ë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•˜ë„ë¡ ë¬¸ì„œí™”
- jsj-game-j ë£¨íŠ¸ Terragrunt `inputs`ì— `folder_product`, `folder_region`, `folder_env`ë¥¼ ì¶”ê°€í•˜ê³  00-projectê°€ í•´ë‹¹ ê°’ì„ ì´ìš©í•´ `folder_structure[...]`ë¥¼ ì¡°íšŒí•˜ë„ë¡ ìˆ˜ì •
  - í•˜ë“œì½”ë”© ì—†ì´ ë‹¤ë¥¸ í´ë” ì¡°í•©ìœ¼ë¡œ ì „í™˜ ê°€ëŠ¥ (Terragrunt ì…ë ¥ë§Œ ë³€ê²½í•˜ë©´ ë¨)
  - ë³€ìˆ˜ ì„ ì–¸ì€ 00-project `variables.tf`ì— ì¶”ê°€í•´ ì¬ì‚¬ìš©ì„± í™•ë³´

---

## ğŸ”§ ì‚¬ìš© ë°©ë²•

### ìƒˆ ê²Œì„/ë¦¬ì „ ì¶”ê°€:

**1. Bootstrap ìˆ˜ì • (bootstrap/main.tf):**
```hcl
locals {
  product_regions = {
    games  = ["kr-region", "us-region"]
    games2 = ["jp-region", "uk-region"]  # ì¶”ê°€!
    games3 = ["kr-region"]               # ì¶”ê°€!
  }
}
```

**2. Bootstrap ë°°í¬:**
```bash
cd bootstrap
terraform apply
```

**3. í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©:**
```hcl
# games2/jp-region/LIVE í”„ë¡œì íŠ¸
folder_id = data.terraform_remote_state.bootstrap.outputs.folder_structure["games2"]["jp-region"]["LIVE"]

# games3/kr-region/Staging í”„ë¡œì íŠ¸
folder_id = data.terraform_remote_state.bootstrap.outputs.folder_structure["games3"]["kr-region"]["Staging"]
```

---

## ğŸ”— ê´€ë ¨ ì»¤ë°‹

- `effe94a` - fix: Cloud Logging API í™œì„±í™” íƒ€ì´ë° ì´ìŠˆ í•´ê²°
- `2982d65` - feat: GCP í´ë” êµ¬ì¡° ìƒì„± ë° jsj-game-j í™˜ê²½ í´ë” ì—°ê²°
- `f6fdda8` - refactor: Bootstrap remote stateë¡œ í´ë” ID ìë™ ì°¸ì¡°
- `56a7306` - feat: ê²Œì„ë³„ ë‹¤ë¥¸ ë¦¬ì „ ì¡°í•© ì§€ì›í•˜ëŠ” ìœ ì—°í•œ í´ë” êµ¬ì¡°ë¡œ ê°œì„ 
- `353aa10` - refactor: jsj-game-jë¥¼ ìƒˆë¡œìš´ folder_structure ì‚¬ìš©í•˜ë„ë¡ ì—…ë°ì´íŠ¸

---

## ğŸ“Š í†µê³„

- **ìˆ˜ì •ëœ íŒŒì¼**: 5ê°œ
- **ì¶”ê°€ëœ ì½”ë“œ ë¼ì¸**: ~120ì¤„
- **ìƒì„±ëœ GCP í´ë”**: 9ê°œ (games/kr-region Ã— 3, games/us-region Ã— 3)
- **ìë™í™”ëœ ì¡°í•©**: ê²Œì„ Ã— ë¦¬ì „ Ã— í™˜ê²½ = ë¬´í•œ í™•ì¥ ê°€ëŠ¥

---

## ğŸ’¡ ì£¼ìš” ê°œì„ ì‚¬í•­

### Before:
```hcl
# ìˆ˜ë™ìœ¼ë¡œ í´ë” ID ì…ë ¥
folder_id = "folders/587862617074"

# ìƒˆ ê²Œì„ ì¶”ê°€ ì‹œ Bootstrapì— 30ì¤„ ì´ìƒ ì½”ë“œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸°
resource "google_folder" "games2" { ... }
resource "google_folder" "games2_kr_region" { ... }
resource "google_folder" "games2_live" { ... }
resource "google_folder" "games2_staging" { ... }
resource "google_folder" "games2_gqdev" { ... }
```

### After:
```hcl
# Bootstrapì—ì„œ ìë™ ì°¸ì¡°
folder_id = data.terraform_remote_state.bootstrap.outputs.folder_structure["games"]["kr-region"]["LIVE"]

# ìƒˆ ê²Œì„ ì¶”ê°€ ì‹œ í•œ ì¤„ë§Œ ì¶”ê°€
locals {
  product_regions = {
    games  = ["kr-region", "us-region"]
    games2 = ["jp-region", "uk-region"]  # ì´ ì¤„ë§Œ ì¶”ê°€!
  }
}
```

---

## ğŸš€ ë‹¤ìŒ ì‘ì—…

1. jsj-game-j/00-project ë°°í¬ í…ŒìŠ¤íŠ¸
2. ë‹¤ë¥¸ ë ˆì´ì–´(10-network, 20-storage ë“±) ë°°í¬
3. ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ê°€ì´ë“œ ë¬¸ì„œí™”
4. games2 ì¶”ê°€ í…ŒìŠ¤íŠ¸ (ë‹¤ë¥¸ ë¦¬ì „ ì¡°í•©)

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [00_README.md](../00_README.md) - í”„ë¡œì íŠ¸ ê°œìš”
- [02_CHANGELOG.md](../02_CHANGELOG.md) - ë³€ê²½ ë¡œê·¸
- [03_QUICK_REFERENCE.md](../03_QUICK_REFERENCE.md) - ë¹ ë¥¸ ì°¸ì¡°
- [Bootstrap README](../bootstrap/README.md) - Bootstrap ì„¤ì • ê°€ì´ë“œ
