version: "3.8"

services:
  # ─────────────────────────────────────────────────────────
  # 1) (선택) Memcached 캐시 서버
  # ─────────────────────────────────────────────────────────
  memcached:
    image: memcached:latest
    container_name: ftt-mimir-memcached
    restart: unless-stopped
    networks:
      - mimir-net

  # ─────────────────────────────────────────────────────────
  # 2) Mimir Monolithic (-target=all)
  #    Distributor→Ingester→Querier→Store-Gateway→Compactor→Query-Frontend
  # ─────────────────────────────────────────────────────────
  mimir:
    image: grafana/mimir:2.16.0
    container_name: ftt-mimir
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65536            # Production 권장치
        hard: 1048576
    healthcheck:
      test: ["CMD-SHELL","curl -f http://localhost:8080/-/ready || exit 1"]
      interval: 30s            # 헬스체크
      timeout: 10s
      retries: 3
      start_period: 30s
    command:
      - "-target=all"
      - "-config.file=/etc/mimir/mimir-config.yaml"
      - "-compactor.data-dir=/var/mimir/compactor"                       # Compactor 작업 디렉터리
      - "-ingester.ring.replication-factor=1"                            # 인게스터 복제 계수 1
      - "-store-gateway.sharding-ring.replication-factor=1"              # (선택) 스토어-게이트웨이 복제 계수 1
      - "-blocks-storage.tsdb.dir=/var/mimir/tsdb"                       # TSDB 헤드 디렉터리 지정
      - "-querier.max-outstanding-requests-per-tenant=50"                # Querier: 테넌트당 동시 처리 요청 제한
#     - "--querier.timeout=2m"                                           # 쿼리 타임아웃 (기본 2분) :contentReference[oaicite:1]{index=1}
      - "--compactor.compaction-interval=2h"                             # compactor 주기 (권장 2시간) :contentReference[oaicite:2]{index=2}
      - "--compactor.compaction-concurrency=2"                           # compaction 동시 작업 수 제한 :contentReference[oaicite:3]{index=3}
    ports:
      - "9009:8080"        # 호스트 9009 → 컨테이너 8080(HTTP)
      - "9095:9095"        # gRPC API
    volumes:
      - ./config/mimir-config.yaml:/etc/mimir/mimir-config.yaml:ro
      - ./data/compactor:/var/mimir/compactor         # compactor 작업 디렉터리
      - ./data/tsdb:/var/mimir/tsdb                   # ← TSDB 헤드 바인드 마운트
    depends_on:
      - memcached
    networks:
      - mimir-net

networks:
  mimir-net:
    external: true