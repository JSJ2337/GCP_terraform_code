version: "3.8"

services:
  # ─────────────────────────────────────────────────────────
  # 1) (선택) Memcached 캐시 서버
  # ─────────────────────────────────────────────────────────
  memcached:
    image: memcached:latest
    container_name: ftt-mimir-memcached
    restart: unless-stopped
    networks:
      - mimir-net

  # ─────────────────────────────────────────────────────────
  # 2) Mimir Monolithic (-target=all)
  #    Distributor→Ingester→Querier→Store-Gateway→Compactor→Query-Frontend
  # ─────────────────────────────────────────────────────────
  mimir:
    image: grafana/mimir:2.16.0
    container_name: ftt-mimir
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65536            # Production 권장치
        hard: 1048576
    healthcheck:
      test: ["CMD-SHELL","curl -f http://localhost:8080/-/ready || exit 1"]
      interval: 30s            # 헬스체크
      timeout: 10s
      retries: 3
      start_period: 30s

    command:
      # ──────[공통 / 모드]─────────────────────────────────────────
      - "-target=all"                                             # 모놀리식(전체 컴포넌트) 모드
      - "-config.file=/etc/mimir/mimir-config.yaml"               # 공통 YAML 경로 지정
      - "-config.expand-env=true"                                 # YAML 내 ${VAR} 치환 허용

      # ──────[TSDB (Ingester Head & Blocks)]─────────────────────
      - "-blocks-storage.tsdb.dir=/var/mimir/tsdb"                # Head·Block 로컬 디렉터리
      - "-blocks-storage.tsdb.retention-period=48h"               # 로컬 데이터 48h 보존
      - "-blocks-storage.tsdb.wal-compression-enabled=true"       # WAL 스냅피 압축
      - "-blocks-storage.tsdb.flush-blocks-on-shutdown=true"      # 종료 시 Head→Block 강제 플러시

      # ──────[Compactor]─────────────────────────────────────────
      - "-compactor.data-dir=/var/mimir/compactor"                # Compactor 작업 디렉터리
      - "-compactor.compaction-interval=2h"                       # Compaction 주기 2h
      - "-compactor.compaction-concurrency=2"                     # 동시 Compaction 2개

      # ──────[Ring 복제]─────────────────────────────────────────
      - "-ingester.ring.replication-factor=1"                     # Ingester 복제 계수 1
      - "-store-gateway.sharding-ring.replication-factor=1"       # Store-GW 복제 계수 1

      # ──────[Store-Gateway 동기화 & 캐시]──────────────────────
      - "-blocks-storage.bucket-store.sync-interval=2m"           # S3 동기화 주기 2m
      - "-blocks-storage.bucket-store.ignore-blocks-within=3h"    # 업로드 3h 미만 블록 무시
      - "-blocks-storage.bucket-store.ignore-deletion-marks-delay=2h" # 삭제마커 30m 유예
      - "-blocks-storage.bucket-store.index-cache.backend=memcached"   # 인덱스 캐시 백엔드
      - "-blocks-storage.bucket-store.index-cache.memcached.addresses=ftt-mimir-memcached:11211" # 인덱스 캐시 주소
      - "-blocks-storage.bucket-store.chunks-cache.backend=memcached"  # 청크 캐시 백엔드
      - "-blocks-storage.bucket-store.chunks-cache.memcached.addresses=ftt-mimir-memcached:11211" # 청크 캐시 주소
      - "-blocks-storage.bucket-store.metadata-cache.backend=memcached" # 메타 캐시 백엔드
      - "-blocks-storage.bucket-store.metadata-cache.memcached.addresses=ftt-mimir-memcached:11211" # 메타 캐시 주소

      # ──────[Querier / Query-Frontend]──────────────────────────
      - "-querier.max-outstanding-requests-per-tenant=1024"       # 테넌트당 동시 요청 1024
      - "-querier.max-concurrent=128"                             # 전체 동시 쿼리 128
      - "-querier.timeout=2m"                                     # 개별 쿼리 타임아웃 2m
      - "-query-frontend.cache-results=true"                      # 결과 캐시 기능 ON
      - "-query-frontend.results-cache.backend=memcached"         # 결과 캐시 백엔드
      - "-query-frontend.results-cache.memcached.addresses=ftt-mimir-memcached:11211" # 결과 캐시 주소
      - "-query-frontend.results-cache.compression=snappy"        # 캐시 결과 스냅피 압축
      - "-query-frontend.query-sharding-target-series-per-shard=50000" # 5만 시리즈 단위 쿼리 분할
      - "-query-frontend.log-queries-longer-than=10s"             # 10s 초과 쿼리 WARN 로그


    ports:
      - "9009:8080"        # 호스트 9009 → 컨테이너 8080(HTTP)
      - "9095:9095"        # gRPC API
    volumes:
      - ./config/mimir-config.yaml:/etc/mimir/mimir-config.yaml:ro
      - ./data/compactor:/var/mimir/compactor         # compactor 작업 디렉터리
      - ./data/tsdb:/var/mimir/tsdb                   # ← TSDB 헤드 바인드 마운트
    depends_on:
      - memcached
    networks:
      - mimir-net

networks:
  mimir-net:
    external: true                            