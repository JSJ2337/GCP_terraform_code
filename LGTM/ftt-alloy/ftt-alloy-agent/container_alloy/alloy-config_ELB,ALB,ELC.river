// ============================================================
// Alloy CloudWatch -> Mimir (tenant: aws-rag)
// Region: ap-southeast-1 (Singapore)
// Live debugging enabled, loglevel=debug
// ============================================================

logging {
  level  = "debug"
  format = "logfmt"
}

livedebugging {
  enabled = true
}

// ------------------------------------------------------------
// 1) RDS metrics
// ------------------------------------------------------------
prometheus.exporter.cloudwatch "rds" {
  sts_region = "ap-southeast-1"

  discovery {
    type    = "AWS/RDS"
    regions = ["ap-southeast-1"]

    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DatabaseConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeStorageSpace"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "ReadIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "WriteIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ReadLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "WriteLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DiskQueueDepth"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkReceiveThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkTransmitThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 2) ALB metrics
// ------------------------------------------------------------
prometheus.exporter.cloudwatch "alb" {
  sts_region = "ap-southeast-1"

  discovery {
    type    = "AWS/ApplicationELB"
    regions = ["ap-southeast-1"]

    // response codes
    metric {
      name       = "HTTPCode_Target_2XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_3XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_4XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_5XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }

    metric {
      name       = "RequestCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TargetResponseTime"
      statistics = ["Average", "p95", "p99"]
      period     = "60s"
    }
    metric {
      name       = "TargetConnectionErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }

    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 3) NLB metrics
// ------------------------------------------------------------
prometheus.exporter.cloudwatch "nlb" {
  sts_region = "ap-southeast-1"

  discovery {
    type    = "AWS/NetworkELB"
    regions = ["ap-southeast-1"]

    metric {
      name       = "ActiveFlowCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NewFlowCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ProcessedBytes"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ConsumedLCUs"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "TCP_Target_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "Client_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TLSNegotiationErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 4) ElastiCache metrics
// ------------------------------------------------------------
prometheus.exporter.cloudwatch "elasticache" {
  sts_region = "ap-southeast-1"

  discovery {
    type    = "AWS/ElastiCache"
    regions = ["ap-southeast-1"]

    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "EngineCPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "CurrConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "BytesUsedForCache"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "Evictions"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "SwapUsage"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesIn"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesOut"
      statistics = ["Sum"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 5) Remote write to Mimir
// ------------------------------------------------------------
prometheus.remote_write "mimir" {
  endpoint {
    url = "http://10.23.50.147:9009/api/v1/push"
    headers = {
      "X-Scope-OrgID" = "aws-rag",
    }
  }
}

// ------------------------------------------------------------
// 6) Scrape all CloudWatch exporter targets
// ------------------------------------------------------------
prometheus.scrape "cloudwatch_all" {
  targets = array.concat(
    prometheus.exporter.cloudwatch.rds.targets,
    prometheus.exporter.cloudwatch.alb.targets,
    prometheus.exporter.cloudwatch.elasticache.targets,
    prometheus.exporter.cloudwatch.nlb.targets,
  )
  scrape_interval = "60s"
  forward_to      = [prometheus.remote_write.mimir.receiver]
}

//////////////////////////////////////////////////////////////
// 7) RDS Logs ─ CloudWatch → Loki
//////////////////////////////////////////////////////////////

otelcol.receiver.awscloudwatch "rds" {
  region = env("AWS_REGION")

  logs {
    poll_interval = "60s"

    groups {
      named { group_name = "/aws/rds/instance/prod-mysql/error"     }
      named { group_name = "/aws/rds/instance/prod-mysql/general"   }
      named { group_name = "/aws/rds/instance/prod-mysql/slowquery" }
    }
  }

  output { logs = [otelcol.exporter.loki.rds.input] }   // OTLP → Loki exporter
}

otelcol.exporter.loki "rds" {
  forward_to = [loki.process.rds_stage.receiver]
}

loki.process "rds_stage" {
  stage.json {
    expressions = {
      db_instance = "dbInstanceIdentifier",
      db_engine   = "dbEngine",
    }
  }
  stage.labels { values = { db_instance = "", db_engine = "" } }
  forward_to   = [loki.write.rds_out.receiver]
}

loki.write "rds_out" {
  endpoint {
    url       = "http://10.23.50.147:3100"
    tenant_id = "aws-rag"
  }
}

//////////////////////////////////////////////////////////////
//8) ALB / NLB Access Logs ─ CloudWatch → Loki
//////////////////////////////////////////////////////////////

otelcol.receiver.awscloudwatch "alb_nlb" {
  region = env("AWS_REGION")

  logs {
    poll_interval = "300s"        // 5 분 주기로 호출 (API 라이트)
    groups {
      named { group_name = "/aws/elasticloadbalancing/alb-prod" }   // ALB
      named { group_name = "/aws/elasticloadbalancing/nlb-prod" }   // NLB
    }
  }

  // OTLP → Loki exporter
  output { logs = [otelcol.exporter.loki.elb.input] }
}

otelcol.exporter.loki "elb" {
  forward_to = [loki.process.elb_stage.receiver]
}

// ── 라벨 추출 & 파싱
loki.process "elb_stage" {
  stage.regex  { expression = "(?P<client_ip>[0-9.]+)\\s+(?P<elb>[^\\s]+)" }
  stage.labels { values = { elb = "elb" } }

  // 에러·5xx 만 남기고 싶으면:
  // stage.filter     { expression = `line =~ " 5.."` }

  forward_to = [loki.write.elb_out.receiver]
}

loki.write "elb_out" {
  endpoint {
    url       = "http://10.23.50.147:3100"
    tenant_id = "aws-rag"
  }
}

//////////////////////////////////////////////////////////////
// 9) Redis Logs ─ CloudWatch → Loki
//////////////////////////////////////////////////////////////

otelcol.receiver.awscloudwatch "redis" {
  region = env("AWS_REGION")

  logs {
    poll_interval = "60s"

    groups {
      named { group_name = "/aws/elasticache/cluster/redis-prod"         }
      named { group_name = "/aws/elasticache/cluster/redis-prod-slowlog" }
    }
  }

  output { logs = [otelcol.exporter.loki.redis.input] }
}

otelcol.exporter.loki "redis" {
  forward_to = [loki.process.redis_stage.receiver]
}

loki.process "redis_stage" {
  stage.json {
    expressions = {
      cache_cluster = "cacheClusterId",
      engine        = "engine",
    }
  }
  stage.labels { values = { cache_cluster = "", engine = "" } }
  forward_to   = [loki.write.redis_out.receiver]
}

loki.write "redis_out" {
  endpoint {
    url       = "http://10.23.50.147:3100"
    tenant_id = "aws-rag"
  }
}
