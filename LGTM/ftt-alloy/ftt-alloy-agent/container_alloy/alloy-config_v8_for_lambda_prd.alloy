// ============================================================
// Main Alloy Configuration (v1.9.1 호환 최종 버전)
// - v1.9.1에서는 role_arn 속성을 지원하지 않으므로 모두 제거합니다.
// - EC2 인스턴스 역할에 sts:AssumeRole 권한이 부여되어야 합니다.
// ============================================================

logging {
  level  = "debug"
  format = "logfmt"
}

livedebugging {
  enabled = true
}// ============================================================
// Main Alloy Configuration (v1.9.1 호환 최종 버전)
// - v1.9.1에서는 role_arn 속성을 지원하지 않으므로 모두 제거합니다.
// - EC2 인스턴스 역할에 sts:AssumeRole 권한이 부여되어야 합니다.
// ============================================================

logging {
  level  = "debug"
  format = "logfmt"
}

livedebugging {
  enabled = true
}

// ------------------------------------------------------------
// 1) CloudWatch Metrics Exporters (서비스별 분리)
// ------------------------------------------------------------

// --- RDS Metrics ---
prometheus.exporter.cloudwatch "rds" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/RDS"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }

    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DatabaseConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeStorageSpace"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "ReadIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "WriteIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ReadLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "WriteLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DiskQueueDepth"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkReceiveThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkTransmitThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- ALB Metrics ---
prometheus.exporter.cloudwatch "alb" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/ApplicationELB"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "HTTPCode_Target_2XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_3XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_4XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_5XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "RequestCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TargetResponseTime"
      statistics = ["Average", "p95", "p99"]
      period     = "60s"
    }
    metric {
      name       = "TargetConnectionErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- NLB Metrics ---
prometheus.exporter.cloudwatch "nlb" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/NetworkELB"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "ActiveFlowCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NewFlowCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ProcessedBytes"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ConsumedLCUs"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "TCP_Target_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "Client_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TLSNegotiationErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- ElastiCache Metrics ---
prometheus.exporter.cloudwatch "elasticache" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/ElastiCache"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "EngineCPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "CurrConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "BytesUsedForCache"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "Evictions"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "SwapUsage"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesIn"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesOut"
      statistics = ["Sum"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 2) Scrape & Remote Write to Mimir
// ------------------------------------------------------------
prometheus.scrape "metrics" {
  targets = concat(
    prometheus.exporter.cloudwatch.rds.targets,
    prometheus.exporter.cloudwatch.alb.targets,
    prometheus.exporter.cloudwatch.nlb.targets,
    prometheus.exporter.cloudwatch.elasticache.targets,
  )
  forward_to = [prometheus.remote_write.mimir.receiver]
}

prometheus.remote_write "mimir" {
  endpoint {
    url = "http://ftt-mimir:8080/api/v1/push"
    headers = {
      "X-Scope-OrgID" = "aws-rag-sin-cw",
    }
  }
}

// ------------------------------------------------------------
// 3) RDS Logs (Lambda -> Alloy -> Loki)
// ------------------------------------------------------------
// /etc/alloy/config.d/rds-pass.alloy

loki.source.api "lambda_receiver" {
  http {
    listen_address = "0.0.0.0"
    listen_port    = 9080
  }
  // 라벨 가공 없이 바로 Loki로
  forward_to = [loki.write.rds_out.receiver]
}

loki.write "rds_out" {
  endpoint {
    url       = "http://ftt-loki:3100/loki/api/v1/push"
    tenant_id = "aw

// ------------------------------------------------------------
// 1) CloudWatch Metrics Exporters (서비스별 분리)
// ------------------------------------------------------------

// --- RDS Metrics ---
prometheus.exporter.cloudwatch "rds" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/RDS"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }

    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DatabaseConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeStorageSpace"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "ReadIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "WriteIOPS"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ReadLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "WriteLatency"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "DiskQueueDepth"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkReceiveThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkTransmitThroughput"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- ALB Metrics ---
prometheus.exporter.cloudwatch "alb" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/ApplicationELB"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "HTTPCode_Target_2XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_3XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_4XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HTTPCode_Target_5XX_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "RequestCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TargetResponseTime"
      statistics = ["Average", "p95", "p99"]
      period     = "60s"
    }
    metric {
      name       = "TargetConnectionErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- NLB Metrics ---
prometheus.exporter.cloudwatch "nlb" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/NetworkELB"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "ActiveFlowCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NewFlowCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ProcessedBytes"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "ConsumedLCUs"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "TCP_Target_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "Client_Reset_Count"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "TLSNegotiationErrorCount"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "HealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "UnHealthyHostCount"
      statistics = ["Average"]
      period     = "60s"
    }
  }
}

// --- ElastiCache Metrics ---
prometheus.exporter.cloudwatch "elasticache" {
  sts_region = "ap-southeast-1"
  discovery {
    type    = "AWS/ElastiCache"
    regions = ["ap-southeast-1"]

    role {
      role_arn    = "arn:aws:iam::976193250298:role/ftt-lgtm-assumerole-rag"
    }
    metric {
      name       = "CPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "EngineCPUUtilization"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "CurrConnections"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "FreeableMemory"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "BytesUsedForCache"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "Evictions"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "SwapUsage"
      statistics = ["Average"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesIn"
      statistics = ["Sum"]
      period     = "60s"
    }
    metric {
      name       = "NetworkBytesOut"
      statistics = ["Sum"]
      period     = "60s"
    }
  }
}

// ------------------------------------------------------------
// 2) Scrape & Remote Write to Mimir
// ------------------------------------------------------------
prometheus.scrape "metrics" {
  targets = concat(
    prometheus.exporter.cloudwatch.rds.targets,
    prometheus.exporter.cloudwatch.alb.targets,
    prometheus.exporter.cloudwatch.nlb.targets,
    prometheus.exporter.cloudwatch.elasticache.targets,
  )
  forward_to = [prometheus.remote_write.mimir.receiver]
}

prometheus.remote_write "mimir" {
  endpoint {
    url = "http://ftt-mimir:8080/api/v1/push"
    headers = {
      "X-Scope-OrgID" = "aws-rag-sin-cw",
    }
  }
}

// ------------------------------------------------------------
// 3) RDS Logs (Lambda -> Alloy -> Loki)
// ------------------------------------------------------------
// /etc/alloy/config.d/rds-pass.alloy

loki.source.api "lambda_receiver" {
  http {
    listen_address = "0.0.0.0"
    listen_port    = 9080
  }
  // 라벨 가공 없이 바로 Loki로
  forward_to = [loki.write.rds_out.receiver]
}

loki.write "rds_out" {
  endpoint {
    url       = "http://ftt-loki:3100/loki/api/v1/push"
    tenant_id = "aws-rag-sin-cw"   // ← Grafana 데이터소스/Explore의 Tenant와 일치
  }
}
