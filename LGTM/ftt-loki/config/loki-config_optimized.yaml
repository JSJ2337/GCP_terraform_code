########################
# Global / Server
########################
auth_enabled: true            # 멀티테넌트 활성

server:
  http_listen_port: 3100      # HTTP API 포트
  grpc_listen_port: 9095      # gRPC 포트 (성능 향상)
  log_level: info
  # 8코어 16GB 환경에 최적화된 동시성 설정
  http_server_read_timeout: 30s
  http_server_write_timeout: 30s

########################
# Common (ring & dirs)
########################
common:
  path_prefix: /ftt-loki
  replication_factor: 1       # 단일 인스턴스
  ring:
    kvstore:
      store: inmemory
    instance_port: 9095
    instance_addr: 127.0.0.1

########################
# Schema (TSDB + S3)
########################
schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: s3
      schema: v13
      index:
        prefix: loki_index_
        period: 24h

########################
# Storage (최적화된 S3 설정)
########################
storage_config:
  object_store:
    s3:
      endpoint: s3.ap-northeast-2.amazonaws.com
      bucket_name: ${LOKI_S3_BUCKET}
      region: ${AWS_REGION}
      bucket_lookup_type: path
      # 성능 최적화 설정
      s3forcepathstyle: false
      insecure: false
      http_config:
        idle_conn_timeout: 90s
        response_header_timeout: 30s
        insecure_skip_verify: false
      
  tsdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/index_cache
    cache_ttl: 24h
    # 16GB 메모리 환경에 맞춘 캐시 설정
    index_gateway_client:
      server_address: dns:///127.0.0.1:9095

########################
# Compactor & Retention (비용 최적화)
########################
compactor:
  working_directory: /loki/compactor
  compaction_interval: 5m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 50
  delete_request_store: s3
  # 16GB 메모리에 적합한 압축 설정
  max_compaction_parallelism: 4

########################
# Table Manager (보존 정책)
########################
table_manager:
  retention_deletes_enabled: true
  retention_period: 8760h     # 1년(365일) 보존

########################
# Limits Config (8코어 16GB 최적화)
########################
limits_config:
  # 처리량 설정 (16GB 메모리 기준)
  ingestion_rate_mb: 25
  ingestion_burst_size_mb: 50
  max_global_streams_per_user: 20000
  max_streams_per_user: 10000
  
  # 쿼리 성능 최적화
  max_cache_freshness_per_query: 10m
  split_queries_by_interval: 15m
  max_query_parallelism: 8    # 8코어 활용
  max_query_length: 24h
  max_query_series: 500
  
  # 스트림 레이트 제한
  per_stream_rate_limit: 3MB
  per_stream_rate_limit_burst: 15MB
  
  # 메모리 보호 설정
  max_concurrent_tail_requests: 100
  max_outstanding_requests_per_tenant: 100
  
  # 샘플 정책
  reject_old_samples: true
  reject_old_samples_max_age: 8760h   # 1년 (보존 기간과 동일)
  creation_grace_period: 10m
  
  # 메타데이터 제한
  max_label_name_length: 1024
  max_label_value_length: 4096
  max_label_names_per_series: 30
  
  # 압축 설정
  unordered_writes: true
  use_bloom_filters: true
  
  # 구조화된 메타데이터 지원 (Loki 3.0+)
  allow_structured_metadata: true
  max_structured_metadata_size: 64KB
  max_structured_metadata_entries_per_log_line: 128
  
  # Bloom Filters 쿼리 가속화
  bloom_gateway_enabled: true

########################
# Ingester (WAL 및 성능 최적화)
########################
ingester:
  # 8코어에 최적화된 동시성
  concurrent_flushes: 8
  
  # 16GB 메모리 환경에 맞는 청크 설정
  chunk_target_size: 1572864      # 1.5MB
  chunk_encoding: snappy          # 압축/속도 균형
  
  # WAL (Write-Ahead Log) - 데이터 안정성 보장
  wal:
    enabled: true
    dir: /loki/wal
    checkpoint_duration: 5m
    flush_on_shutdown: true
    replay_memory_ceiling: 2GB    # 16GB의 12.5%
  
  # 라이프사이클 관리
  lifecycler:
    ring:
      kvstore:
        store: inmemory
    heartbeat_period: 5s
    join_after: 30s
    observe_period: 10s
    final_sleep: 30s
  
  # 청크 수명 관리
  max_chunk_age: 2h
  chunk_idle_period: 30m
  flush_check_period: 30s
  flush_op_timeout: 10m

########################
# Chunk Store (Memcached 캐싱)
########################
chunk_store_config:
  # 청크 캐시 - Memcached 사용
  chunk_cache_config:
    memcached:
      addresses: "ftt-loki-memcache:11211"
      timeout: 100ms
      max_idle_conns: 16
      update_interval: 1m
      consistent_hash: true
  
  # Write dedupe 캐시
  write_dedupe_cache_config:
    memcached:
      addresses: "ftt-loki-memcache:11211"
      timeout: 100ms
      max_idle_conns: 16
      update_interval: 1m
      consistent_hash: true
  
  # 룩백 최적화
  max_look_back_period: 168h      # 7일

########################
# Bloom Filters (쿼리 가속화)
########################
bloom_build:
  enabled: true
  
bloom_gateway:
  enabled: true
  ring:
    kvstore:
      store: inmemory

########################
# Query Frontend (성능 최적화)
########################
frontend:
  max_outstanding_per_tenant: 100
  compress_responses: true
  log_queries_longer_than: 10s
  # 16GB 메모리 환경 최적화
  downstream_url: http://127.0.0.1:3100

query_range:
  # 쿼리 캐싱 (Memcached 기반)
  cache_results: true
  max_retries: 5
  # 쿼리 분할로 성능 향상
  split_queries_by_interval: 15m
  align_queries_with_step: true
  cache_index_stats_results: true
  
  # 결과 캐시 설정 (Memcached 사용)
  results_cache:
    cache:
      memcached:
        addresses: "ftt-loki-memcache:11211"
        timeout: 100ms
        max_idle_conns: 16
        update_interval: 1m
        consistent_hash: true
        ttl: 1h

########################
# Query Scheduler
########################
query_scheduler:
  max_outstanding_requests_per_tenant: 100
  grpc_client_config:
    max_recv_msg_size: 104857600   # 100MB

########################
# Querier (8코어 활용)
########################
querier:
  multi_tenant_queries_enabled: true
  max_concurrent: 8              # 8코어 활용
  timeout: 1m
  # 병렬 처리 최적화
  engine:
    max_look_back_period: 30s

########################
# Index Gateway (메모리 최적화)
########################
index_gateway:
  mode: simple
  # 16GB 메모리에 적합한 인덱스 캐시
  bloom_gateway_client:
    cache_results: true

########################
# Analytics & Monitoring
########################
analytics:
  reporting_enabled: false

########################
# Operational Settings
########################
operational:
  # 로그 레벨 및 형식
  log_config:
    log_level: info
    log_format: json
  
  # 트레이싱 (선택사항)
  tracing:
    enabled: false

########################
# Memberlist (단일 인스턴스)
########################
memberlist:
  node_name: loki-single
  bind_port: 7946
  # 단일 노드 설정
  join_members: []